(function(){"use strict";const we=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function Qe(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function Er(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function Ht(n,...t){if(!Qe(n))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(n.length))throw new Error("Uint8Array expected of length "+t+", got length="+n.length)}function Rn(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Er(n.outputLen),Er(n.blockLen)}function Ye(n,t=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(t&&n.finished)throw new Error("Hash#digest() has already been called")}function Po(n,t){Ht(n);const e=t.outputLen;if(n.length<e)throw new Error("digestInto() expects output buffer of length at least "+e)}function te(...n){for(let t=0;t<n.length;t++)n[t].fill(0)}function ve(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function jt(n,t){return n<<32-t|n>>>t}function Xe(n,t){return n<<t|n>>>32-t>>>0}const Kn=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Uo=Array.from({length:256},(n,t)=>t.toString(16).padStart(2,"0"));function dt(n){if(Ht(n),Kn)return n.toHex();let t="";for(let e=0;e<n.length;e++)t+=Uo[n[e]];return t}const Vt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Dn(n){if(n>=Vt._0&&n<=Vt._9)return n-Vt._0;if(n>=Vt.A&&n<=Vt.F)return n-(Vt.A-10);if(n>=Vt.a&&n<=Vt.f)return n-(Vt.a-10)}function ut(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);if(Kn)return Uint8Array.fromHex(n);const t=n.length,e=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(e);for(let i=0,o=0;i<e;i++,o+=2){const l=Dn(n.charCodeAt(o)),c=Dn(n.charCodeAt(o+1));if(l===void 0||c===void 0){const y=n[o]+n[o+1];throw new Error('hex string expected, got non-hex character "'+y+'" at index '+o)}r[i]=l*16+c}return r}function Je(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function Mr(n){return typeof n=="string"&&(n=Je(n)),Ht(n),n}function Dt(...n){let t=0;for(let r=0;r<n.length;r++){const i=n[r];Ht(i),t+=i.length}const e=new Uint8Array(t);for(let r=0,i=0;r<n.length;r++){const o=n[r];e.set(o,i),i+=o.length}return e}class Ln{}function _r(n){const t=r=>n().update(Mr(r)).digest(),e=n();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>n(),t}function ce(n=32){if(we&&typeof we.getRandomValues=="function")return we.getRandomValues(new Uint8Array(n));if(we&&typeof we.randomBytes=="function")return Uint8Array.from(we.randomBytes(n));throw new Error("crypto.getRandomValues must be defined")}function Co(n,t,e,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(t,e,r);const i=BigInt(32),o=BigInt(4294967295),l=Number(e>>i&o),c=Number(e&o),y=r?4:0,M=r?0:4;n.setUint32(t+y,l,r),n.setUint32(t+M,c,r)}function qo(n,t,e){return n&t^~n&e}function Fo(n,t,e){return n&t^n&e^t&e}class Br extends Ln{constructor(t,e,r,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=t,this.outputLen=e,this.padOffset=r,this.isLE=i,this.buffer=new Uint8Array(t),this.view=ve(this.buffer)}update(t){Ye(this),t=Mr(t),Ht(t);const{view:e,buffer:r,blockLen:i}=this,o=t.length;for(let l=0;l<o;){const c=Math.min(i-this.pos,o-l);if(c===i){const y=ve(t);for(;i<=o-l;l+=i)this.process(y,l);continue}r.set(t.subarray(l,l+c),this.pos),this.pos+=c,l+=c,this.pos===i&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Ye(this),Po(t,this),this.finished=!0;const{buffer:e,view:r,blockLen:i,isLE:o}=this;let{pos:l}=this;e[l++]=128,te(this.buffer.subarray(l)),this.padOffset>i-l&&(this.process(r,0),l=0);for(let S=l;S<i;S++)e[S]=0;Co(r,i-8,BigInt(this.length*8),o),this.process(r,0);const c=ve(t),y=this.outputLen;if(y%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const M=y/4,A=this.get();if(M>A.length)throw new Error("_sha2: outputLen bigger than state");for(let S=0;S<M;S++)c.setUint32(4*S,A[S],o)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const r=t.slice(0,e);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:r,length:i,finished:o,destroyed:l,pos:c}=this;return t.destroyed=l,t.finished=o,t.length=i,t.pos=c,i%e&&t.buffer.set(r),t}clone(){return this._cloneInto()}}const ee=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Rt=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),tr=BigInt(2**32-1),Hn=BigInt(32);function Oo(n,t=!1){return t?{h:Number(n&tr),l:Number(n>>Hn&tr)}:{h:Number(n>>Hn&tr)|0,l:Number(n&tr)|0}}function No(n,t=!1){const e=n.length;let r=new Uint32Array(e),i=new Uint32Array(e);for(let o=0;o<e;o++){const{h:l,l:c}=Oo(n[o],t);[r[o],i[o]]=[l,c]}return[r,i]}const $n=(n,t,e)=>n>>>e,Wn=(n,t,e)=>n<<32-e|t>>>e,be=(n,t,e)=>n>>>e|t<<32-e,xe=(n,t,e)=>n<<32-e|t>>>e,er=(n,t,e)=>n<<64-e|t>>>e-32,rr=(n,t,e)=>n>>>e-32|t<<64-e;function Gt(n,t,e,r){const i=(t>>>0)+(r>>>0);return{h:n+e+(i/2**32|0)|0,l:i|0}}const Ro=(n,t,e)=>(n>>>0)+(t>>>0)+(e>>>0),Ko=(n,t,e,r)=>t+e+r+(n/2**32|0)|0,Do=(n,t,e,r)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0),Lo=(n,t,e,r,i)=>t+e+r+i+(n/2**32|0)|0,Ho=(n,t,e,r,i)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0)+(i>>>0),$o=(n,t,e,r,i,o)=>t+e+r+i+o+(n/2**32|0)|0,Wo=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),re=new Uint32Array(64);class zo extends Br{constructor(t=32){super(64,t,8,!1),this.A=ee[0]|0,this.B=ee[1]|0,this.C=ee[2]|0,this.D=ee[3]|0,this.E=ee[4]|0,this.F=ee[5]|0,this.G=ee[6]|0,this.H=ee[7]|0}get(){const{A:t,B:e,C:r,D:i,E:o,F:l,G:c,H:y}=this;return[t,e,r,i,o,l,c,y]}set(t,e,r,i,o,l,c,y){this.A=t|0,this.B=e|0,this.C=r|0,this.D=i|0,this.E=o|0,this.F=l|0,this.G=c|0,this.H=y|0}process(t,e){for(let S=0;S<16;S++,e+=4)re[S]=t.getUint32(e,!1);for(let S=16;S<64;S++){const B=re[S-15],_=re[S-2],P=jt(B,7)^jt(B,18)^B>>>3,T=jt(_,17)^jt(_,19)^_>>>10;re[S]=T+re[S-7]+P+re[S-16]|0}let{A:r,B:i,C:o,D:l,E:c,F:y,G:M,H:A}=this;for(let S=0;S<64;S++){const B=jt(c,6)^jt(c,11)^jt(c,25),_=A+B+qo(c,y,M)+Wo[S]+re[S]|0,T=(jt(r,2)^jt(r,13)^jt(r,22))+Fo(r,i,o)|0;A=M,M=y,y=c,c=l+_|0,l=o,o=i,i=r,r=_+T|0}r=r+this.A|0,i=i+this.B|0,o=o+this.C|0,l=l+this.D|0,c=c+this.E|0,y=y+this.F|0,M=M+this.G|0,A=A+this.H|0,this.set(r,i,o,l,c,y,M,A)}roundClean(){te(re)}destroy(){this.set(0,0,0,0,0,0,0,0),te(this.buffer)}}const zn=No(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),Zo=zn[0],jo=zn[1],ne=new Uint32Array(80),ie=new Uint32Array(80);class Vo extends Br{constructor(t=64){super(128,t,16,!1),this.Ah=Rt[0]|0,this.Al=Rt[1]|0,this.Bh=Rt[2]|0,this.Bl=Rt[3]|0,this.Ch=Rt[4]|0,this.Cl=Rt[5]|0,this.Dh=Rt[6]|0,this.Dl=Rt[7]|0,this.Eh=Rt[8]|0,this.El=Rt[9]|0,this.Fh=Rt[10]|0,this.Fl=Rt[11]|0,this.Gh=Rt[12]|0,this.Gl=Rt[13]|0,this.Hh=Rt[14]|0,this.Hl=Rt[15]|0}get(){const{Ah:t,Al:e,Bh:r,Bl:i,Ch:o,Cl:l,Dh:c,Dl:y,Eh:M,El:A,Fh:S,Fl:B,Gh:_,Gl:P,Hh:T,Hl:C}=this;return[t,e,r,i,o,l,c,y,M,A,S,B,_,P,T,C]}set(t,e,r,i,o,l,c,y,M,A,S,B,_,P,T,C){this.Ah=t|0,this.Al=e|0,this.Bh=r|0,this.Bl=i|0,this.Ch=o|0,this.Cl=l|0,this.Dh=c|0,this.Dl=y|0,this.Eh=M|0,this.El=A|0,this.Fh=S|0,this.Fl=B|0,this.Gh=_|0,this.Gl=P|0,this.Hh=T|0,this.Hl=C|0}process(t,e){for(let R=0;R<16;R++,e+=4)ne[R]=t.getUint32(e),ie[R]=t.getUint32(e+=4);for(let R=16;R<80;R++){const D=ne[R-15]|0,$=ie[R-15]|0,Q=be(D,$,1)^be(D,$,8)^$n(D,$,7),z=xe(D,$,1)^xe(D,$,8)^Wn(D,$,7),L=ne[R-2]|0,O=ie[R-2]|0,j=be(L,O,19)^er(L,O,61)^$n(L,O,6),E=xe(L,O,19)^rr(L,O,61)^Wn(L,O,6),s=Do(z,E,ie[R-7],ie[R-16]),h=Lo(s,Q,j,ne[R-7],ne[R-16]);ne[R]=h|0,ie[R]=s|0}let{Ah:r,Al:i,Bh:o,Bl:l,Ch:c,Cl:y,Dh:M,Dl:A,Eh:S,El:B,Fh:_,Fl:P,Gh:T,Gl:C,Hh:N,Hl:K}=this;for(let R=0;R<80;R++){const D=be(S,B,14)^be(S,B,18)^er(S,B,41),$=xe(S,B,14)^xe(S,B,18)^rr(S,B,41),Q=S&_^~S&T,z=B&P^~B&C,L=Ho(K,$,z,jo[R],ie[R]),O=$o(L,N,D,Q,Zo[R],ne[R]),j=L|0,E=be(r,i,28)^er(r,i,34)^er(r,i,39),s=xe(r,i,28)^rr(r,i,34)^rr(r,i,39),h=r&o^r&c^o&c,d=i&l^i&y^l&y;N=T|0,K=C|0,T=_|0,C=P|0,_=S|0,P=B|0,{h:S,l:B}=Gt(M|0,A|0,O|0,j|0),M=c|0,A=y|0,c=o|0,y=l|0,o=r|0,l=i|0;const p=Ro(j,s,d);r=Ko(p,O,E,h),i=p|0}({h:r,l:i}=Gt(this.Ah|0,this.Al|0,r|0,i|0)),{h:o,l}=Gt(this.Bh|0,this.Bl|0,o|0,l|0),{h:c,l:y}=Gt(this.Ch|0,this.Cl|0,c|0,y|0),{h:M,l:A}=Gt(this.Dh|0,this.Dl|0,M|0,A|0),{h:S,l:B}=Gt(this.Eh|0,this.El|0,S|0,B|0),{h:_,l:P}=Gt(this.Fh|0,this.Fl|0,_|0,P|0),{h:T,l:C}=Gt(this.Gh|0,this.Gl|0,T|0,C|0),{h:N,l:K}=Gt(this.Hh|0,this.Hl|0,N|0,K|0),this.set(r,i,o,l,c,y,M,A,S,B,_,P,T,C,N,K)}roundClean(){te(ne,ie)}destroy(){te(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const Ot=_r(()=>new zo),Zn=_r(()=>new Vo);class jn extends Ln{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,Rn(t);const r=Mr(e);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,o=new Uint8Array(i);o.set(r.length>i?t.create().update(r).digest():r);for(let l=0;l<o.length;l++)o[l]^=54;this.iHash.update(o),this.oHash=t.create();for(let l=0;l<o.length;l++)o[l]^=106;this.oHash.update(o),te(o)}update(t){return Ye(this),this.iHash.update(t),this}digestInto(t){Ye(this),Ht(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:r,finished:i,destroyed:o,blockLen:l,outputLen:c}=this;return t=t,t.finished=i,t.destroyed=o,t.blockLen=l,t.outputLen=c,t.oHash=e._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Oe=(n,t,e)=>new jn(n,t).update(e).digest();Oe.create=(n,t)=>new jn(n,t);const kr=BigInt(0),Ar=BigInt(1);function nr(n,t=""){if(typeof n!="boolean"){const e=t&&`"${t}"`;throw new Error(e+"expected boolean, got type="+typeof n)}return n}function fe(n,t,e=""){const r=Qe(n),i=n?.length,o=t!==void 0;if(!r||o&&i!==t){const l=e&&`"${e}" `,c=o?` of length ${t}`:"",y=r?`length=${i}`:`type=${typeof n}`;throw new Error(l+"expected Uint8Array"+c+", got "+y)}return n}function ir(n){const t=n.toString(16);return t.length&1?"0"+t:t}function Vn(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?kr:BigInt("0x"+n)}function Ee(n){return Vn(dt(n))}function Gn(n){return Ht(n),Vn(dt(Uint8Array.from(n).reverse()))}function or(n,t){return ut(n.toString(16).padStart(t*2,"0"))}function Qn(n,t){return or(n,t).reverse()}function Ft(n,t,e){let r;if(typeof t=="string")try{r=ut(t)}catch(o){throw new Error(n+" must be hex string or Uint8Array, cause: "+o)}else if(Qe(t))r=Uint8Array.from(t);else throw new Error(n+" must be hex string or Uint8Array");const i=r.length;if(typeof e=="number"&&i!==e)throw new Error(n+" of length "+e+" expected, got "+i);return r}const Ir=n=>typeof n=="bigint"&&kr<=n;function Sr(n,t,e){return Ir(n)&&Ir(t)&&Ir(e)&&t<=n&&n<e}function Go(n,t,e,r){if(!Sr(t,e,r))throw new Error("expected valid "+n+": "+e+" <= n < "+r+", got "+t)}function Yn(n){let t;for(t=0;n>kr;n>>=Ar,t+=1);return t}const Ne=n=>(Ar<<BigInt(n))-Ar;function Qo(n,t,e){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof e!="function")throw new Error("hmacFn must be a function");const r=_=>new Uint8Array(_),i=_=>Uint8Array.of(_);let o=r(n),l=r(n),c=0;const y=()=>{o.fill(1),l.fill(0),c=0},M=(..._)=>e(l,o,..._),A=(_=r(0))=>{l=M(i(0),_),o=M(),_.length!==0&&(l=M(i(1),_),o=M())},S=()=>{if(c++>=1e3)throw new Error("drbg: tried 1000 values");let _=0;const P=[];for(;_<t;){o=M();const T=o.slice();P.push(T),_+=o.length}return Dt(...P)};return(_,P)=>{y(),A(_);let T;for(;!(T=P(S()));)A();return y(),T}}function Tr(n,t,e={}){if(!n||typeof n!="object")throw new Error("expected valid options object");function r(i,o,l){const c=n[i];if(l&&c===void 0)return;const y=typeof c;if(y!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${y}`)}Object.entries(t).forEach(([i,o])=>r(i,o,!1)),Object.entries(e).forEach(([i,o])=>r(i,o,!0))}function Xn(n){const t=new WeakMap;return(e,...r)=>{const i=t.get(e);if(i!==void 0)return i;const o=n(e,...r);return t.set(e,o),o}}const Lt=BigInt(0),Kt=BigInt(1),le=BigInt(2),Jn=BigInt(3),ti=BigInt(4),ei=BigInt(5),Yo=BigInt(7),ri=BigInt(8),Xo=BigInt(9),ni=BigInt(16);function $t(n,t){const e=n%t;return e>=Lt?e:t+e}function Wt(n,t,e){let r=n;for(;t-- >Lt;)r*=r,r%=e;return r}function ii(n,t){if(n===Lt)throw new Error("invert: expected non-zero number");if(t<=Lt)throw new Error("invert: expected positive modulus, got "+t);let e=$t(n,t),r=t,i=Lt,o=Kt;for(;e!==Lt;){const c=r/e,y=r%e,M=i-o*c;r=e,e=y,i=o,o=M}if(r!==Kt)throw new Error("invert: does not exist");return $t(i,t)}function Pr(n,t,e){if(!n.eql(n.sqr(t),e))throw new Error("Cannot find square root")}function oi(n,t){const e=(n.ORDER+Kt)/ti,r=n.pow(t,e);return Pr(n,r,t),r}function Jo(n,t){const e=(n.ORDER-ei)/ri,r=n.mul(t,le),i=n.pow(r,e),o=n.mul(t,i),l=n.mul(n.mul(o,le),i),c=n.mul(o,n.sub(l,n.ONE));return Pr(n,c,t),c}function ts(n){const t=Re(n),e=si(n),r=e(t,t.neg(t.ONE)),i=e(t,r),o=e(t,t.neg(r)),l=(n+Yo)/ni;return(c,y)=>{let M=c.pow(y,l),A=c.mul(M,r);const S=c.mul(M,i),B=c.mul(M,o),_=c.eql(c.sqr(A),y),P=c.eql(c.sqr(S),y);M=c.cmov(M,A,_),A=c.cmov(B,S,P);const T=c.eql(c.sqr(A),y),C=c.cmov(M,A,T);return Pr(c,C,y),C}}function si(n){if(n<Jn)throw new Error("sqrt is not defined for small field");let t=n-Kt,e=0;for(;t%le===Lt;)t/=le,e++;let r=le;const i=Re(n);for(;ui(i,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(e===1)return oi;let o=i.pow(r,t);const l=(t+Kt)/le;return function(y,M){if(y.is0(M))return M;if(ui(y,M)!==1)throw new Error("Cannot find square root");let A=e,S=y.mul(y.ONE,o),B=y.pow(M,t),_=y.pow(M,l);for(;!y.eql(B,y.ONE);){if(y.is0(B))return y.ZERO;let P=1,T=y.sqr(B);for(;!y.eql(T,y.ONE);)if(P++,T=y.sqr(T),P===A)throw new Error("Cannot find square root");const C=Kt<<BigInt(A-P-1),N=y.pow(S,C);A=P,S=y.sqr(N),B=y.mul(B,S),_=y.mul(_,N)}return _}}function es(n){return n%ti===Jn?oi:n%ri===ei?Jo:n%ni===Xo?ts(n):si(n)}const rs=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function ns(n){const t={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},e=rs.reduce((r,i)=>(r[i]="function",r),t);return Tr(n,e),n}function is(n,t,e){if(e<Lt)throw new Error("invalid exponent, negatives unsupported");if(e===Lt)return n.ONE;if(e===Kt)return t;let r=n.ONE,i=t;for(;e>Lt;)e&Kt&&(r=n.mul(r,i)),i=n.sqr(i),e>>=Kt;return r}function ai(n,t,e=!1){const r=new Array(t.length).fill(e?n.ZERO:void 0),i=t.reduce((l,c,y)=>n.is0(c)?l:(r[y]=l,n.mul(l,c)),n.ONE),o=n.inv(i);return t.reduceRight((l,c,y)=>n.is0(c)?l:(r[y]=n.mul(l,r[y]),n.mul(l,c)),o),r}function ui(n,t){const e=(n.ORDER-Kt)/le,r=n.pow(t,e),i=n.eql(r,n.ONE),o=n.eql(r,n.ZERO),l=n.eql(r,n.neg(n.ONE));if(!i&&!o&&!l)throw new Error("invalid Legendre symbol result");return i?1:o?0:-1}function hi(n,t){t!==void 0&&Er(t);const e=t!==void 0?t:n.toString(2).length,r=Math.ceil(e/8);return{nBitLength:e,nByteLength:r}}function Re(n,t,e=!1,r={}){if(n<=Lt)throw new Error("invalid field: expected ORDER > 0, got "+n);let i,o,l=!1,c;if(typeof t=="object"&&t!=null){if(r.sqrt||e)throw new Error("cannot specify opts in two arguments");const B=t;B.BITS&&(i=B.BITS),B.sqrt&&(o=B.sqrt),typeof B.isLE=="boolean"&&(e=B.isLE),typeof B.modFromBytes=="boolean"&&(l=B.modFromBytes),c=B.allowedLengths}else typeof t=="number"&&(i=t),r.sqrt&&(o=r.sqrt);const{nBitLength:y,nByteLength:M}=hi(n,i);if(M>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let A;const S=Object.freeze({ORDER:n,isLE:e,BITS:y,BYTES:M,MASK:Ne(y),ZERO:Lt,ONE:Kt,allowedLengths:c,create:B=>$t(B,n),isValid:B=>{if(typeof B!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof B);return Lt<=B&&B<n},is0:B=>B===Lt,isValidNot0:B=>!S.is0(B)&&S.isValid(B),isOdd:B=>(B&Kt)===Kt,neg:B=>$t(-B,n),eql:(B,_)=>B===_,sqr:B=>$t(B*B,n),add:(B,_)=>$t(B+_,n),sub:(B,_)=>$t(B-_,n),mul:(B,_)=>$t(B*_,n),pow:(B,_)=>is(S,B,_),div:(B,_)=>$t(B*ii(_,n),n),sqrN:B=>B*B,addN:(B,_)=>B+_,subN:(B,_)=>B-_,mulN:(B,_)=>B*_,inv:B=>ii(B,n),sqrt:o||(B=>(A||(A=es(n)),A(S,B))),toBytes:B=>e?Qn(B,M):or(B,M),fromBytes:(B,_=!0)=>{if(c){if(!c.includes(B.length)||B.length>M)throw new Error("Field.fromBytes: expected "+c+" bytes, got "+B.length);const T=new Uint8Array(M);T.set(B,e?0:T.length-B.length),B=T}if(B.length!==M)throw new Error("Field.fromBytes: expected "+M+" bytes, got "+B.length);let P=e?Gn(B):Ee(B);if(l&&(P=$t(P,n)),!_&&!S.isValid(P))throw new Error("invalid field element: outside of range 0..ORDER");return P},invertBatch:B=>ai(S,B),cmov:(B,_,P)=>P?_:B});return Object.freeze(S)}function ci(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const t=n.toString(2).length;return Math.ceil(t/8)}function fi(n){const t=ci(n);return t+Math.ceil(t/2)}function li(n,t,e=!1){const r=n.length,i=ci(t),o=fi(t);if(r<16||r<o||r>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+r);const l=e?Gn(n):Ee(n),c=$t(l,t-Kt)+Kt;return e?Qn(c,i):or(c,i)}const Me=BigInt(0),de=BigInt(1);function sr(n,t){const e=t.negate();return n?e:t}function Ur(n,t){const e=ai(n.Fp,t.map(r=>r.Z));return t.map((r,i)=>n.fromAffine(r.toAffine(e[i])))}function di(n,t){if(!Number.isSafeInteger(n)||n<=0||n>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+n)}function Cr(n,t){di(n,t);const e=Math.ceil(t/n)+1,r=2**(n-1),i=2**n,o=Ne(n),l=BigInt(n);return{windows:e,windowSize:r,mask:o,maxNumber:i,shiftBy:l}}function pi(n,t,e){const{windowSize:r,mask:i,maxNumber:o,shiftBy:l}=e;let c=Number(n&i),y=n>>l;c>r&&(c-=o,y+=de);const M=t*r,A=M+Math.abs(c)-1,S=c===0,B=c<0,_=t%2!==0;return{nextN:y,offset:A,isZero:S,isNeg:B,isNegF:_,offsetF:M}}function os(n,t){if(!Array.isArray(n))throw new Error("array expected");n.forEach((e,r)=>{if(!(e instanceof t))throw new Error("invalid point at index "+r)})}function ss(n,t){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((e,r)=>{if(!t.isValid(e))throw new Error("invalid scalar at index "+r)})}const qr=new WeakMap,mi=new WeakMap;function Fr(n){return mi.get(n)||1}function gi(n){if(n!==Me)throw new Error("invalid wNAF")}class as{constructor(t,e){this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=e}_unsafeLadder(t,e,r=this.ZERO){let i=t;for(;e>Me;)e&de&&(r=r.add(i)),i=i.double(),e>>=de;return r}precomputeWindow(t,e){const{windows:r,windowSize:i}=Cr(e,this.bits),o=[];let l=t,c=l;for(let y=0;y<r;y++){c=l,o.push(c);for(let M=1;M<i;M++)c=c.add(l),o.push(c);l=c.double()}return o}wNAF(t,e,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let i=this.ZERO,o=this.BASE;const l=Cr(t,this.bits);for(let c=0;c<l.windows;c++){const{nextN:y,offset:M,isZero:A,isNeg:S,isNegF:B,offsetF:_}=pi(r,c,l);r=y,A?o=o.add(sr(B,e[_])):i=i.add(sr(S,e[M]))}return gi(r),{p:i,f:o}}wNAFUnsafe(t,e,r,i=this.ZERO){const o=Cr(t,this.bits);for(let l=0;l<o.windows&&r!==Me;l++){const{nextN:c,offset:y,isZero:M,isNeg:A}=pi(r,l,o);if(r=c,!M){const S=e[y];i=i.add(A?S.negate():S)}}return gi(r),i}getPrecomputes(t,e,r){let i=qr.get(e);return i||(i=this.precomputeWindow(e,t),t!==1&&(typeof r=="function"&&(i=r(i)),qr.set(e,i))),i}cached(t,e,r){const i=Fr(t);return this.wNAF(i,this.getPrecomputes(i,t,r),e)}unsafe(t,e,r,i){const o=Fr(t);return o===1?this._unsafeLadder(t,e,i):this.wNAFUnsafe(o,this.getPrecomputes(o,t,r),e,i)}createCache(t,e){di(e,this.bits),mi.set(t,e),qr.delete(t)}hasCache(t){return Fr(t)!==1}}function us(n,t,e,r){let i=t,o=n.ZERO,l=n.ZERO;for(;e>Me||r>Me;)e&de&&(o=o.add(i)),r&de&&(l=l.add(i)),i=i.double(),e>>=de,r>>=de;return{p1:o,p2:l}}function hs(n,t,e,r){os(e,n),ss(r,t);const i=e.length,o=r.length;if(i!==o)throw new Error("arrays of points and scalars must have equal length");const l=n.ZERO,c=Yn(BigInt(i));let y=1;c>12?y=c-3:c>4?y=c-2:c>0&&(y=2);const M=Ne(y),A=new Array(Number(M)+1).fill(l),S=Math.floor((t.BITS-1)/y)*y;let B=l;for(let _=S;_>=0;_-=y){A.fill(l);for(let T=0;T<o;T++){const C=r[T],N=Number(C>>BigInt(_)&M);A[N]=A[N].add(e[T])}let P=l;for(let T=A.length-1,C=l;T>0;T--)C=C.add(A[T]),P=P.add(C);if(B=B.add(P),_!==0)for(let T=0;T<y;T++)B=B.double()}return B}function yi(n,t,e){if(t){if(t.ORDER!==n)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return ns(t),t}else return Re(n,{isLE:e})}function cs(n,t,e={},r){if(r===void 0&&(r=n==="edwards"),!t||typeof t!="object")throw new Error(`expected valid ${n} CURVE object`);for(const y of["p","n","h"]){const M=t[y];if(!(typeof M=="bigint"&&M>Me))throw new Error(`CURVE.${y} must be positive bigint`)}const i=yi(t.p,e.Fp,r),o=yi(t.n,e.Fn,r),c=["Gx","Gy","a","b"];for(const y of c)if(!i.isValid(t[y]))throw new Error(`CURVE.${y} must be valid field element of CURVE.Fp`);return t=Object.freeze(Object.assign({},t)),{CURVE:t,Fp:i,Fn:o}}const wi=(n,t)=>(n+(n>=0?t:-t)/vi)/t;function fs(n,t,e){const[[r,i],[o,l]]=t,c=wi(l*n,e),y=wi(-i*n,e);let M=n-c*r-y*o,A=-c*i-y*l;const S=M<Yt,B=A<Yt;S&&(M=-M),B&&(A=-A);const _=Ne(Math.ceil(Yn(e)/2))+_e;if(M<Yt||M>=_||A<Yt||A>=_)throw new Error("splitScalar (endomorphism): failed, k="+n);return{k1neg:S,k1:M,k2neg:B,k2:A}}function Or(n){if(!["compact","recovered","der"].includes(n))throw new Error('Signature format must be "compact", "recovered", or "der"');return n}function Nr(n,t){const e={};for(let r of Object.keys(t))e[r]=n[r]===void 0?t[r]:n[r];return nr(e.lowS,"lowS"),nr(e.prehash,"prehash"),e.format!==void 0&&Or(e.format),e}class ls extends Error{constructor(t=""){super(t)}}const Qt={Err:ls,_tlv:{encode:(n,t)=>{const{Err:e}=Qt;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length&1)throw new e("tlv.encode: unpadded data");const r=t.length/2,i=ir(r);if(i.length/2&128)throw new e("tlv.encode: long form length too big");const o=r>127?ir(i.length/2|128):"";return ir(n)+o+i+t},decode(n,t){const{Err:e}=Qt;let r=0;if(n<0||n>256)throw new e("tlv.encode: wrong tag");if(t.length<2||t[r++]!==n)throw new e("tlv.decode: wrong tlv");const i=t[r++],o=!!(i&128);let l=0;if(!o)l=i;else{const y=i&127;if(!y)throw new e("tlv.decode(long): indefinite length not supported");if(y>4)throw new e("tlv.decode(long): byte length is too big");const M=t.subarray(r,r+y);if(M.length!==y)throw new e("tlv.decode: length bytes not complete");if(M[0]===0)throw new e("tlv.decode(long): zero leftmost byte");for(const A of M)l=l<<8|A;if(r+=y,l<128)throw new e("tlv.decode(long): not minimal encoding")}const c=t.subarray(r,r+l);if(c.length!==l)throw new e("tlv.decode: wrong value length");return{v:c,l:t.subarray(r+l)}}},_int:{encode(n){const{Err:t}=Qt;if(n<Yt)throw new t("integer: negative integers are not allowed");let e=ir(n);if(Number.parseInt(e[0],16)&8&&(e="00"+e),e.length&1)throw new t("unexpected DER parsing assertion: unpadded hex");return e},decode(n){const{Err:t}=Qt;if(n[0]&128)throw new t("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new t("invalid signature integer: unnecessary leading zero");return Ee(n)}},toSig(n){const{Err:t,_int:e,_tlv:r}=Qt,i=Ft("signature",n),{v:o,l}=r.decode(48,i);if(l.length)throw new t("invalid signature: left bytes after parsing");const{v:c,l:y}=r.decode(2,o),{v:M,l:A}=r.decode(2,y);if(A.length)throw new t("invalid signature: left bytes after parsing");return{r:e.decode(c),s:e.decode(M)}},hexFromSig(n){const{_tlv:t,_int:e}=Qt,r=t.encode(2,e.encode(n.r)),i=t.encode(2,e.encode(n.s)),o=r+i;return t.encode(48,o)}},Yt=BigInt(0),_e=BigInt(1),vi=BigInt(2),ar=BigInt(3),ds=BigInt(4);function pe(n,t){const{BYTES:e}=n;let r;if(typeof t=="bigint")r=t;else{let i=Ft("private key",t);try{r=n.fromBytes(i)}catch{throw new Error(`invalid private key: expected ui8a of size ${e}, got ${typeof t}`)}}if(!n.isValidNot0(r))throw new Error("invalid private key: out of range [1..N-1]");return r}function ps(n,t={}){const e=cs("weierstrass",n,t),{Fp:r,Fn:i}=e;let o=e.CURVE;const{h:l,n:c}=o;Tr(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:y}=t;if(y&&(!r.is0(o.a)||typeof y.beta!="bigint"||!Array.isArray(y.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const M=xi(r,i);function A(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function S(s,h,d){const{x:p,y:g}=h.toAffine(),x=r.toBytes(p);if(nr(d,"isCompressed"),d){A();const k=!r.isOdd(g);return Dt(bi(k),x)}else return Dt(Uint8Array.of(4),x,r.toBytes(g))}function B(s){fe(s,void 0,"Point");const{publicKey:h,publicKeyUncompressed:d}=M,p=s.length,g=s[0],x=s.subarray(1);if(p===h&&(g===2||g===3)){const k=r.fromBytes(x);if(!r.isValid(k))throw new Error("bad point: is not on curve, wrong x");const w=T(k);let u;try{u=r.sqrt(w)}catch(H){const W=H instanceof Error?": "+H.message:"";throw new Error("bad point: is not on curve, sqrt error"+W)}A();const v=r.isOdd(u);return(g&1)===1!==v&&(u=r.neg(u)),{x:k,y:u}}else if(p===d&&g===4){const k=r.BYTES,w=r.fromBytes(x.subarray(0,k)),u=r.fromBytes(x.subarray(k,k*2));if(!C(w,u))throw new Error("bad point: is not on curve");return{x:w,y:u}}else throw new Error(`bad point: got length ${p}, expected compressed=${h} or uncompressed=${d}`)}const _=t.toBytes||S,P=t.fromBytes||B;function T(s){const h=r.sqr(s),d=r.mul(h,s);return r.add(r.add(d,r.mul(s,o.a)),o.b)}function C(s,h){const d=r.sqr(h),p=T(s);return r.eql(d,p)}if(!C(o.Gx,o.Gy))throw new Error("bad curve params: generator point");const N=r.mul(r.pow(o.a,ar),ds),K=r.mul(r.sqr(o.b),BigInt(27));if(r.is0(r.add(N,K)))throw new Error("bad curve params: a or b");function R(s,h,d=!1){if(!r.isValid(h)||d&&r.is0(h))throw new Error(`bad point coordinate ${s}`);return h}function D(s){if(!(s instanceof O))throw new Error("ProjectivePoint expected")}function $(s){if(!y||!y.basises)throw new Error("no endo");return fs(s,y.basises,i.ORDER)}const Q=Xn((s,h)=>{const{X:d,Y:p,Z:g}=s;if(r.eql(g,r.ONE))return{x:d,y:p};const x=s.is0();h==null&&(h=x?r.ONE:r.inv(g));const k=r.mul(d,h),w=r.mul(p,h),u=r.mul(g,h);if(x)return{x:r.ZERO,y:r.ZERO};if(!r.eql(u,r.ONE))throw new Error("invZ was invalid");return{x:k,y:w}}),z=Xn(s=>{if(s.is0()){if(t.allowInfinityPoint&&!r.is0(s.Y))return;throw new Error("bad point: ZERO")}const{x:h,y:d}=s.toAffine();if(!r.isValid(h)||!r.isValid(d))throw new Error("bad point: x or y not field elements");if(!C(h,d))throw new Error("bad point: equation left != right");if(!s.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function L(s,h,d,p,g){return d=new O(r.mul(d.X,s),d.Y,d.Z),h=sr(p,h),d=sr(g,d),h.add(d)}class O{constructor(h,d,p){this.X=R("x",h),this.Y=R("y",d,!0),this.Z=R("z",p),Object.freeze(this)}static CURVE(){return o}static fromAffine(h){const{x:d,y:p}=h||{};if(!h||!r.isValid(d)||!r.isValid(p))throw new Error("invalid affine point");if(h instanceof O)throw new Error("projective point not allowed");return r.is0(d)&&r.is0(p)?O.ZERO:new O(d,p,r.ONE)}static fromBytes(h){const d=O.fromAffine(P(fe(h,void 0,"point")));return d.assertValidity(),d}static fromHex(h){return O.fromBytes(Ft("pointHex",h))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(h=8,d=!0){return E.createCache(this,h),d||this.multiply(ar),this}assertValidity(){z(this)}hasEvenY(){const{y:h}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(h)}equals(h){D(h);const{X:d,Y:p,Z:g}=this,{X:x,Y:k,Z:w}=h,u=r.eql(r.mul(d,w),r.mul(x,g)),v=r.eql(r.mul(p,w),r.mul(k,g));return u&&v}negate(){return new O(this.X,r.neg(this.Y),this.Z)}double(){const{a:h,b:d}=o,p=r.mul(d,ar),{X:g,Y:x,Z:k}=this;let w=r.ZERO,u=r.ZERO,v=r.ZERO,F=r.mul(g,g),H=r.mul(x,x),W=r.mul(k,k),Z=r.mul(g,x);return Z=r.add(Z,Z),v=r.mul(g,k),v=r.add(v,v),w=r.mul(h,v),u=r.mul(p,W),u=r.add(w,u),w=r.sub(H,u),u=r.add(H,u),u=r.mul(w,u),w=r.mul(Z,w),v=r.mul(p,v),W=r.mul(h,W),Z=r.sub(F,W),Z=r.mul(h,Z),Z=r.add(Z,v),v=r.add(F,F),F=r.add(v,F),F=r.add(F,W),F=r.mul(F,Z),u=r.add(u,F),W=r.mul(x,k),W=r.add(W,W),F=r.mul(W,Z),w=r.sub(w,F),v=r.mul(W,H),v=r.add(v,v),v=r.add(v,v),new O(w,u,v)}add(h){D(h);const{X:d,Y:p,Z:g}=this,{X:x,Y:k,Z:w}=h;let u=r.ZERO,v=r.ZERO,F=r.ZERO;const H=o.a,W=r.mul(o.b,ar);let Z=r.mul(d,x),G=r.mul(p,k),X=r.mul(g,w),it=r.add(d,p),Y=r.add(x,k);it=r.mul(it,Y),Y=r.add(Z,G),it=r.sub(it,Y),Y=r.add(d,g);let tt=r.add(x,w);return Y=r.mul(Y,tt),tt=r.add(Z,X),Y=r.sub(Y,tt),tt=r.add(p,g),u=r.add(k,w),tt=r.mul(tt,u),u=r.add(G,X),tt=r.sub(tt,u),F=r.mul(H,Y),u=r.mul(W,X),F=r.add(u,F),u=r.sub(G,F),F=r.add(G,F),v=r.mul(u,F),G=r.add(Z,Z),G=r.add(G,Z),X=r.mul(H,X),Y=r.mul(W,Y),G=r.add(G,X),X=r.sub(Z,X),X=r.mul(H,X),Y=r.add(Y,X),Z=r.mul(G,Y),v=r.add(v,Z),Z=r.mul(tt,Y),u=r.mul(it,u),u=r.sub(u,Z),Z=r.mul(it,G),F=r.mul(tt,F),F=r.add(F,Z),new O(u,v,F)}subtract(h){return this.add(h.negate())}is0(){return this.equals(O.ZERO)}multiply(h){const{endo:d}=t;if(!i.isValidNot0(h))throw new Error("invalid scalar: out of range");let p,g;const x=k=>E.cached(this,k,w=>Ur(O,w));if(d){const{k1neg:k,k1:w,k2neg:u,k2:v}=$(h),{p:F,f:H}=x(w),{p:W,f:Z}=x(v);g=H.add(Z),p=L(d.beta,F,W,k,u)}else{const{p:k,f:w}=x(h);p=k,g=w}return Ur(O,[p,g])[0]}multiplyUnsafe(h){const{endo:d}=t,p=this;if(!i.isValid(h))throw new Error("invalid scalar: out of range");if(h===Yt||p.is0())return O.ZERO;if(h===_e)return p;if(E.hasCache(this))return this.multiply(h);if(d){const{k1neg:g,k1:x,k2neg:k,k2:w}=$(h),{p1:u,p2:v}=us(O,p,x,w);return L(d.beta,u,v,g,k)}else return E.unsafe(p,h)}multiplyAndAddUnsafe(h,d,p){const g=this.multiplyUnsafe(d).add(h.multiplyUnsafe(p));return g.is0()?void 0:g}toAffine(h){return Q(this,h)}isTorsionFree(){const{isTorsionFree:h}=t;return l===_e?!0:h?h(O,this):E.unsafe(this,c).is0()}clearCofactor(){const{clearCofactor:h}=t;return l===_e?this:h?h(O,this):this.multiplyUnsafe(l)}isSmallOrder(){return this.multiplyUnsafe(l).is0()}toBytes(h=!0){return nr(h,"isCompressed"),this.assertValidity(),_(O,this,h)}toHex(h=!0){return dt(this.toBytes(h))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(h=!0){return this.toBytes(h)}_setWindowSize(h){this.precompute(h)}static normalizeZ(h){return Ur(O,h)}static msm(h,d){return hs(O,i,h,d)}static fromPrivateKey(h){return O.BASE.multiply(pe(i,h))}}O.BASE=new O(o.Gx,o.Gy,r.ONE),O.ZERO=new O(r.ZERO,r.ONE,r.ZERO),O.Fp=r,O.Fn=i;const j=i.BITS,E=new as(O,t.endo?Math.ceil(j/2):j);return O.BASE.precompute(8),O}function bi(n){return Uint8Array.of(n?2:3)}function xi(n,t){return{secretKey:t.BYTES,publicKey:1+n.BYTES,publicKeyUncompressed:1+2*n.BYTES,publicKeyHasPrefix:!0,signature:2*t.BYTES}}function ms(n,t={}){const{Fn:e}=n,r=t.randomBytes||ce,i=Object.assign(xi(n.Fp,e),{seed:fi(e.ORDER)});function o(_){try{return!!pe(e,_)}catch{return!1}}function l(_,P){const{publicKey:T,publicKeyUncompressed:C}=i;try{const N=_.length;return P===!0&&N!==T||P===!1&&N!==C?!1:!!n.fromBytes(_)}catch{return!1}}function c(_=r(i.seed)){return li(fe(_,i.seed,"seed"),e.ORDER)}function y(_,P=!0){return n.BASE.multiply(pe(e,_)).toBytes(P)}function M(_){const P=c(_);return{secretKey:P,publicKey:y(P)}}function A(_){if(typeof _=="bigint")return!1;if(_ instanceof n)return!0;const{secretKey:P,publicKey:T,publicKeyUncompressed:C}=i;if(e.allowedLengths||P===T)return;const N=Ft("key",_).length;return N===T||N===C}function S(_,P,T=!0){if(A(_)===!0)throw new Error("first arg must be private key");if(A(P)===!1)throw new Error("second arg must be public key");const C=pe(e,_);return n.fromHex(P).multiply(C).toBytes(T)}return Object.freeze({getPublicKey:y,getSharedSecret:S,keygen:M,Point:n,utils:{isValidSecretKey:o,isValidPublicKey:l,randomSecretKey:c,isValidPrivateKey:o,randomPrivateKey:c,normPrivateKeyToScalar:_=>pe(e,_),precompute(_=8,P=n.BASE){return P.precompute(_,!1)}},lengths:i})}function gs(n,t,e={}){Rn(t),Tr(e,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=e.randomBytes||ce,i=e.hmac||((d,...p)=>Oe(t,d,Dt(...p))),{Fp:o,Fn:l}=n,{ORDER:c,BITS:y}=l,{keygen:M,getPublicKey:A,getSharedSecret:S,utils:B,lengths:_}=ms(n,e),P={prehash:!1,lowS:typeof e.lowS=="boolean"?e.lowS:!1,format:void 0,extraEntropy:!1},T="compact";function C(d){const p=c>>_e;return d>p}function N(d,p){if(!l.isValidNot0(p))throw new Error(`invalid signature ${d}: out of range 1..Point.Fn.ORDER`);return p}function K(d,p){Or(p);const g=_.signature,x=p==="compact"?g:p==="recovered"?g+1:void 0;return fe(d,x,`${p} signature`)}class R{constructor(p,g,x){this.r=N("r",p),this.s=N("s",g),x!=null&&(this.recovery=x),Object.freeze(this)}static fromBytes(p,g=T){K(p,g);let x;if(g==="der"){const{r:v,s:F}=Qt.toSig(fe(p));return new R(v,F)}g==="recovered"&&(x=p[0],g="compact",p=p.subarray(1));const k=l.BYTES,w=p.subarray(0,k),u=p.subarray(k,k*2);return new R(l.fromBytes(w),l.fromBytes(u),x)}static fromHex(p,g){return this.fromBytes(ut(p),g)}addRecoveryBit(p){return new R(this.r,this.s,p)}recoverPublicKey(p){const g=o.ORDER,{r:x,s:k,recovery:w}=this;if(w==null||![0,1,2,3].includes(w))throw new Error("recovery id invalid");if(c*vi<g&&w>1)throw new Error("recovery id is ambiguous for h>1 curve");const v=w===2||w===3?x+c:x;if(!o.isValid(v))throw new Error("recovery id 2 or 3 invalid");const F=o.toBytes(v),H=n.fromBytes(Dt(bi((w&1)===0),F)),W=l.inv(v),Z=$(Ft("msgHash",p)),G=l.create(-Z*W),X=l.create(k*W),it=n.BASE.multiplyUnsafe(G).add(H.multiplyUnsafe(X));if(it.is0())throw new Error("point at infinify");return it.assertValidity(),it}hasHighS(){return C(this.s)}toBytes(p=T){if(Or(p),p==="der")return ut(Qt.hexFromSig(this));const g=l.toBytes(this.r),x=l.toBytes(this.s);if(p==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return Dt(Uint8Array.of(this.recovery),g,x)}return Dt(g,x)}toHex(p){return dt(this.toBytes(p))}assertValidity(){}static fromCompact(p){return R.fromBytes(Ft("sig",p),"compact")}static fromDER(p){return R.fromBytes(Ft("sig",p),"der")}normalizeS(){return this.hasHighS()?new R(this.r,l.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return dt(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return dt(this.toBytes("compact"))}}const D=e.bits2int||function(p){if(p.length>8192)throw new Error("input is too large");const g=Ee(p),x=p.length*8-y;return x>0?g>>BigInt(x):g},$=e.bits2int_modN||function(p){return l.create(D(p))},Q=Ne(y);function z(d){return Go("num < 2^"+y,d,Yt,Q),l.toBytes(d)}function L(d,p){return fe(d,void 0,"message"),p?fe(t(d),void 0,"prehashed message"):d}function O(d,p,g){if(["recovered","canonical"].some(G=>G in g))throw new Error("sign() legacy options not supported");const{lowS:x,prehash:k,extraEntropy:w}=Nr(g,P);d=L(d,k);const u=$(d),v=pe(l,p),F=[z(v),z(u)];if(w!=null&&w!==!1){const G=w===!0?r(_.secretKey):w;F.push(Ft("extraEntropy",G))}const H=Dt(...F),W=u;function Z(G){const X=D(G);if(!l.isValidNot0(X))return;const it=l.inv(X),Y=n.BASE.multiply(X).toAffine(),tt=l.create(Y.x);if(tt===Yt)return;const Jt=l.create(it*l.create(W+tt*v));if(Jt===Yt)return;let ct=(Y.x===tt?0:2)|Number(Y.y&_e),ot=Jt;return x&&C(Jt)&&(ot=l.neg(Jt),ct^=1),new R(tt,ot,ct)}return{seed:H,k2sig:Z}}function j(d,p,g={}){d=Ft("message",d);const{seed:x,k2sig:k}=O(d,p,g);return Qo(t.outputLen,l.BYTES,i)(x,k)}function E(d){let p;const g=typeof d=="string"||Qe(d),x=!g&&d!==null&&typeof d=="object"&&typeof d.r=="bigint"&&typeof d.s=="bigint";if(!g&&!x)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(x)p=new R(d.r,d.s);else if(g){try{p=R.fromBytes(Ft("sig",d),"der")}catch(k){if(!(k instanceof Qt.Err))throw k}if(!p)try{p=R.fromBytes(Ft("sig",d),"compact")}catch{return!1}}return p||!1}function s(d,p,g,x={}){const{lowS:k,prehash:w,format:u}=Nr(x,P);if(g=Ft("publicKey",g),p=L(Ft("message",p),w),"strict"in x)throw new Error("options.strict was renamed to lowS");const v=u===void 0?E(d):R.fromBytes(Ft("sig",d),u);if(v===!1)return!1;try{const F=n.fromBytes(g);if(k&&v.hasHighS())return!1;const{r:H,s:W}=v,Z=$(p),G=l.inv(W),X=l.create(Z*G),it=l.create(H*G),Y=n.BASE.multiplyUnsafe(X).add(F.multiplyUnsafe(it));return Y.is0()?!1:l.create(Y.x)===H}catch{return!1}}function h(d,p,g={}){const{prehash:x}=Nr(g,P);return p=L(p,x),R.fromBytes(d,"recovered").recoverPublicKey(p).toBytes()}return Object.freeze({keygen:M,getPublicKey:A,getSharedSecret:S,utils:B,lengths:_,Point:n,sign:j,verify:s,recoverPublicKey:h,Signature:R,hash:t})}function ys(n){const t={a:n.a,b:n.b,p:n.Fp.ORDER,n:n.n,h:n.h,Gx:n.Gx,Gy:n.Gy},e=n.Fp;let r=n.allowedPrivateKeyLengths?Array.from(new Set(n.allowedPrivateKeyLengths.map(l=>Math.ceil(l/2)))):void 0;const i=Re(t.n,{BITS:n.nBitLength,allowedLengths:r,modFromBytes:n.wrapPrivateKey}),o={Fp:e,Fn:i,allowInfinityPoint:n.allowInfinityPoint,endo:n.endo,isTorsionFree:n.isTorsionFree,clearCofactor:n.clearCofactor,fromBytes:n.fromBytes,toBytes:n.toBytes};return{CURVE:t,curveOpts:o}}function ws(n){const{CURVE:t,curveOpts:e}=ys(n),r={hmac:n.hmac,randomBytes:n.randomBytes,lowS:n.lowS,bits2int:n.bits2int,bits2int_modN:n.bits2int_modN};return{CURVE:t,curveOpts:e,hash:n.hash,ecdsaOpts:r}}function vs(n,t){const e=t.Point;return Object.assign({},t,{ProjectivePoint:e,CURVE:Object.assign({},n,hi(e.Fn.ORDER,e.Fn.BITS))})}function bs(n){const{CURVE:t,curveOpts:e,hash:r,ecdsaOpts:i}=ws(n),o=ps(t,e),l=gs(o,r,i);return vs(n,l)}function xs(n,t){const e=r=>bs({...n,hash:r});return{...e(t),create:e}}const Be={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Es={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Ms=BigInt(0),Ei=BigInt(1),Rr=BigInt(2);function _s(n){const t=Be.p,e=BigInt(3),r=BigInt(6),i=BigInt(11),o=BigInt(22),l=BigInt(23),c=BigInt(44),y=BigInt(88),M=n*n*n%t,A=M*M*n%t,S=Wt(A,e,t)*A%t,B=Wt(S,e,t)*A%t,_=Wt(B,Rr,t)*M%t,P=Wt(_,i,t)*_%t,T=Wt(P,o,t)*P%t,C=Wt(T,c,t)*T%t,N=Wt(C,y,t)*C%t,K=Wt(N,c,t)*T%t,R=Wt(K,e,t)*A%t,D=Wt(R,l,t)*P%t,$=Wt(D,r,t)*M%t,Q=Wt($,Rr,t);if(!ur.eql(ur.sqr(Q),n))throw new Error("Cannot find square root");return Q}const ur=Re(Be.p,{sqrt:_s}),rt=xs({...Be,Fp:ur,lowS:!0,endo:Es},Ot),Mi={};function hr(n,...t){let e=Mi[n];if(e===void 0){const r=Ot(Je(n));e=Dt(r,r),Mi[n]=e}return Ot(Dt(e,...t))}const Kr=n=>n.toBytes(!0).slice(1),ke=rt.Point,Dr=n=>n%Rr===Ms;function Lr(n){const{Fn:t,BASE:e}=ke,r=pe(t,n),i=e.multiply(r);return{scalar:Dr(i.y)?r:t.neg(r),bytes:Kr(i)}}function _i(n){const t=ur;if(!t.isValidNot0(n))throw new Error("invalid x: Fail if x â‰¥ p");const e=t.create(n*n),r=t.create(e*n+BigInt(7));let i=t.sqrt(r);Dr(i)||(i=t.neg(i));const o=ke.fromAffine({x:n,y:i});return o.assertValidity(),o}const Ke=Ee;function Bi(...n){return ke.Fn.create(Ke(hr("BIP0340/challenge",...n)))}function ki(n){return Lr(n).bytes}function Bs(n,t,e=ce(32)){const{Fn:r}=ke,i=Ft("message",n),{bytes:o,scalar:l}=Lr(t),c=Ft("auxRand",e,32),y=r.toBytes(l^Ke(hr("BIP0340/aux",c))),M=hr("BIP0340/nonce",y,o,i),{bytes:A,scalar:S}=Lr(M),B=Bi(A,o,i),_=new Uint8Array(64);if(_.set(A,0),_.set(r.toBytes(r.create(S+B*l)),32),!Ai(_,i,o))throw new Error("sign: Invalid signature produced");return _}function Ai(n,t,e){const{Fn:r,BASE:i}=ke,o=Ft("signature",n,64),l=Ft("message",t),c=Ft("publicKey",e,32);try{const y=_i(Ke(c)),M=Ke(o.subarray(0,32));if(!Sr(M,Ei,Be.p))return!1;const A=Ke(o.subarray(32,64));if(!Sr(A,Ei,Be.n))return!1;const S=Bi(r.toBytes(M),Kr(y),l),B=i.multiplyUnsafe(A).add(y.multiplyUnsafe(r.neg(S))),{x:_,y:P}=B.toAffine();return!(B.is0()||!Dr(P)||_!==M)}catch{return!1}}const cr=(()=>{const e=(i=ce(48))=>li(i,Be.n);rt.utils.randomSecretKey;function r(i){const o=e(i);return{secretKey:o,publicKey:ki(o)}}return{keygen:r,getPublicKey:ki,sign:Bs,verify:Ai,Point:ke,utils:{randomSecretKey:e,randomPrivateKey:e,taggedHash:hr,lift_x:_i,pointToBytes:Kr,numberToBytesBE:or,bytesToNumberBE:Ee,mod:$t},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:64,seed:48}}})(),ks=Uint8Array.from([7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8]),Ii=Uint8Array.from(new Array(16).fill(0).map((n,t)=>t)),As=Ii.map(n=>(9*n+5)%16),Si=(()=>{const e=[[Ii],[As]];for(let r=0;r<4;r++)for(let i of e)i.push(i[r].map(o=>ks[o]));return e})(),Ti=Si[0],Pi=Si[1],Ui=[[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8],[12,13,11,15,6,9,9,7,12,15,11,13,7,8,7,7],[13,15,14,11,7,7,6,8,13,14,13,12,5,5,6,9],[14,11,12,14,8,6,5,5,15,12,15,14,9,9,8,6],[15,12,13,13,9,5,8,6,14,11,12,11,8,6,5,5]].map(n=>Uint8Array.from(n)),Is=Ti.map((n,t)=>n.map(e=>Ui[t][e])),Ss=Pi.map((n,t)=>n.map(e=>Ui[t][e])),Ts=Uint32Array.from([0,1518500249,1859775393,2400959708,2840853838]),Ps=Uint32Array.from([1352829926,1548603684,1836072691,2053994217,0]);function Ci(n,t,e,r){return n===0?t^e^r:n===1?t&e|~t&r:n===2?(t|~e)^r:n===3?t&r|e&~r:t^(e|~r)}const fr=new Uint32Array(16);class Us extends Br{constructor(){super(64,20,8,!0),this.h0=1732584193,this.h1=-271733879,this.h2=-1732584194,this.h3=271733878,this.h4=-1009589776}get(){const{h0:t,h1:e,h2:r,h3:i,h4:o}=this;return[t,e,r,i,o]}set(t,e,r,i,o){this.h0=t|0,this.h1=e|0,this.h2=r|0,this.h3=i|0,this.h4=o|0}process(t,e){for(let _=0;_<16;_++,e+=4)fr[_]=t.getUint32(e,!0);let r=this.h0|0,i=r,o=this.h1|0,l=o,c=this.h2|0,y=c,M=this.h3|0,A=M,S=this.h4|0,B=S;for(let _=0;_<5;_++){const P=4-_,T=Ts[_],C=Ps[_],N=Ti[_],K=Pi[_],R=Is[_],D=Ss[_];for(let $=0;$<16;$++){const Q=Xe(r+Ci(_,o,c,M)+fr[N[$]]+T,R[$])+S|0;r=S,S=M,M=Xe(c,10)|0,c=o,o=Q}for(let $=0;$<16;$++){const Q=Xe(i+Ci(P,l,y,A)+fr[K[$]]+C,D[$])+B|0;i=B,B=A,A=Xe(y,10)|0,y=l,l=Q}}this.set(this.h1+c+A|0,this.h2+M+B|0,this.h3+S+i|0,this.h4+r+l|0,this.h0+o+y|0)}roundClean(){te(fr)}destroy(){this.destroyed=!0,te(this.buffer),this.set(0,0,0,0,0)}}const Cs=_r(()=>new Us);function Hr(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function qi(n,t){return Array.isArray(t)?t.length===0?!0:n?t.every(e=>typeof e=="string"):t.every(e=>Number.isSafeInteger(e)):!1}function qs(n){if(typeof n!="function")throw new Error("function expected");return!0}function $r(n,t){if(typeof t!="string")throw new Error(`${n}: string expected`);return!0}function Wr(n){if(!Number.isSafeInteger(n))throw new Error(`invalid integer: ${n}`)}function zr(n){if(!Array.isArray(n))throw new Error("array expected")}function Fi(n,t){if(!qi(!0,t))throw new Error(`${n}: array of strings expected`)}function Fs(n,t){if(!qi(!1,t))throw new Error(`${n}: array of numbers expected`)}function Oi(...n){const t=o=>o,e=(o,l)=>c=>o(l(c)),r=n.map(o=>o.encode).reduceRight(e,t),i=n.map(o=>o.decode).reduce(e,t);return{encode:r,decode:i}}function Os(n){const t=typeof n=="string"?n.split(""):n,e=t.length;Fi("alphabet",t);const r=new Map(t.map((i,o)=>[i,o]));return{encode:i=>(zr(i),i.map(o=>{if(!Number.isSafeInteger(o)||o<0||o>=e)throw new Error(`alphabet.encode: digit index outside alphabet "${o}". Allowed: ${n}`);return t[o]})),decode:i=>(zr(i),i.map(o=>{$r("alphabet.decode",o);const l=r.get(o);if(l===void 0)throw new Error(`Unknown letter: "${o}". Allowed: ${n}`);return l}))}}function Ns(n=""){return $r("join",n),{encode:t=>(Fi("join.decode",t),t.join(n)),decode:t=>($r("join.decode",t),t.split(n))}}function Ni(n,t,e){if(t<2)throw new Error(`convertRadix: invalid from=${t}, base cannot be less than 2`);if(e<2)throw new Error(`convertRadix: invalid to=${e}, base cannot be less than 2`);if(zr(n),!n.length)return[];let r=0;const i=[],o=Array.from(n,c=>{if(Wr(c),c<0||c>=t)throw new Error(`invalid integer: ${c}`);return c}),l=o.length;for(;;){let c=0,y=!0;for(let M=r;M<l;M++){const A=o[M],S=t*c,B=S+A;if(!Number.isSafeInteger(B)||S/t!==c||B-A!==S)throw new Error("convertRadix: carry overflow");const _=B/e;c=B%e;const P=Math.floor(_);if(o[M]=P,!Number.isSafeInteger(P)||P*e+c!==B)throw new Error("convertRadix: carry overflow");if(y)P?y=!1:r=M;else continue}if(i.push(c),y)break}for(let c=0;c<n.length-1&&n[c]===0;c++)i.push(0);return i.reverse()}function Rs(n){Wr(n);const t=2**8;return{encode:e=>{if(!Hr(e))throw new Error("radix.encode input should be Uint8Array");return Ni(Array.from(e),t,n)},decode:e=>(Fs("radix.decode",e),Uint8Array.from(Ni(e,n,t)))}}function Ks(n,t){return Wr(n),qs(t),{encode(e){if(!Hr(e))throw new Error("checksum.encode: input should be Uint8Array");const r=t(e).slice(0,n),i=new Uint8Array(e.length+n);return i.set(e),i.set(r,e.length),i},decode(e){if(!Hr(e))throw new Error("checksum.decode: input should be Uint8Array");const r=e.slice(0,-n),i=e.slice(-n),o=t(r).slice(0,n);for(let l=0;l<n;l++)if(o[l]!==i[l])throw new Error("Invalid checksum");return r}}}const Ds=(n=>Oi(Rs(58),Os(n),Ns("")))("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),Ls=n=>Oi(Ks(4,t=>n(n(t))),Ds);const lr=rt.ProjectivePoint,Zr=Ls(Ot);function Ri(n){Ht(n);const t=n.length===0?"0":dt(n);return BigInt("0x"+t)}function Hs(n){if(typeof n!="bigint")throw new Error("bigint expected");return ut(n.toString(16).padStart(64,"0"))}const $s=Je("Bitcoin seed"),jr={private:76066276,public:76067358},Vr=2147483648,Ws=n=>Cs(Ot(n)),zs=n=>ve(n).getUint32(0,!1),dr=n=>{if(!Number.isSafeInteger(n)||n<0||n>2**32-1)throw new Error("invalid number, should be from 0 to 2**32-1, got "+n);const t=new Uint8Array(4);return ve(t).setUint32(0,n,!1),t};class me{get fingerprint(){if(!this.pubHash)throw new Error("No publicKey set!");return zs(this.pubHash)}get identifier(){return this.pubHash}get pubKeyHash(){return this.pubHash}get privateKey(){return this.privKeyBytes||null}get publicKey(){return this.pubKey||null}get privateExtendedKey(){const t=this.privateKey;if(!t)throw new Error("No private key");return Zr.encode(this.serialize(this.versions.private,Dt(new Uint8Array([0]),t)))}get publicExtendedKey(){if(!this.pubKey)throw new Error("No public key");return Zr.encode(this.serialize(this.versions.public,this.pubKey))}static fromMasterSeed(t,e=jr){if(Ht(t),8*t.length<128||8*t.length>512)throw new Error("HDKey: seed length must be between 128 and 512 bits; 256 bits is advised, got "+t.length);const r=Oe(Zn,$s,t);return new me({versions:e,chainCode:r.slice(32),privateKey:r.slice(0,32)})}static fromExtendedKey(t,e=jr){const r=Zr.decode(t),i=ve(r),o=i.getUint32(0,!1),l={versions:e,depth:r[4],parentFingerprint:i.getUint32(5,!1),index:i.getUint32(9,!1),chainCode:r.slice(13,45)},c=r.slice(45),y=c[0]===0;if(o!==e[y?"private":"public"])throw new Error("Version mismatch");return y?new me({...l,privateKey:c.slice(1)}):new me({...l,publicKey:c})}static fromJSON(t){return me.fromExtendedKey(t.xpriv)}constructor(t){if(this.depth=0,this.index=0,this.chainCode=null,this.parentFingerprint=0,!t||typeof t!="object")throw new Error("HDKey.constructor must not be called directly");if(this.versions=t.versions||jr,this.depth=t.depth||0,this.chainCode=t.chainCode||null,this.index=t.index||0,this.parentFingerprint=t.parentFingerprint||0,!this.depth&&(this.parentFingerprint||this.index))throw new Error("HDKey: zero depth with non-zero index/parent fingerprint");if(t.publicKey&&t.privateKey)throw new Error("HDKey: publicKey and privateKey at same time.");if(t.privateKey){if(!rt.utils.isValidPrivateKey(t.privateKey))throw new Error("Invalid private key");this.privKey=typeof t.privateKey=="bigint"?t.privateKey:Ri(t.privateKey),this.privKeyBytes=Hs(this.privKey),this.pubKey=rt.getPublicKey(t.privateKey,!0)}else if(t.publicKey)this.pubKey=lr.fromHex(t.publicKey).toRawBytes(!0);else throw new Error("HDKey: no public or private key provided");this.pubHash=Ws(this.pubKey)}derive(t){if(!/^[mM]'?/.test(t))throw new Error('Path must start with "m" or "M"');if(/^[mM]'?$/.test(t))return this;const e=t.replace(/^[mM]'?\//,"").split("/");let r=this;for(const i of e){const o=/^(\d+)('?)$/.exec(i),l=o&&o[1];if(!o||o.length!==3||typeof l!="string")throw new Error("invalid child index: "+i);let c=+l;if(!Number.isSafeInteger(c)||c>=Vr)throw new Error("Invalid index");o[2]==="'"&&(c+=Vr),r=r.deriveChild(c)}return r}deriveChild(t){if(!this.pubKey||!this.chainCode)throw new Error("No publicKey or chainCode set");let e=dr(t);if(t>=Vr){const c=this.privateKey;if(!c)throw new Error("Could not derive hardened child key");e=Dt(new Uint8Array([0]),c,e)}else e=Dt(this.pubKey,e);const r=Oe(Zn,this.chainCode,e),i=Ri(r.slice(0,32)),o=r.slice(32);if(!rt.utils.isValidPrivateKey(i))throw new Error("Tweak bigger than curve order");const l={versions:this.versions,chainCode:o,depth:this.depth+1,parentFingerprint:this.fingerprint,index:t};try{if(this.privateKey){const c=$t(this.privKey+i,rt.CURVE.n);if(!rt.utils.isValidPrivateKey(c))throw new Error("The tweak was out of range or the resulted private key is invalid");l.privateKey=c}else{const c=lr.fromHex(this.pubKey).add(lr.fromPrivateKey(i));if(c.equals(lr.ZERO))throw new Error("The tweak was equal to negative P, which made the result key invalid");l.publicKey=c.toRawBytes(!0)}return new me(l)}catch{return this.deriveChild(t+1)}}sign(t){if(!this.privateKey)throw new Error("No privateKey set!");return Ht(t,32),rt.sign(t,this.privKey).toCompactRawBytes()}verify(t,e){if(Ht(t,32),Ht(e,64),!this.publicKey)throw new Error("No publicKey set!");let r;try{r=rt.Signature.fromCompact(e)}catch{return!1}return rt.verify(r,t,this.publicKey)}wipePrivateData(){return this.privKey=void 0,this.privKeyBytes&&(this.privKeyBytes.fill(0),this.privKeyBytes=void 0),this}toJSON(){return{xpriv:this.privateExtendedKey,xpub:this.publicExtendedKey}}serialize(t,e){if(!this.chainCode)throw new Error("No chainCode set");return Ht(e,33),Dt(dr(t),new Uint8Array([this.depth]),dr(this.parentFingerprint),dr(this.index),this.chainCode,e)}}const De={UNPAID:"UNPAID",PENDING:"PENDING",PAID:"PAID"},Gr={UNPAID:"UNPAID",PAID:"PAID"};class Le extends Error{constructor(t,e){super(t),this.status=e,this.name="HttpResponseError",Object.setPrototypeOf(this,Le.prototype)}}class Qr extends Error{constructor(t){super(t),this.name="NetworkError",Object.setPrototypeOf(this,Qr.prototype)}}class Yr extends Le{constructor(t,e){super(e||"Unknown mint operation error",400),this.code=t,this.name="MintOperationError",Object.setPrototypeOf(this,Yr.prototype)}}const zt={error(){},warn(){},info(){},debug(){},trace(){},log(){}};function pr(n,t=zt,e){throw t.error(n,e),new Error(n)}function Ki(n,t,e=zt,r){n&&pr(t,e,r)}function Di(n,t,e=zt,r){n==null&&pr(t,e,r)}function He(n,t,e=zt,r){if(n)try{const i=n(t);i&&typeof i.then=="function"&&i.catch(o=>{try{e.warn("callback failed",{...r??{},error:o,cb:n.name??""})}catch{}})}catch(i){try{e.warn("callback failed",{...r??{},error:i,cb:n.name??""})}catch{}}}function Zs(){const n=Date.now();return{elapsed:()=>Date.now()-n}}let js={},Li=zt;function Vs(n){Li=n}async function Gs({endpoint:n,requestBody:t,headers:e,...r}){const i=t?JSON.stringify(t):void 0,o={Accept:"application/json, text/plain, */*",...i?{"Content-Type":"application/json"}:void 0,...e};let l;try{l=await fetch(n,{body:i,headers:o,...r})}catch(c){throw new Qr(c instanceof Error?c.message:"Network request failed")}if(!l.ok){let c;try{c=await l.json()}catch{c={error:"bad response"}}if(l.status===400&&"code"in c&&typeof c.code=="number"&&"detail"in c&&typeof c.detail=="string")throw new Yr(c.code,c.detail);let y="HTTP request failed";throw"error"in c&&typeof c.error=="string"?y=c.error:"detail"in c&&typeof c.detail=="string"&&(y=c.detail),new Le(y,l.status)}try{return await l.json()}catch(c){throw Li.error("Failed to parse HTTP response",{err:c}),new Le("bad response",l.status)}}async function Qs(n){return await Gs({...n,...js})}let Xr;typeof WebSocket<"u"&&(Xr=WebSocket);function Ys(){if(Xr===void 0)throw new Error("WebSocket implementation not initialized");return Xr}class ht{static fromHex(t){if(t=t.trim(),t.length===0)return new Uint8Array(0);if(t.length<2||t.length&1)throw new Error("Invalid hex string: odd length.");if((t.startsWith("0x")||t.startsWith("0X"))&&(t=t.slice(2)),!t.match(/^[0-9a-fA-F]*$/))throw new Error("Invalid hex string: contains non-hex characters");const e=t.match(/.{1,2}/g);if(!e)throw new Error("Invalid hex string");return new Uint8Array(e.map(r=>parseInt(r,16)))}static toHex(t){return Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}static fromString(t){return t=t.trim(),new TextEncoder().encode(t)}static toString(t){return new TextDecoder("utf-8").decode(t)}static concat(...t){const e=t.reduce((o,l)=>o+l.length,0),r=new Uint8Array(e);let i=0;for(const o of t)r.set(o,i),i+=o.length;return r}static alloc(t){return new Uint8Array(t)}static writeBigUint64BE(t){const e=new ArrayBuffer(8);return new DataView(e).setBigUint64(0,t,!1),new Uint8Array(e)}static toBase64(t){if(typeof Buffer<"u")return Buffer.from(t).toString("base64");if(t.length>32768){let e="";for(let r=0;r<t.length;r+=32768){const i=t.slice(r,r+32768);e+=btoa(String.fromCharCode(...i))}return e}return btoa(String.fromCharCode(...t))}static fromBase64(t){t=t.trim();let e=t.replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";return typeof Buffer<"u"?new Uint8Array(Buffer.from(e,"base64")):new Uint8Array([...atob(e)].map(r=>r.charCodeAt(0)))}static equals(t,e){if(t.length!==e.length)return!1;let r=0;for(let i=0;i<t.length;i++)r|=t[i]^e[i];return r===0}static compare(t,e){const r=Math.min(t.length,e.length);for(let i=0;i<r;i++){if(t[i]<e[i])return-1;if(t[i]>e[i])return 1}return t.length-e.length}}function Jr(n){return ht.toBase64(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Hi(n){return ht.fromBase64(n)}function Xs(n){const t=ht.toString(ht.fromBase64(Js(n)));return JSON.parse(t)}function Js(n){return n.replace(/-/g,"+").replace(/_/g,"/").split("=")[0]}function $i(n){if(typeof n!="string"||n.length===0)return!1;const t=/^[A-Za-z0-9\-_]+={0,2}$/,e=/^[A-Za-z0-9+/]+={0,2}$/;if(!t.test(n)&&!e.test(n))return!1;const r=n.replace(/-/g,"+").replace(/_/g,"/"),i=(4-r.length%4)%4;if(i>2)return!1;const o=r+"=".repeat(i);try{const l=ht.fromBase64(o),c=ht.toBase64(l),y=c.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),M=r.replace(/=+$/,"");return c.replace(/=+$/,"")===M||y===M}catch{return!1}}function ta(n){return typeof n=="number"||typeof n=="string"}function ea(n){const t=[];return tn(n,t),new Uint8Array(t)}function tn(n,t){if(n===null)t.push(246);else if(n===void 0)t.push(247);else if(typeof n=="boolean")t.push(n?245:244);else if(typeof n=="number")oa(n,t);else if(typeof n=="string")Wi(n,t);else if(Array.isArray(n))aa(n,t);else if(n instanceof Uint8Array)sa(n,t);else if(typeof n=="object"&&n!==null&&!Array.isArray(n))ua(n,t);else throw new Error("Unsupported type")}function ra(n,t){if(n<24)t.push(n);else if(n<256)t.push(24,n);else if(n<65536)t.push(25,n>>>8&255,n&255);else if(n<4294967296)t.push(26,n>>>24&255,n>>>16&255,n>>>8&255,n&255);else throw new Error("Unsupported integer size")}function na(n,t){const e=-1-n;if(e<24)t.push(32|e);else if(e<256)t.push(56,e&255);else if(e<65536)t.push(57,e>>>8&255,e&255);else if(e<4294967296)t.push(58,e>>>24&255,e>>>16&255,e>>>8&255,e&255);else throw new Error("Unsupported integer size")}function ia(n,t){const e=new ArrayBuffer(8),r=new DataView(e);r.setFloat64(0,n,!1),t.push(251);for(let i=0;i<8;i++)t.push(r.getUint8(i))}function oa(n,t){Number.isInteger(n)?n>=0?ra(n,t):na(n,t):ia(n,t)}function sa(n,t){const e=n.length;if(e<24)t.push(64+e);else if(e<256)t.push(88,e);else if(e<65536)t.push(89,e>>8&255,e&255);else if(e<4294967296)t.push(90,e>>>24&255,e>>>16&255,e>>>8&255,e&255);else throw new Error("Byte string too long to encode");for(let r=0;r<n.length;r++)t.push(n[r])}function Wi(n,t){const e=new TextEncoder().encode(n),r=e.length;if(r<24)t.push(96+r);else if(r<256)t.push(120,r);else if(r<65536)t.push(121,r>>>8&255,r&255);else if(r<4294967296)t.push(122,r>>>24&255,r>>>16&255,r>>>8&255,r&255);else throw new Error("String too long to encode");for(let i=0;i<e.length;i++)t.push(e[i])}function aa(n,t){const e=n.length;if(e<24)t.push(128|e);else if(e<256)t.push(152,e);else if(e<65536)t.push(153,e>>>8&255,e&255);else throw new Error("Unsupported array length");for(const r of n)tn(r,t)}function ua(n,t){const e=Object.keys(n),r=e.length;if(r>=4294967296)throw new Error("Object has too many keys to encode");r<24?t.push(160|r):r<256?t.push(184,r):r<65536?t.push(185,r>>8&255,r&255):t.push(186,r>>24&255,r>>16&255,r>>8&255,r&255);for(const i of e)Wi(i,t),tn(n[i],t)}function ha(n){const t=new DataView(n.buffer,n.byteOffset,n.byteLength);return mr(t,0).value}function mr(n,t){if(t>=n.byteLength)throw new Error("Unexpected end of data");const e=n.getUint8(t++),r=e>>5,i=e&31;switch(r){case 0:return ca(n,t,i);case 1:return fa(n,t,i);case 2:return la(n,t,i);case 3:return da(n,t,i);case 4:return pa(n,t,i);case 5:return ma(n,t,i);case 7:return ya(n,t,i);default:throw new Error(`Unsupported major type: ${r}`)}}function oe(n,t,e){if(t+e>n.byteLength)throw new Error("Unexpected end of data")}function Ae(n,t,e){if(e<24)return{value:e,offset:t};if(e===24)return oe(n,t,1),{value:n.getUint8(t++),offset:t};if(e===25){oe(n,t,2);const r=n.getUint16(t,!1);return t+=2,{value:r,offset:t}}if(e===26){oe(n,t,4);const r=n.getUint32(t,!1);return t+=4,{value:r,offset:t}}if(e===27){oe(n,t,8);const r=n.getUint32(t,!1),i=n.getUint32(t+4,!1);return t+=8,{value:r*2**32+i,offset:t}}throw new Error(`Unsupported length: ${e}`)}function ca(n,t,e){const{value:r,offset:i}=Ae(n,t,e);return{value:r,offset:i}}function fa(n,t,e){const{value:r,offset:i}=Ae(n,t,e);return{value:-1-r,offset:i}}function la(n,t,e){const{value:r,offset:i}=Ae(n,t,e);if(i+r>n.byteLength)throw new Error("Byte string length exceeds data length");return{value:new Uint8Array(n.buffer,n.byteOffset+i,r),offset:i+r}}function da(n,t,e){const{value:r,offset:i}=Ae(n,t,e);if(i+r>n.byteLength)throw new Error("String length exceeds data length");const o=new Uint8Array(n.buffer,n.byteOffset+i,r);return{value:new TextDecoder().decode(o),offset:i+r}}function pa(n,t,e){const{value:r,offset:i}=Ae(n,t,e),o=[];let l=i;for(let c=0;c<r;c++){const y=mr(n,l);o.push(y.value),l=y.offset}return{value:o,offset:l}}function ma(n,t,e){const{value:r,offset:i}=Ae(n,t,e),o={};let l=i;for(let c=0;c<r;c++){const y=mr(n,l);if(!ta(y.value))throw new Error("Invalid key type");const M=mr(n,y.offset);o[y.value]=M.value,l=M.offset}return{value:o,offset:l}}function ga(n){const t=(n&31744)>>10,e=n&1023,r=n&32768?-1:1;return t===0?r*2**-14*(e/1024):t===31?e?NaN:r*(1/0):r*2**(t-15)*(1+e/1024)}function ya(n,t,e){if(e<24)switch(e){case 20:return{value:!1,offset:t};case 21:return{value:!0,offset:t};case 22:return{value:null,offset:t};case 23:return{value:void 0,offset:t};default:throw new Error(`Unknown simple value: ${e}`)}if(e===24)return oe(n,t,1),{value:n.getUint8(t++),offset:t};if(e===25){oe(n,t,2);const r=ga(n.getUint16(t,!1));return t+=2,{value:r,offset:t}}if(e===26){oe(n,t,4);const r=n.getFloat32(t,!1);return t+=4,{value:r,offset:t}}if(e===27){oe(n,t,8);const r=n.getFloat64(t,!1);return t+=8,{value:r,offset:t}}throw new Error(`Unknown simple or float value: ${e}`)}const zi=Je("Cashu_P2BK_v1");function wa(n,t,e){if(!n.length)return{blinded:[],Ehex:""};e=e??rt.utils.randomSecretKey();const r=rt.Point.Fn.fromBytes(e),i=rt.getPublicKey(e,!0),o=ut(t);return{blinded:n.map((l,c)=>{const y=Se(l),M=Zi(y,r,o,c),A=y.add(rt.Point.BASE.multiply(M));if(A.equals(rt.Point.ZERO))throw new Error("Blinded key at infinity");return A.toHex(!0)}),Ehex:dt(i)}}function va(n,t,e,r){const i=Array.isArray(t)?t:[t],o=Array.isArray(e)?e:[e],l=new Set,c=rt.Point.fromHex(n),y=ut(r);for(const M of i){const A=rt.Point.Fn.fromBytes(ut(M)),S=rt.getPublicKey(ut(M),!0);o.forEach((B,_)=>{const P=Zi(c,A,y,_),T=ut(B),C=ba(M,P,T,S);C&&l.add(C)})}return Array.from(l)}function ba(n,t,e,r){const i=rt.Point.CURVE().n,o=typeof n=="string"?$e(n):n,l=typeof t=="string"?$e(t):t;if(o<=0n||o>=i)throw new Error("Invalid private key");if(l<=0n||l>=i)throw new Error("Invalid scalar r");if(r=r??rt.Point.BASE.multiply(o).toBytes(!0),r.length!==33)throw new Error("naturalPub must be 33 bytes");const c=(o+l)%i,y=(i-o+l)%i;if(!e){if(c===0n)throw new Error("Derived secret key is zero");return rn(c)}if(e.length!==33)throw new Error("blindPubkey must be 33 bytes");const M=rt.Point.fromHex(e),A=rt.Point.BASE.multiply(l),S=M.subtract(A);if(S.equals(rt.Point.ZERO))return null;const B=S.toBytes(!0).slice(1),_=r.slice(1);if(!ht.equals(B,_))return null;const P=S.toBytes(!0)[0]&1,T=r[0]&1,C=P===T?c:y;if(C===0n)throw new Error("Derived secret key is zero");return rn(C)}function Zi(n,t,e,r){const i=n.multiply(t).toBytes(!0).slice(1),o=new Uint8Array([r&255]);let l=ae(Ot(ht.concat(zi,i,e,o)));if((l===0n||l>=rt.Point.CURVE().n)&&(l=ae(Ot(ht.concat(zi,i,e,o,new Uint8Array([255])))),l===0n||l>=rt.Point.CURVE().n))throw new Error("P2BK: tweak derivation failed");return l}const Ie=n=>{try{return n instanceof Uint8Array&&(n=new TextDecoder().decode(n)),JSON.parse(n)}catch{throw new Error("can't parse secret")}},xa=(n,t)=>{const e=Ot(n),r=cr.sign(e,t);return dt(r)},Ea=(n,t,e)=>{try{const r=Ot(t),i=e.length===66?e.slice(2):e;if(cr.verify(n,r,ut(i)))return!0}catch(r){console.error("verifyP2PKsecret error:",r)}return!1};function Ma(n){try{const t=typeof n=="string"?Ie(n):n;if(t[0]!=="P2PK")throw new Error('Invalid P2PK secret: must start with "P2PK"');const e=Math.floor(Date.now()/1e3);return _a(t)>e?ji(t):Vi(t)}catch{}return[]}function ji(n){const t=typeof n=="string"?Ie(n):n;if(t[0]!=="P2PK")throw new Error('Invalid P2PK secret: must start with "P2PK"');const{data:e,tags:r}=t[1],i=r&&r.find(l=>l[0]==="pubkeys"),o=i&&i.length>1?i.slice(1):[];return[e,...o].filter(Boolean)}function Vi(n){const t=typeof n=="string"?Ie(n):n;if(t[0]!=="P2PK")throw new Error('Invalid P2PK secret: must start with "P2PK"');const{tags:e}=t[1],r=e&&e.find(i=>i[0]==="refund");return r&&r.length>1?r.slice(1).filter(Boolean):[]}function _a(n){const t=typeof n=="string"?Ie(n):n;if(t[0]!=="P2PK")throw new Error('Invalid P2PK secret: must start with "P2PK"');const{tags:e}=t[1],r=e&&e.find(i=>i[0]==="locktime");return r&&r.length>1?parseInt(r[1],10):1/0}const Ba=n=>{if(!n)return[];if(typeof n=="string")try{return JSON.parse(n).signatures||[]}catch(t){return console.error("Failed to parse witness string:",t),[]}return n.signatures||[]},ka=(n,t,e=zt)=>n.map((r,i)=>{try{const o=Ia(t,r);let l=r;for(const c of o)try{l=Aa(l,c)}catch(y){const M=y instanceof Error?y.message:"Unknown error";e.warn(`Proof #${i+1}: ${M}`)}return l}catch(o){const l=o instanceof Error?o.message:"Unknown error";throw e.error(`Proof #${i+1}: ${l}`),new Error(`Failed signing proof #${i+1}: ${l}`)}}),Aa=(n,t)=>{const e=Ie(n.secret);if(e[0]!=="P2PK")throw new Error("not a P2PK secret");const r=dt(cr.getPublicKey(t)),i=Ma(e);if(!i.length||!i.some(c=>c.includes(r)))throw new Error(`Signature not required from [02|03]${r}`);const o=Ba(n.witness);if(o.some(c=>{try{return Ea(c,n.secret,r)}catch{return!1}}))throw new Error(`Proof already signed by [02|03]${r}`);const l=xa(n.secret,t);return{...n,witness:{signatures:[...o,l]}}};function Ia(n,t){const e=Array.isArray(n)?n:[n],r=t?.p2pk_e;if(!r)return Array.from(new Set(e));const i=Ie(t.secret),o=[...ji(i),...Vi(i)],l=t.id;return va(r,e,o,l)}const Sa=ut("536563703235366b315f48617368546f43757276655f43617368755f");function gr(n){const t=Ot(ht.concat(Sa,n)),e=new Uint32Array(1),r=2**16;for(let i=0;i<r;i++){const o=new Uint8Array(e.buffer),l=Ot(ht.concat(t,o));try{return Se(dt(ht.concat(new Uint8Array([2]),l)))}catch{e[0]++}}throw new Error("No valid point found")}function Ta(n){const t=n.map(e=>e.toHex(!1)).join("");return Ot(new TextEncoder().encode(t))}function Se(n){return rt.Point.fromHex(n)}const Pa=n=>{let t;return/^[a-fA-F0-9]+$/.test(n)?t=$e(n)%BigInt(2**31-1):t=ae(Hi(n))%BigInt(2**31-1),t};function en(n,t,e){const r=gr(n);t||(t=ae(rt.utils.randomSecretKey()));const i=rt.Point.BASE.multiply(t);return{B_:r.add(i),r:t,secret:n}}function Ua(n,t,e){return n.subtract(e.multiply(t))}function Ca(n,t,e,r){const i=r,o=Ua(n.C_,t,i);return{id:n.id,amount:n.amount,secret:e,C:o}}const qa=n=>({amount:n.amount,C:n.C.toHex(!0),id:n.id,secret:new TextDecoder().decode(n.secret),witness:JSON.stringify(n.witness)}),Fa="m/129372'/0'",Oa=(n,t,e)=>{const r=/^[a-fA-F0-9]+$/.test(t);if(!r&&$i(t)||r&&t.startsWith("00"))return Qi(n,t,e,0);if(r&&t.startsWith("01"))return Gi(n,t,e,0);throw new Error(`Unrecognized keyset ID version ${t.slice(0,2)}`)},Na=(n,t,e)=>{const r=/^[a-fA-F0-9]+$/.test(t);if(!r&&$i(t)||r&&t.startsWith("00"))return Qi(n,t,e,1);if(r&&t.startsWith("01"))return Gi(n,t,e,1);throw new Error(`Unrecognized keyset ID version ${t.slice(0,2)}`)},Gi=(n,t,e,r)=>{let i=ht.concat(ht.fromString("Cashu_KDF_HMAC_SHA256"),ht.fromHex(t),ht.writeBigUint64BE(BigInt(e)));switch(r){case 0:i=ht.concat(i,ht.fromHex("00"));break;case 1:i=ht.concat(i,ht.fromHex("01"))}return Oe(Ot,n,i)},Qi=(n,t,e,r)=>{const i=me.fromMasterSeed(n),o=Pa(t),l=`${Fa}/${o}'/${e}'/${r}`,c=i.derive(l);if(c.privateKey===null)throw new Error("Could not derive private key");return c.privateKey};function Ra(n,t){if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++)if(n[e]!==t[e])return!1;return!0}const Ka=(n,t,e,r)=>{const i=rt.Point.BASE.multiply(rt.Point.Fn.fromBytes(n.s)),o=r.multiply(ae(n.e)),l=t.multiply(ae(n.s)),c=e.multiply(ae(n.e)),y=i.subtract(o),M=l.subtract(c),A=Ta([y,M,r,e]);return Ra(A,n.e)},Da=(n,t,e,r)=>{if(t.r===void 0)throw new Error("verifyDLEQProof_reblind: Undefined blinding factor");const i=gr(n),o=e.add(r.multiply(t.r)),l=rt.Point.BASE.multiply(t.r),c=i.add(l);return Ka(t,c,o,r)};function La(n,t){let e=n;for(const i of t)e+=i.B_;const r=new TextEncoder().encode(e);return Ot(r)}function Ha(n,t,e){const r=La(t,e),i=ut(n),o=cr.sign(r,i);return dt(o)}function se(n,t,e,r){if(e){const o=eo(e);if(n===0&&o===0)return e;const l=e.filter(y=>y>0),c=eo(l);if(c>n)throw new Error(`Split is greater than total amount: ${c} > ${n}`);if(l.some(y=>!Xi(y,t)))throw new Error("Provided amount preferences do not match the amounts of the mint keyset.");if(c===n)return l;e=l,n-=c}else e=[];const i=Yi(t,"desc");if(!i||i.length===0)throw new Error("Cannot split amount, keyset is inactive or contains no keys");for(const o of i){if(o<=0)continue;const l=Math.floor(n/o);if(e.push(...Array(l).fill(o)),n-=o*l,n===0)break}if(n!==0)throw new Error(`Unable to split remaining amount: ${n}`);return r?e.sort((o,l)=>o-l):e}function $a(n,t,e,r){const i=[],o=n.map(c=>c.amount);Yi(e,"asc").forEach(c=>{const y=o.filter(A=>A===c).length,M=Math.max(r-y,0);for(let A=0;A<M&&!(i.reduce((S,B)=>S+B,0)+c>t);++A)i.push(c)});const l=t-i.reduce((c,y)=>c+y,0);return l&&se(l,e).forEach(c=>{i.push(c)}),i.sort((c,y)=>c-y)}function Yi(n,t="desc"){return t=="desc"?Object.keys(n).map(e=>parseInt(e)).sort((e,r)=>r-e):Object.keys(n).map(e=>parseInt(e)).sort((e,r)=>e-r)}function Xi(n,t){return n in t}function ae(n){return $e(dt(n))}function $e(n){return BigInt(`0x${n}`)}function rn(n){return n.toString(16).padStart(64,"0")}function nn(n){return/^[a-f0-9]*$/i.test(n)}function Wa(n){return Array.isArray(n)?n.some(t=>!nn(t.id)):!nn(n.id)}function za(n){return n.map(t=>{const e={...t};return e.id=e.id.slice(0,16),e})}function Za(n,t){if(n.proofs.forEach(c=>{if(c.dleq&&c.dleq.r==null)throw new Error("Missing blinding factor in included DLEQ proof")}),Wa(n.proofs))throw new Error("can not encode to v4 token if proofs contain non-hex keyset id");n.proofs=za(n.proofs);const e=ja(n),r=ea(e),i="cashu",o="B",l=Jr(r);return i+o+l}function ja(n){const t={},e=n.mint;for(let i=0;i<n.proofs.length;i++){const o=n.proofs[i];t[o.id]?t[o.id].push(o):t[o.id]=[o]}const r={m:e,u:n.unit||"sat",t:Object.keys(t).map(i=>({i:ut(i),p:t[i].map(o=>({a:o.amount,s:o.secret,c:ut(o.C),...o.dleq&&{d:{e:ut(o.dleq.e),s:ut(o.dleq.s),r:ut(o.dleq.r??"00")}},...o.p2pk_e&&{pe:ut(o.p2pk_e)},...o.witness&&{w:JSON.stringify(o.witness)}}))}))};return n.memo&&(r.d=n.memo),r}function Va(n){const t=[];n.t.forEach(r=>r.p.forEach(i=>{t.push({secret:i.s,C:dt(i.c),amount:i.a,id:dt(r.i),...i.d&&{dleq:{r:dt(i.d.r),s:dt(i.d.s),e:dt(i.d.e)}},...i.pe&&{p2pk_e:dt(i.pe)},...i.w&&{witness:i.w}})}));const e={mint:n.m,proofs:t,unit:n.u||"sat"};return n.d&&(e.memo=n.d),e}function Ji(n,t){const e=eu(n),r=Ga(e);return r.proofs=Ja(r.proofs,t),r}function Ga(n){const t=n.slice(0,1),e=n.slice(1);if(t==="A"){const r=Xs(e);if(r.token.length>1)throw new Error("Multi entry token are not supported");const i=r.token[0],o={mint:i.mint,proofs:i.proofs,unit:r.unit||"sat"};return r.memo&&(o.memo=r.memo),o}else if(t==="B"){const r=Hi(e),i=ha(r);return Va(i)}throw new Error("Token version is not supported")}function Qa(n,t,e,r=0,i=!1){if(i){const y=Object.entries(n).sort((A,S)=>+A[0]-+S[0]).map(([,A])=>A).reduce((A,S)=>A+S,""),M=Ot(y);return ht.toBase64(M).slice(0,12)}let o=Object.entries(n).sort((y,M)=>+y[0]-+M[0]).map(([,y])=>ut(y)).reduce((y,M)=>on(y,M),new Uint8Array),l,c;switch(r){case 0:return l=Ot(o),c=ht.toHex(l).slice(0,14),"00"+c;case 1:if(!t)throw new Error("Cannot compute keyset ID version 01: unit is required.");return o=on(o,ht.fromString("unit:"+t)),e&&(o=on(o,ht.fromString("final_expiry:"+e.toString()))),l=Ot(o),c=ht.toHex(l),"01"+c;default:throw new Error(`Unrecognized keyset ID version: ${r}`)}}function on(n,t){const e=new Uint8Array(n.length+t.length);return e.set(n),e.set(t,n.length),e}function Nt(n){return typeof n=="object"}function Te(...n){return n.map(t=>t.replace(/(^\/+|\/+$)/g,"")).join("/")}function to(n){return n.replace(/\/$/,"")}function We(n){return n.reduce((t,e)=>t+e.amount,0)}class Ya{get value(){return this._value}set value(t){this._value=t}get next(){return this._next}set next(t){this._next=t}constructor(t){this._value=t,this._next=null}}class Xa{get first(){return this._first}set first(t){this._first=t}get last(){return this._last}set last(t){this._last=t}get size(){return this._size}set size(t){this._size=t}constructor(){this._first=null,this._last=null,this._size=0}enqueue(t){const e=new Ya(t);return this._size===0||!this._last?(this._first=e,this._last=e):(this._last.next=e,this._last=e),this._size++,!0}dequeue(){if(this._size===0||!this._first)return null;const t=this._first;return this._first=t.next,t.next=null,this._size--,t.value}}function Ja(n,t){const e=[];for(const r of n){let i;try{i=ut(r.id)}catch{e.push(r);continue}if(i[0]===0)e.push(r);else if(i[0]===1){if(!t)throw new Error("A short keyset ID v2 was encountered, but got no keysets to map it to.");let o=!1;for(const l of t)if(r.id===l.id.slice(0,r.id.length)){r.id=l.id,e.push(r),o=!0;break}if(!o)throw new Error(`Couldn't map short keyset ID ${r.id} to any known keysets of the current Mint`)}else throw new Error(`Unknown keyset ID version: ${i[0]}`)}return e}function tu(n,t){if(n.dleq==null)return!1;const e={e:ut(n.dleq.e),s:ut(n.dleq.s),r:$e(n.dleq.r??"00")};if(!Xi(n.amount,t.keys))throw new Error(`undefined key for amount ${n.amount}`);const r=t.keys[n.amount];return Da(new TextEncoder().encode(n.secret),e,Se(n.C),Se(r))}function eo(n){return n.reduce((t,e)=>t+e,0)}function eu(n){return["web+cashu://","cashu://","cashu:","cashu"].forEach(t=>{n.startsWith(t)&&(n=n.slice(t.length))}),n}class Pe{constructor(){this.connectionMap=new Map}static getInstance(){return Pe.instance||(Pe.instance=new Pe),Pe.instance}getConnection(t,e){if(this.connectionMap.has(t))return this.connectionMap.get(t);const r=new ru(t,e);return this.connectionMap.set(t,r),r}}class ru{constructor(t,e){this.subListeners={},this.rpcListeners={},this.rpcId=0,this.onCloseCallbacks=[],this._WS=Ys(),this.url=new URL(t),this.messageQueue=new Xa,this._logger=e??zt}connect(){return this.connectionPromise||(this.connectionPromise=new Promise((t,e)=>{try{this.ws=new this._WS(this.url.toString()),this.onCloseCallbacks=[]}catch(r){e(r instanceof Error?r:new Error(String(r)));return}this.ws.onopen=()=>{t()},this.ws.onerror=()=>{e(new Error("Failed to open WebSocket"))},this.ws.onmessage=r=>{this.messageQueue.enqueue(r.data),this.handlingInterval||(this.handlingInterval=setInterval(this.handleNextMessage.bind(this),0))},this.ws.onclose=r=>{this.connectionPromise=void 0,this.onCloseCallbacks.forEach(i=>i(r))}})),this.connectionPromise}sendRequest(t,e){if(this.ws?.readyState!==1){if(t==="unsubscribe")return;throw this._logger.error("Attempted sendRequest, but socket was not open"),new Error("Socket not open")}const r=this.rpcId;this.rpcId++;const i=JSON.stringify({jsonrpc:"2.0",method:t,params:e,id:r});this.ws?.send(i)}closeSubscription(t){this.ws?.send(JSON.stringify(["CLOSE",t]))}addSubListener(t,e){(this.subListeners[t]=this.subListeners[t]||[]).push(e)}addRpcListener(t,e,r){this.rpcListeners[r]={callback:t,errorCallback:e}}removeRpcListener(t){delete this.rpcListeners[t]}removeListener(t,e){if(this.subListeners[t]){if(this.subListeners[t].length===1){delete this.subListeners[t];return}this.subListeners[t]=this.subListeners[t].filter(r=>r!==e)}}async ensureConnection(){this.ws?.readyState!==1&&await this.connect()}handleNextMessage(){if(this.messageQueue.size===0){clearInterval(this.handlingInterval),this.handlingInterval=void 0;return}const t=this.messageQueue.dequeue();let e;try{if(e=JSON.parse(t),"result"in e&&e.id!=null)this.rpcListeners[e.id]&&(this.rpcListeners[e.id].callback(),this.removeRpcListener(e.id));else if("error"in e&&e.id!=null)this.rpcListeners[e.id]&&(this.rpcListeners[e.id].errorCallback(new Error(e.error.message)),this.removeRpcListener(e.id));else if("method"in e&&!("id"in e)){const r=e.params?.subId;if(!r)return;if(this.subListeners[r]?.length>0){const i=e;this.subListeners[r].forEach(o=>o(i.params?.payload))}}}catch(r){this._logger.error("Error doing handleNextMessage",{e:r});return}}createSubscription(t,e,r){if(this.ws?.readyState!==1)throw this._logger.error("Attempted createSubscription, but socket was not open"),new Error("Socket is not open");const i=(Math.random()+1).toString(36).substring(7);return this.addRpcListener(()=>{this.addSubListener(i,e)},r,this.rpcId),this.sendRequest("subscribe",{...t,subId:i}),this.rpcId++,i}cancelSubscription(t,e,r){this.removeListener(t,e),this.addRpcListener(()=>{this._logger.info("Unsubscribed {subId}",{subId:t})},r||(i=>this._logger.error("Unsubscribe failed",{e:i})),this.rpcId),this.sendRequest("unsubscribe",{subId:t})}get activeSubscriptions(){return Object.keys(this.subListeners)}close(){this.ws&&this.ws?.close()}onClose(t){this.onCloseCallbacks.push(t)}}function sn(n,t){return n.state||(t.warn("Field 'state' not found in MeltQuoteResponse. Update NUT-05 of mint: https://github.com/cashubtc/nuts/pull/136)"),typeof n.paid=="boolean"&&(n.state=n.paid?De.PAID:De.UNPAID)),n}function ro(n,t){return n.state||(t.warn("Field 'state' not found in MintQuoteResponse. Update NUT-04 of mint: https://github.com/cashubtc/nuts/pull/141)"),typeof n.paid=="boolean"&&(n.state=n.paid?Gr.PAID:Gr.UNPAID)),n}function nu(n,t){return Array.isArray(n?.contact)&&n?.contact.length>0&&(n.contact=n.contact.map(e=>Array.isArray(e)&&e.length===2&&typeof e[0]=="string"&&typeof e[1]=="string"?(t.warn("Mint returned deprecated 'contact' field: Update NUT-06: https://github.com/cashubtc/nuts/pull/117"),{method:e[0],info:e[1]}):e)),n}class an{constructor(t){this.REGEX_METACHAR=/[\\^$.*+?()[\]{}|]/,this._mintInfo=t;const e=this.toEndpoints(t?.nuts?.[22]?.protected_endpoints);this._protected22=this.buildIndex(e);const r=this.toEndpoints(t?.nuts?.[21]?.protected_endpoints);this._protected21=this.buildIndex(r)}isSupported(t){switch(t){case 4:case 5:return this.checkMintMelt(t);case 7:case 8:case 9:case 10:case 11:case 12:case 14:case 20:return this.checkGenericNut(t);case 17:return this.checkNut17();case 15:return this.checkNut15();default:throw new Error("nut is not supported by cashu-ts")}}requiresBlindAuthToken(t,e){return this.matchesProtected(this._protected22,t,e)}requiresClearAuthToken(t,e){return this.matchesProtected(this._protected21,t,e)}matchesProtected(t,e,r){if(!t)return!1;const i=`${e} ${r}`,o=t.cache[i];if(typeof o=="boolean")return o;const l=t.exact.some(M=>M.method===e&&M.path===r),c=l?!1:t.regex.some(M=>M.method===e&&M.regex.test(r)),y=l||c;return t.cache[i]=y,y}checkGenericNut(t){return this._mintInfo.nuts[t]?.supported?{supported:!0}:{supported:!1}}checkMintMelt(t){const e=this._mintInfo.nuts[t];return e&&e.methods.length>0&&!e.disabled?{disabled:!1,params:e.methods}:{disabled:!0,params:e?.methods??[]}}checkNut17(){return this._mintInfo.nuts[17]&&this._mintInfo.nuts[17].supported.length>0?{supported:!0,params:this._mintInfo.nuts[17].supported}:{supported:!1}}checkNut15(){return this._mintInfo.nuts[15]&&this._mintInfo.nuts[15].methods.length>0?{supported:!0,params:this._mintInfo.nuts[15].methods}:{supported:!1}}toEndpoints(t){if(!Array.isArray(t))return[];const e=[];for(const r of t)if(r&&typeof r=="object"){const i=r,o=i.method,l=i.path;if(typeof o=="string"&&typeof l=="string"){const c=o.toUpperCase();(c==="GET"||c==="POST")&&e.push({method:c,path:l})}}return e}buildIndex(t){if(!t||t.length===0)return;const e=[],r=[],i=this.REGEX_METACHAR;for(const o of t){if(o.path.startsWith("^")||o.path.endsWith("$")||i.test(o.path))try{r.push({method:o.method,regex:new RegExp(o.path)});continue}catch{}e.push({method:o.method,path:o.path})}return{cache:{},exact:e,regex:r}}get contact(){return this._mintInfo.contact}get description(){return this._mintInfo.description}get description_long(){return this._mintInfo.description_long}get name(){return this._mintInfo.name}get pubkey(){return this._mintInfo.pubkey}get nuts(){return this._mintInfo.nuts}get version(){return this._mintInfo.version}get motd(){return this._mintInfo.motd}get supportsBolt12Description(){return this.supportsNut04Description("bolt12")}supportsNut04Description(t,e){return this._mintInfo.nuts[4]?.methods.some(r=>r.method===t&&(e?r.unit===e:!0)&&(r.options?.description===!0||r.description===!0))}}class un{constructor(t,e){this.tokenListeners=[],this.discoveryUrl=t,this.logger=e?.logger??zt,this.clientId=e?.clientId??"cashu-client",this.scope=e?.scope??"openid",this.onTokens=e?.onTokens}static fromMintInfo(t,e){const r=t?.nuts?.["21"];if(!r?.openid_discovery)throw new Error("OIDCAuth: mint does not advertise NUT-21 openid_discovery");const i=e?.clientId??r.client_id??"cashu-client";return new un(r.openid_discovery,{...e,clientId:i})}setClient(t){this.clientId=t}setScope(t){this.scope=t??"openid"}addTokenListener(t){this.tokenListeners.push(t)}async loadConfig(){if(this.config)return this.config;const t=await fetch(this.discoveryUrl,{method:"GET",headers:{Accept:"application/json"}}),e=await t.text();let r;try{r=e?JSON.parse(e):void 0}catch(o){this.logger.warn("OIDCAuth: bad discovery JSON",{err:o})}if(!t.ok||!r)throw new Error("OIDCAuth: invalid discovery document");const i=r;if(typeof i.token_endpoint!="string"||i.token_endpoint.length===0)throw new Error("OIDCAuth: invalid discovery document, missing token_endpoint");return this.config=i,i}generatePKCE(){const t=ce(48),e=Jr(t),r=ht.fromString(e),i=Ot(r),o=Jr(i);return{verifier:e,challenge:o}}async buildAuthCodeUrl(t){const e=await this.loadConfig(),r=t.scope??this.scope,i=new URLSearchParams({response_type:"code",client_id:this.clientId,redirect_uri:t.redirectUri,scope:r,code_challenge_method:t.codeChallengeMethod??"S256",code_challenge:t.codeChallenge});if(t.state&&i.set("state",t.state),!e.authorization_endpoint)throw new Error("OIDCAuth: discovery lacks authorization_endpoint");return`${e.authorization_endpoint}?${i.toString()}`}async exchangeAuthCode(t){const e=await this.loadConfig(),r=this.toForm({grant_type:"authorization_code",code:t.code,redirect_uri:t.redirectUri,client_id:this.clientId,code_verifier:t.codeVerifier}),i=await this.postFormStrict(e.token_endpoint,r);return this.handleTokens(i),i}async deviceStart(){const t=(await this.loadConfig()).device_authorization_endpoint;if(!t)throw new Error("OIDCAuth: provider lacks device_authorization_endpoint");const e=this.toForm({client_id:this.clientId,scope:this.scope});return this.postFormStrict(t,e)}async devicePoll(t,e=5){const r=await this.loadConfig();let i=Math.max(1,e);for(;;){await this.sleep(i*1e3);const o=this.toForm({grant_type:"urn:ietf:params:oauth:grant-type:device_code",device_code:t,client_id:this.clientId}),l=await this.postFormLoose(r.token_endpoint,o);if(l.access_token)return this.handleTokens(l),l;const c=(l.error??"").toString();if(c==="authorization_pending")continue;if(c==="slow_down"){i=Math.max(i+5,i*2);continue}const y=l.error_description||c||"device authorization failed";throw new Error(`OIDCAuth: ${y}`)}}async startDeviceAuth(t=5){const e=await this.deviceStart(),r=Math.max(e.interval??1,t);let i=!1;return{...e,poll:async()=>{const o=await this.loadConfig();let l=Math.max(1,r);for(;;){if(i)throw new Error("OIDCAuth: device polling cancelled");await this.sleep(l*1e3);const c=this.toForm({grant_type:"urn:ietf:params:oauth:grant-type:device_code",device_code:e.device_code,client_id:this.clientId}),y=await this.postFormLoose(o.token_endpoint,c);if(y.access_token)return this.handleTokens(y),y;const M=(y.error??"").toString();if(M==="authorization_pending")continue;if(M==="slow_down"){l=Math.max(l+5,l*2);continue}const A=y.error_description||M||"device authorization failed";throw new Error(`OIDCAuth: ${A}`)}},cancel:()=>{i=!0}}}async refresh(t){const e=await this.loadConfig(),r=this.toForm({grant_type:"refresh_token",refresh_token:t,client_id:this.clientId}),i=await this.postFormStrict(e.token_endpoint,r);return this.handleTokens(i),i}async passwordGrant(t,e){const r=await this.loadConfig(),i=this.toForm({grant_type:"password",client_id:this.clientId,username:t,password:e,scope:this.scope}),o=await this.postFormStrict(r.token_endpoint,i);return this.handleTokens(o),o}handleTokens(t){if(!t.access_token){const e=t.error_description||t.error||"token response missing access_token";throw new Error(`OIDCAuth: ${e}`)}queueMicrotask(()=>He(this.onTokens,t,this.logger,{where:"OIDCAuth.handleTokens"}));for(const e of this.tokenListeners)queueMicrotask(()=>He(e,t,this.logger,{where:"OIDCAuth.handleTokens.listener"}))}toForm(t){const e=r=>encodeURIComponent(r).replace(/%20/g,"+");return Object.entries(t).map(([r,i])=>`${e(r)}=${e(i)}`).join("&")}async postFormStrict(t,e){try{this.logger.debug("OIDCAuth Request",{formBody:e});const r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:e}),i=await r.text();let o;try{o=i?JSON.parse(i):void 0}catch(l){this.logger.warn("OIDCAuth: bad JSON (strict)",{err:l})}if(!r.ok){const l=o??{},c=l.error_description||l.error||`HTTP ${r.status}`;throw new Error(`OIDCAuth: ${c}`)}return this.logger.debug("OIDCAuth Response",{json:o}),o??{}}catch(r){throw this.logger.error("OIDCAuth: postFormStrict failed",{err:r}),r}}async postFormLoose(t,e){try{this.logger.debug("OIDCAuth Request",{formBody:e});const r=await(await fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:e})).text();let i;try{i=r?JSON.parse(r):void 0}catch(o){this.logger.warn("OIDCAuth: bad JSON (loose)",{err:o})}return this.logger.debug("OIDCAuth Response",{json:i}),i??{}}catch(r){return this.logger.error("OIDCAuth: postFormLoose network error",{err:r}),{error:"network_error",error_description:String(r)}}}sleep(t){return new Promise(e=>setTimeout(e,t))}}class no{constructor(t,e){this._mintUrl=to(t),this._request=e?.customRequest??Qs,this._authProvider=e?.authProvider,this._logger=e?.logger??zt,Vs(this._logger)}get mintUrl(){return this._mintUrl}async oidcAuth(t){const e=(await this.getLazyMintInfo()).nuts[21];if(!e?.openid_discovery)throw new Error("Mint: no NUT-21 openid_discovery");return new un(e.openid_discovery,{...t,clientId:t?.clientId??e.client_id??"cashu-client"})}async getInfo(t){const e=await(t??this._request)({endpoint:Te(this._mintUrl,"/v1/info")});return nu(e,this._logger)}async getLazyMintInfo(){if(this._mintInfo)return this._mintInfo;const t=await this.getInfo();return this._mintInfo=new an(t),this._mintInfo}async swap(t,e){const r=await this.requestWithAuth("POST","/v1/swap",{requestBody:t},e);if(!Nt(r)||!Array.isArray(r?.signatures)){const i=Nt(r)&&"detail"in r?r.detail:void 0;throw new Error(i??"bad response")}return r}async createMintQuoteBolt11(t,e){const r=await this.requestWithAuth("POST","/v1/mint/quote/bolt11",{requestBody:t},e);return ro(r,this._logger)}async createMintQuoteBolt12(t,e){return await this.requestWithAuth("POST","/v1/mint/quote/bolt12",{requestBody:t},e)}async checkMintQuoteBolt11(t,e){const r=await this.requestWithAuth("GET",`/v1/mint/quote/bolt11/${t}`,{},e);return ro(r,this._logger)}async checkMintQuoteBolt12(t,e){return await this.requestWithAuth("GET",`/v1/mint/quote/bolt12/${t}`,{},e)}async mintBolt11(t,e){const r=await this.requestWithAuth("POST","/v1/mint/bolt11",{requestBody:t},e);if(!Nt(r)||!Array.isArray(r?.signatures)){const i=Nt(r)&&"detail"in r?r.detail:void 0;throw new Error(i??"bad response")}return r}async mintBolt12(t,e){const r=await this.requestWithAuth("POST","/v1/mint/bolt12",{requestBody:t},e);if(!Nt(r)||!Array.isArray(r?.signatures)){const i=Nt(r)&&"detail"in r?r.detail:void 0;throw new Error(i??"bad response")}return r}async createMeltQuoteBolt11(t,e){const r=await this.requestWithAuth("POST","/v1/melt/quote/bolt11",{requestBody:t},e),i=sn(r,this._logger);if(!Nt(i)||typeof i?.amount!="number"||typeof i?.fee_reserve!="number"||typeof i?.quote!="string"){const o=Nt(i)&&"detail"in i?i.detail:void 0;throw new Error(o??"bad response")}return i}async createMeltQuoteBolt12(t,e){return await this.requestWithAuth("POST","/v1/melt/quote/bolt12",{requestBody:t},e)}async checkMeltQuoteBolt11(t,e){const r=await this.requestWithAuth("GET",`/v1/melt/quote/bolt11/${t}`,{},e),i=sn(r,this._logger);if(!Nt(i)||typeof i?.amount!="number"||typeof i?.fee_reserve!="number"||typeof i?.quote!="string"||typeof i?.state!="string"||!Object.values(De).includes(i.state)){const o=Nt(i)&&"detail"in i?i.detail:void 0;throw new Error(o??"bad response")}return i}async checkMeltQuoteBolt12(t,e){return await this.requestWithAuth("GET",`/v1/melt/quote/bolt12/${t}`,{},e)}async meltBolt11(t,e){const r={...e?.preferAsync?{Prefer:"respond-async"}:{}},i=await this.requestWithAuth("POST","/v1/melt/bolt11",{requestBody:t,headers:r},e?.customRequest),o=sn(i,this._logger);if(!Nt(o)||typeof o?.state!="string"||!Object.values(De).includes(o.state)){const l=Nt(o)&&"detail"in o?o.detail:void 0;throw new Error(l??"bad response")}return o}async meltBolt12(t,e){const r={...e?.preferAsync?{Prefer:"respond-async"}:{}};return await this.requestWithAuth("POST","/v1/melt/bolt12",{requestBody:t,headers:r},e?.customRequest)}async check(t,e){const r=await this.requestWithAuth("POST","/v1/checkstate",{requestBody:t},e);if(!Nt(r)||!Array.isArray(r?.states)){const i=Nt(r)&&"detail"in r?r.detail:void 0;throw new Error(i??"bad response")}return r}async getKeys(t,e,r){const i=e||this._mintUrl;t&&(t=t.replace(/\//g,"_").replace(/\+/g,"-"));const o=await(r??this._request)({endpoint:t?Te(i,"/v1/keys",t):Te(i,"/v1/keys")});if(!Nt(o)||!Array.isArray(o.keysets)){const l=Nt(o)&&"detail"in o?o.detail:void 0;throw new Error(l??"bad response")}return o}async getKeySets(t){return(t??this._request)({endpoint:Te(this._mintUrl,"/v1/keysets")})}async restore(t,e){const r=await(e??this._request)({endpoint:Te(this._mintUrl,"/v1/restore"),method:"POST",requestBody:t});if(!Nt(r)||!Array.isArray(r?.outputs)||!Array.isArray(r?.signatures)){const i=Nt(r)&&"detail"in r?r.detail:void 0;throw new Error(i??"bad response")}return r}async connectWebSocket(){if(this.ws)await this.ws.ensureConnection();else{const t=new URL(this._mintUrl),e="v1/ws";t.pathname&&(t.pathname.endsWith("/")?t.pathname+=e:t.pathname+="/"+e),this.ws=Pe.getInstance().getConnection(`${t.protocol==="https:"?"wss":"ws"}://${t.host}${t.pathname}`);try{await this.ws.connect()}catch(r){throw this._logger.error("Failed to connect to WebSocket...",{e:r}),new Error("Failed to connect to WebSocket...")}}}disconnectWebSocket(){this.ws&&this.ws.close()}get webSocketConnection(){return this.ws}async handleClearAuth(t,e){if(!(!this._authProvider||!(await this.getLazyMintInfo()).requiresClearAuthToken(t,e)))return this._logger.error("Clear Authentication Token...",{cat:this._authProvider.getCAT()}),this._authProvider.getCAT()}async handleBlindAuth(t,e){if(!this._authProvider||!(await this.getLazyMintInfo()).requiresBlindAuthToken(t,e))return;const r=await this._authProvider.getBlindAuthToken({method:t,path:e});return this._logger.error("Blind Authentication Token...",{bat:r}),r}async requestWithAuth(t,e,r={},i){const o=i??this._request,l=await this.handleBlindAuth(t,e),c=await this.handleClearAuth(t,e),y={...r.headers??{},...l?{"Blind-auth":l}:{},...c?{"Clear-auth":c}:{}};return o({...r,endpoint:Te(this._mintUrl,e),method:t,headers:y})}}class iu{constructor(t,e,r,i,o){this._keys={},this._id=t,this._unit=e,this._active=r,this._input_fee_ppk=i,this._final_expiry=o}get id(){return this._id}get unit(){return this._unit}get isActive(){return this._active}get fee(){return this._input_fee_ppk??0}get expiry(){return this._final_expiry}get hasKeys(){return Object.keys(this._keys).length>0}get hasHexId(){return nn(this._id)}get keys(){return this._keys}set keys(t){this._keys=t}get active(){return this._active}get input_fee_ppk(){return this._input_fee_ppk??0}get final_expiry(){return this._final_expiry}toMintKeyset(){return{id:this._id,unit:this._unit,active:this._active,input_fee_ppk:this._input_fee_ppk,final_expiry:this._final_expiry}}toMintKeys(){return this.hasKeys?{id:this._id,unit:this._unit,keys:this._keys}:null}verify(){if(!this.hasKeys)return!1;const t=ut(this._id)[0];return Qa(this._keys,this._unit,this._final_expiry,t)===this._id}}class ou{constructor(t,e,r,i){if(this.keysets={},this.mint=typeof t=="string"?new no(t):t,this.unit=e,r&&i){const o=Array.isArray(i)?i:[i];this.buildKeychain(r,o)}}async init(t){if(Object.keys(this.keysets).length>0&&!t)return;const[e,r]=await Promise.all([this.mint.getKeySets(),this.mint.getKeys()]);this.buildKeychain(e.keysets,r.keysets),this.getCheapestKeyset()}buildKeychain(t,e){this.keysets={},t.filter(i=>i.unit===this.unit).forEach(i=>{this.keysets[i.id]=new iu(i.id,i.unit,i.active,i.input_fee_ppk,i.final_expiry)});const r=new Map(e.filter(i=>i.unit===this.unit).map(i=>[i.id,i]));Object.values(this.keysets).forEach(i=>{if(!i.hasHexId||!i.isActive)return;const o=r.get(i.id);if(o&&(i.keys=o.keys,!i.verify()))throw new Error(`Keyset verification failed for ID ${i.id}`)})}getKeyset(t){const e=t?this.keysets[t]:this.getCheapestKeyset();if(!e)throw new Error(`Keyset '${t}' not found`);return e}getCheapestKeyset(){if(Object.keys(this.keysets).length===0)throw new Error("KeyChain not initialized");const t=Object.values(this.keysets).filter(e=>e.isActive&&e.hasHexId&&e.hasKeys);if(t.length===0)throw new Error("No active keyset found");return t.sort((e,r)=>e.fee-r.fee)[0]}getKeysets(){if(Object.keys(this.keysets).length===0)throw new Error("KeyChain not initialized");return Object.values(this.keysets)}getCache(){const t=this.getKeysets(),e=t.filter(r=>r.hasKeys).map(r=>r.toMintKeys()).filter(r=>r!==null);return{keysets:t.map(r=>r.toMintKeyset()),keys:e,unit:this.unit,mintUrl:this.mint.mintUrl}}}class hn{constructor(t,e,r){this.amount=t,this.B_=e,this.id=r}getSerializedBlindedMessage(){return{amount:this.amount,B_:this.B_.toHex(!0),id:this.id}}}const su=new Set(["locktime","pubkeys","n_sigs","refund","n_sigs_refund"]);function au(n){if(!n||typeof n!="string")throw new Error("tag key must be a non empty string");if(su.has(n))throw new Error(`additionalTags must not use reserved key "${n}"`)}const io=1024,cn=new WeakMap;function uu(n,t){t&&cn.set(n,t)}function hu(n){const t=cn.get(n);if(t)return cn.delete(n),t}class Zt{constructor(t,e,r){this.secret=r,this.blindingFactor=e,this.blindedMessage=t}toProof(t,e){let r;t.dleq&&(r={s:ut(t.dleq.s),e:ut(t.dleq.e),r:this.blindingFactor});const i={id:t.id,amount:t.amount,C_:Se(t.C_)},o=Se(e.keys[t.amount]),l=Ca(i,this.blindingFactor,this.secret,o),c={...qa(l),...r&&{dleq:{s:dt(r.s),e:dt(r.e),r:rn(r.r??BigInt(0))}}},y=hu(this);return y&&(c.p2pk_e=y),c}static createP2PKData(t,e,r,i){return se(e,r.keys,i).map(o=>this.createSingleP2PKData(t,o,r.id))}static createSingleP2PKData(t,e,r){const i=Array.isArray(t.pubkey)?t.pubkey:[t.pubkey],o=t.refundKeys??[],l=Math.max(1,Math.min(t.requiredSignatures??1,i.length)),c=Math.max(1,Math.min(t.requiredRefundSignatures??1,o.length||1));let y=i[0],M=i.slice(1),A=o,S;if(t.blindKeys){const $=[y,...M,...o],{blinded:Q,Ehex:z}=wa($,r);y=Q[0],M=Q.slice(1,i.length),A=Q.slice(i.length),S=z}const B=[],_=t.locktime??NaN;if(Number.isSafeInteger(_)&&_>=0&&B.push(["locktime",String(_)]),M.length>0&&(B.push(["pubkeys",...M]),l>1&&B.push(["n_sigs",String(l)])),A.length>0&&(B.push(["refund",...A]),c>1&&B.push(["n_sigs_refund",String(c)])),t.additionalTags?.length){const $=t.additionalTags.map(([Q,...z])=>(au(Q),[Q,...z.map(String)]));B.push(...$)}const P=["P2PK",{nonce:dt(ce(32)),data:y,tags:B}],T=JSON.stringify(P),C=[...T].length;if(C>io)throw new Error(`Secret too long (${C} characters), maximum is ${io}`);const N=new TextEncoder().encode(T),{r:K,B_:R}=en(N),D=new Zt(new hn(e,R,r).getSerializedBlindedMessage(),K,N);return t.blindKeys&&S&&uu(D,S),D}static createRandomData(t,e,r){return se(t,e.keys,r).map(i=>this.createSingleRandomData(i,e.id))}static createSingleRandomData(t,e){const r=dt(ce(32)),i=new TextEncoder().encode(r),{r:o,B_:l}=en(i);return new Zt(new hn(t,l,e).getSerializedBlindedMessage(),o,i)}static createDeterministicData(t,e,r,i,o){return se(t,i.keys,o).map((l,c)=>this.createSingleDeterministicData(l,e,r+c,i.id))}static createSingleDeterministicData(t,e,r,i){const o=Oa(e,i,r),l=dt(o),c=new TextEncoder().encode(l),y=ae(Na(e,i,r)),{r:M,B_:A}=en(c,y);return new Zt(new hn(t,A,i).getSerializedBlindedMessage(),M,c)}static sumOutputAmounts(t){return t.reduce((e,r)=>e+r.blindedMessage.amount,0)}}const cu=(n,t,e,r=!1,i=!1,o=zt)=>{const l=Zs();let c=null,y=1/0,M=0,A=0;const S=z=>{try{return e.getKeyset(z.id).fee}catch(L){pr(`Could not get fee. No keyset found for keyset id: ${z.id}`,o,{error:L,keychain:e.getKeysets()})}},B=(z,L)=>z-(r?Math.ceil(L/1e3):0),_=z=>{const L=[...z];for(let O=L.length-1;O>0;O--){const j=Math.floor(Math.random()*(O+1));[L[O],L[j]]=[L[j],L[O]]}return L},P=(z,L,O)=>{let j=0,E=z.length-1,s=null;for(;j<=E;){const h=Math.floor((j+E)/2),d=z[h].exFee;(O?d<=L:d>=L)?(s=h,O?j=h+1:E=h-1):O?E=h-1:j=h+1}return O?s:j<z.length?j:null},T=(z,L)=>{const O=L.exFee;let j=0,E=z.length;for(;j<E;){const s=Math.floor((j+E)/2);z[s].exFee<O?j=s+1:E=s}z.splice(j,0,L)},C=(z,L)=>B(z,L)<t?1/0:z+L/1e3-t;let N=0,K=0;const R=n.map(z=>{const L=S(z),O=r?z.amount-L/1e3:z.amount,j={proof:z,exFee:O,ppkfee:L};return(!r||O>0)&&(N+=z.amount,K+=L),j});let D=r?R.filter(z=>z.exFee>0):R;if(D.sort((z,L)=>z.exFee-L.exFee),D.length>0){let z;if(i){const L=P(D,t,!0);z=L!==null?L+1:0}else{const L=P(D,t,!1);if(L!==null){const O=D[L].exFee,j=P(D,O,!0);Di(j,"Unexpected null rightIndex in binary search",o),z=j+1}else z=D.length}for(let L=z;L<D.length;L++)N-=D[L].proof.amount,K-=D[L].ppkfee;D=D.slice(0,z)}const $=B(N,K);if(t<=0||t>$)return{keep:n,send:[]};const Q=Math.min(Math.ceil(t*(1+0/100)),t+0,$);for(let z=0;z<60;z++){const L=[];let O=0,j=0;for(const p of _(D)){const g=O+p.proof.amount,x=j+p.ppkfee,k=B(g,x);if(i&&k>t||(L.push(p),O=g,j=x,k>=t))break}const E=new Set(L),s=D.filter(p=>!E.has(p)),h=_(Array.from({length:L.length},(p,g)=>g)).slice(0,5e3);for(const p of h){const g=B(O,j);if(g===t||!i&&g>=t&&g<=Q)break;const x=L[p],k=O-x.proof.amount,w=j-x.ppkfee,u=B(k,w),v=t-u,F=P(s,v,i);if(F!==null){const H=s[F];(!i||H.exFee>x.exFee)&&(v>=0||H.exFee<=x.exFee)&&(L[p]=H,O=k+H.proof.amount,j=w+H.ppkfee,s.splice(F,1),T(s,x))}}const d=C(O,j);if(d<y){o.debug(`selectProofsToSend: best solution found in trial #${z} - amount: ${O}, delta: ${d}`),c=[...L].sort((g,x)=>x.exFee-g.exFee),y=d,M=O,A=j;const p=[...c];for(;p.length>1&&y>0;){const g=p.pop(),x=O-g.proof.amount,k=j-g.ppkfee,w=C(x,k);if(w==1/0)break;w<y&&(c=[...p],y=w,M=x,A=k,O=x,j=k)}}if(c&&y<1/0){const p=B(M,A);if(p===t||!i&&p>=t&&p<=Q)break}if(l.elapsed()>1e3){Ki(i,"Proof selection took too long. Try again with a smaller proof set.",o),o.warn("Proof selection took too long. Returning best selection so far.");break}}if(c&&y<1/0){const z=c.map(j=>j.proof),L=new Set(z),O=n.filter(j=>!L.has(j));return o.info(`Proof selection took ${l.elapsed()}ms`),{keep:O,send:z}}return{keep:n,send:[]}};class fu{constructor(t){if(this.next=new Map,this.locks=new Map,t)for(const[e,r]of Object.entries(t))this.next.set(e,r)}async withLock(t,e){const r=this.locks.get(t)??Promise.resolve();let i;const o=new Promise(c=>i=c),l=r.then(()=>o);this.locks.set(t,l);try{return await r,await e()}finally{i(),this.locks.get(t)===l&&this.locks.delete(t)}}async reserve(t,e){if(e<0)throw new Error("reserve called with negative count");return this.withLock(t,()=>{const r=this.next.get(t)??0;return e===0?{start:r,count:0}:(this.next.set(t,r+e),{start:r,count:e})})}async advanceToAtLeast(t,e){await this.withLock(t,()=>{const r=this.next.get(t)??0;e>r&&this.next.set(t,e)})}async setNext(t,e){await this.withLock(t,()=>{if(e<0)throw new Error("setNext: negative next not allowed");this.next.set(t,e)})}snapshot(){return Promise.resolve(Object.fromEntries(this.next.entries()))}}class lu{constructor(t){this.wallet=t}send(t,e){return new du(this.wallet,t,e)}receive(t){return new pu(this.wallet,t)}mintBolt11(t,e){return new oo(this.wallet,"bolt11",t,e)}mintBolt12(t,e){return new oo(this.wallet,"bolt12",t,e)}meltBolt11(t,e){return new so(this.wallet,"bolt11",t,e)}meltBolt12(t,e){return new so(this.wallet,"bolt12",t,e)}}class du{constructor(t,e,r){this.wallet=t,this.amount=e,this.proofs=r,this.config={}}asRandom(t){return this.sendOT={type:"random",denominations:t},this}asDeterministic(t=0,e){return this.sendOT={type:"deterministic",counter:t,denominations:e},this}asP2PK(t,e){return this.sendOT={type:"p2pk",options:t,denominations:e},this}asFactory(t,e){return this.sendOT={type:"factory",factory:t,denominations:e},this}asCustom(t){return this.sendOT={type:"custom",data:t},this}keepAsRandom(t){return this.keepOT={type:"random",denominations:t},this}keepAsDeterministic(t=0,e){return this.keepOT={type:"deterministic",counter:t,denominations:e},this}keepAsP2PK(t,e){return this.keepOT={type:"p2pk",options:t,denominations:e},this}keepAsFactory(t,e){return this.keepOT={type:"factory",factory:t,denominations:e},this}keepAsCustom(t){return this.keepOT={type:"custom",data:t},this}includeFees(t=!0){return this.config.includeFees=t,this}keyset(t){return this.config.keysetId=t,this}proofsWeHave(t){return this.config.proofsWeHave=t,this}onCountersReserved(t){return this.config.onCountersReserved=t,this}offlineExactOnly(t=!1){return this.offlineExact={requireDleq:t},this}offlineCloseMatch(t=!1){return this.offlineClose={requireDleq:t},this}async run(){if((this.offlineExact||this.offlineClose)&&(this.sendOT||this.keepOT))throw new Error("Offline selection cannot be combined with custom output types. Remove send/keep output configuration, or use an online swap.");if(this.offlineExact)return this.wallet.sendOffline(this.amount,this.proofs,{includeFees:this.config.includeFees,exactMatch:!0,requireDleq:this.offlineExact.requireDleq});if(this.offlineClose)return this.wallet.sendOffline(this.amount,this.proofs,{includeFees:this.config.includeFees,exactMatch:!1,requireDleq:this.offlineClose.requireDleq});const t={send:this.sendOT??this.wallet.defaultOutputType(),...this.keepOT?{keep:this.keepOT}:{}};return this.wallet.send(this.amount,this.proofs,this.config,t)}}class pu{constructor(t,e){this.wallet=t,this.token=e,this.config={}}asRandom(t){return this.outputType={type:"random",denominations:t},this}asDeterministic(t=0,e){return this.outputType={type:"deterministic",counter:t,denominations:e},this}asP2PK(t,e){return this.outputType={type:"p2pk",options:t,denominations:e},this}asFactory(t,e){return this.outputType={type:"factory",factory:t,denominations:e},this}asCustom(t){return this.outputType={type:"custom",data:t},this}keyset(t){return this.config.keysetId=t,this}requireDleq(t=!0){return this.config.requireDleq=t,this}privkey(t){return this.config.privkey=t,this}proofsWeHave(t){return this.config.proofsWeHave=t,this}onCountersReserved(t){return this.config.onCountersReserved=t,this}async run(){return this.wallet.receive(this.token,this.config,this.outputType)}}class oo{constructor(t,e,r,i){this.wallet=t,this.method=e,this.amount=r,this.quote=i,this.config={},this._hasPrivkey}asRandom(t){return this.outputType={type:"random",denominations:t},this}asDeterministic(t=0,e){return this.outputType={type:"deterministic",counter:t,denominations:e},this}asP2PK(t,e){return this.outputType={type:"p2pk",options:t,denominations:e},this}asFactory(t,e){return this.outputType={type:"factory",factory:t,denominations:e},this}asCustom(t){return this.outputType={type:"custom",data:t},this}keyset(t){return this.config.keysetId=t,this}privkey(t){return this.config.privkey=t,this}proofsWeHave(t){return this.config.proofsWeHave=t,this}onCountersReserved(t){return this.config.onCountersReserved=t,this}async run(){if(this.method==="bolt11"){const e=this.quote;if(e.pubkey&&!this.config.privkey)throw new Error("privkey is required for locked BOLT11 mint quotes");return this.wallet.mintProofsBolt11(this.amount,e,this.config,this.outputType)}const t=this.quote;if(!this.config.privkey)throw new Error("privkey is required for BOLT12 mint quotes");return this.wallet.mintProofsBolt12(this.amount,t,this.config.privkey,this.config,this.outputType)}}class so{constructor(t,e,r,i){this.wallet=t,this.method=e,this.quote=r,this.proofs=i,this.config={}}asRandom(t){return this.outputType={type:"random",denominations:t},this}asDeterministic(t=0,e){return this.outputType={type:"deterministic",counter:t,denominations:e},this}asP2PK(t,e){return this.outputType={type:"p2pk",options:t,denominations:e},this}asFactory(t,e){return this.outputType={type:"factory",factory:t,denominations:e},this}asCustom(t){return this.outputType={type:"custom",data:t},this}keyset(t){return this.config.keysetId=t,this}onCountersReserved(t){return this.config.onCountersReserved=t,this}onChangeOutputsCreated(t){return this.config.onChangeOutputsCreated=t,this}async run(){return this.method==="bolt11"?this.wallet.meltProofsBolt11(this.quote,this.proofs,this.config,this.outputType):this.wallet.meltProofsBolt12(this.quote,this.proofs,this.config,this.outputType)}}function mu(n){const t=new WeakSet;try{return JSON.stringify(n,(e,r)=>{if(typeof r=="object"&&r!==null){if(t.has(r))return"[Circular]";t.add(r)}return r})}catch{return Object.prototype.toString.call(n)}}function ao(n){if(n instanceof Error)return n;const t=typeof n=="string"?n:mu(n),e=new Error(t);return e.cause=n,e}function uo(){const n=new Error("Aborted");return Object.defineProperty(n,"name",{value:"AbortError"}),n}function Ue(n){n&&Promise.resolve(n).then(t=>{try{t()}catch{}}).catch(()=>{})}class gu{constructor(t){this.wallet=t,this.countersReservedHandlers=new Set,this.meltBlanksHandlers=new Set}withAbort(t,e){if(!t)return e;if(t.aborted)return e(),()=>{};const r=()=>e();return t.addEventListener("abort",r,{once:!0}),()=>{t.removeEventListener("abort",r),e()}}waitUntilPaid(t,e,r,i="Timeout waiting for paid"){return new Promise((o,l)=>{let c=null,y=null;const M=S=>{Ue(c),y&&(clearTimeout(y),y=null),r?.signal&&r.signal.removeEventListener("abort",A),S&&l(ao(S))},A=()=>M(uo());if(r?.signal){if(r.signal.aborted)return A();r.signal.addEventListener("abort",A,{once:!0})}r?.timeoutMs&&r.timeoutMs>0&&(y=setTimeout(()=>M(new Error(i)),r.timeoutMs)),c=t(e,S=>{M(),o(S)},S=>M(S),{signal:r?.signal})})}countersReserved(t,e){this.countersReservedHandlers.add(t);const r=()=>this.countersReservedHandlers.delete(t);return this.withAbort(e?.signal,r)}_emitCountersReserved(t){for(const e of this.countersReservedHandlers)He(e,t,this.wallet.logger,{event:"countersReserved"})}meltBlanksCreated(t,e){this.meltBlanksHandlers.add(t);const r=()=>this.meltBlanksHandlers.delete(t);return this.withAbort(e?.signal,r)}_emitMeltBlanksCreated(t){for(const e of this.meltBlanksHandlers)He(e,t,this.wallet.logger,{event:"meltBlanksCreated"})}async mintQuoteUpdates(t,e,r,i){await this.wallet.mint.connectWebSocket();const o=this.wallet.mint.webSocketConnection;if(!o)throw new Error("Failed to establish WebSocket connection.");const l=Array.from(new Set(t)),c=o.createSubscription({kind:"bolt11_mint_quote",filters:l},e,r),y=()=>o.cancelSubscription(c,e);return this.withAbort(i?.signal,y)}async mintQuotePaid(t,e,r,i){return this.mintQuoteUpdates([t],o=>{o.state===Gr.PAID&&e(o)},r,i)}async meltQuoteUpdates(t,e,r,i){await this.wallet.mint.connectWebSocket();const o=this.wallet.mint.webSocketConnection;if(!o)throw new Error("Failed to establish WebSocket connection.");const l=Array.from(new Set(t)),c=o.createSubscription({kind:"bolt11_melt_quote",filters:l},e,r),y=()=>o.cancelSubscription(c,e);return this.withAbort(i?.signal,y)}async meltQuotePaid(t,e,r,i){return this.meltQuoteUpdates([t],o=>{o.state===De.PAID&&e(o)},r,i)}async proofStateUpdates(t,e,r,i){await this.wallet.mint.connectWebSocket();const o=this.wallet.mint.webSocketConnection;if(!o)throw new Error("Failed to establish WebSocket connection.");const l=new TextEncoder,c={};for(const B of t){const _=gr(l.encode(B.secret)).toHex(!0);c[_]=B}const y=Object.keys(c),M=B=>{e({...B,proof:c[B.Y]})},A=o.createSubscription({kind:"proof_state",filters:y},M,r),S=()=>o.cancelSubscription(A,M);return this.withAbort(i?.signal,S)}onceMintPaid(t,e){return this.waitUntilPaid(this.mintQuotePaid.bind(this),t,e,"Timeout waiting for mint paid")}onceAnyMintPaid(t,e){return new Promise((r,i)=>{const o=Array.from(new Set(t)),l=new Map;let c=null,y=null,M=!1;const A=B=>{for(const _ of l.values())Ue(_);l.clear(),c&&(clearTimeout(c),c=null),e?.signal&&e.signal.removeEventListener("abort",S),B&&i(ao(B))},S=()=>A(uo());if(e?.signal){if(e.signal.aborted)return S();e.signal.addEventListener("abort",S,{once:!0})}if(e?.timeoutMs&&e.timeoutMs>0&&(c=setTimeout(()=>A(new Error("Timeout waiting for any mint paid")),e.timeoutMs)),o.length===0)return A(new Error("No quote ids provided"));for(const B of o){const _=this.mintQuotePaid(B,P=>{A(),r({id:B,quote:P})},P=>{if(e?.failOnError){A(P);return}y=P;const T=l.get(B);T&&(Ue(T),l.delete(B)),M&&l.size===0&&A(y??new Error("No subscriptions remaining"))});l.set(B,_)}M=!0})}onceMeltPaid(t,e){return this.waitUntilPaid(this.meltQuotePaid.bind(this),t,e,"Timeout waiting for melt paid")}proofStatesStream(t,e){return(async function*(){const r=[];let i=!1,o=null;const l=e?.maxBuffer&&e.maxBuffer>0?e.maxBuffer:1/0,c=e?.drop??"oldest",y=()=>{const B=o;o=null,B&&B()},M=B=>{if(r.length>=l)if(c==="oldest"){const _=r.shift();if(_!==void 0)try{e?.onDrop?.(_)}catch{}r.push(B)}else{try{e?.onDrop?.(B)}catch{}return}else r.push(B);y()},A=this.proofStateUpdates(t,B=>{M(B)},()=>{i=!0,y()},{signal:e?.signal}),S=()=>{i=!0,y()};try{for(e?.signal&&(e.signal.aborted?S():e.signal.addEventListener("abort",S,{once:!0}));!i||r.length;){for(;r.length;)yield r.shift();if(i)break;await new Promise(B=>o=B)}}finally{Ue(A),e?.signal&&e.signal.removeEventListener("abort",S)}}).call(this)}group(){const t=[];let e=!1;const r=(()=>{if(!e)for(e=!0;t.length;)Ue(t.pop())});return r.add=i=>e?(Ue(i),i):(t.push(i),i),Object.defineProperty(r,"cancelled",{get:()=>e,enumerable:!0}),r}}class yu{constructor(t){this.src=t}async peekNext(t){return(await this.src.reserve(t,0)).start}async advanceToAtLeast(t,e){await this.src.advanceToAtLeast(t,e)}async setNext(t,e){if(typeof this.src.setNext=="function"){await this.src.setNext(t,e);return}throw new Error("CounterSource does not support setNext()")}async snapshot(){if(typeof this.src.snapshot=="function")return await this.src.snapshot();throw new Error("CounterSource does not support snapshot()")}}const fn={UNSPENT:"UNSPENT",PENDING:"PENDING",SPENT:"SPENT"},ln="__PENDING__";class dn{constructor(t,e){this._seed=void 0,this._unit="sat",this._mintInfo=void 0,this._denominationTarget=3,this._secretsPolicy="auto",this._boundKeysetId=ln,this.swap=this.send.bind(this),this.ops=new lu(this),this.on=new gu(this),this._logger=e?.logger??zt,this._selectProofs=e?.selectProofs??cu,this.mint=typeof t=="string"?new no(t,{authProvider:e?.authProvider,logger:this._logger}):t,this._unit=e?.unit??this._unit,this._boundKeysetId=e?.keysetId??this._boundKeysetId,e?.bip39seed&&(this.failIf(!(e.bip39seed instanceof Uint8Array),"bip39seed must be a valid Uint8Array",{bip39seed:e.bip39seed}),this._seed=e.bip39seed),this._secretsPolicy=e?.secretsPolicy??this._secretsPolicy,e?.counterSource?this._counterSource=e.counterSource:this._counterSource=new fu(e?.counterInit),this.counters=new yu(this._counterSource),this.keyChain=new ou(this.mint,this._unit,e?.keysets,e?.keys),this._mintInfo=e?.mintInfo?new an(e.mintInfo):this._mintInfo,this._denominationTarget=e?.denominationTarget??this._denominationTarget}fail(t,e){return pr(t,this._logger,e)}failIf(t,e,r){return Ki(t,e,this._logger,r)}failIfNullish(t,e,r){return Di(t,e,this._logger,r)}safeCallback(t,e,r){He(t,e,this._logger,r)}async loadMint(t){const e=[];if((!this._mintInfo||t)&&e.push(this.mint.getInfo().then(r=>(this._mintInfo=new an(r),null))),e.push(this.keyChain.init(t).then(()=>null)),await Promise.all(e),this._logger.debug("KeyChain",{keychain:this.keyChain.getCache()}),this._boundKeysetId===ln)this._boundKeysetId=this.keyChain.getCheapestKeyset().id;else{const r=this.keyChain.getKeyset(this._boundKeysetId);this.failIf(!r.hasKeys,"Wallet keyset has no keys after refresh",{keyset:r.id})}}get unit(){return this._unit}getMintInfo(){return this.failIfNullish(this._mintInfo,"Mint info not initialized; call loadMint first"),this._mintInfo}get keysetId(){return this.failIf(this._boundKeysetId===ln,"Wallet not initialised, call loadMint"),this._boundKeysetId}getKeyset(t){const e=this.keyChain.getKeyset(t??this.keysetId);return this.failIf(e.unit!==this._unit,"Keyset unit does not match wallet unit",{keyset:e.id,unit:e.unit,walletUnit:this._unit}),this.failIf(!e.hasKeys,"Keyset has no keys loaded",{keyset:e.id}),e}get logger(){return this._logger}async reserveFor(t,e){return e<=0?{start:0,count:0}:this._counterSource.reserve(t,e)}countersNeeded(t){return t.type!=="deterministic"||t.counter!==0?0:(t.denominations??[]).length}async addCountersToOutputTypes(t,...e){const r=e.reduce((y,M)=>y+this.countersNeeded(M),0);if(r===0)return{outputTypes:e};const i=await this.reserveFor(t,r);let o=i.start;const l=e.map(y=>{if(y.type==="deterministic"&&y.counter===0){const M=(y.denominations??[]).length;if(M>0){const A={...y,counter:o};return o+=M,A}}return y}),c={keysetId:t,start:i.start,count:i.count,next:i.start+i.count};return this.on._emitCountersReserved(c),{outputTypes:l,used:c}}bindKeyset(t){const e=this.keyChain.getKeyset(t);this.failIf(e.unit!==this._unit,"Keyset unit does not match wallet unit",{keyset:e.id,unit:e.unit,walletUnit:this._unit}),this.failIf(!e.hasKeys,"Keyset has no keys loaded",{keyset:e.id}),this._boundKeysetId=e.id,this._logger.debug("Wallet bound to keyset",{keysetId:e.id,unit:e.unit,feePPK:e.fee})}withKeyset(t,e){return new dn(this.mint,{keysetId:t,bip39seed:this._seed,secretsPolicy:this._secretsPolicy,logger:this._logger,counterSource:e?.counterSource??this._counterSource,...this.keyChain.getCache()})}defaultOutputType(){return this._secretsPolicy==="random"?{type:"random"}:this._secretsPolicy==="deterministic"?(this.failIfNullish(this._seed,"Deterministic policy requires a seed"),{type:"deterministic",counter:0}):this._seed?{type:"deterministic",counter:0}:{type:"random"}}configureOutputs(t,e,r,i=!1,o=[]){let l=t;if(r.type==="custom"){this.failIf(i,"The custom OutputType does not support automatic fee inclusion");const y=Zt.sumOutputAmounts(r.data);return this.failIf(y!==t,`Custom output data total (${y}) does not match amount (${t})`),r}let c=r.denominations??[];if(c.length===0&&o.length>0&&(c=$a(o,l,e.keys,this._denominationTarget)),c=se(l,e.keys,c),i){let y=this.getFeesForKeyset(c.length,e.id),M=se(y,e.keys);for(;this.getFeesForKeyset(c.length+M.length,e.id)>y;)y++,M=se(y,e.keys);l+=y,c=[...c,...M]}return{...r,denominations:c}}preparedTotal(t){return t.type==="custom"?Zt.sumOutputAmounts(t.data):(t.denominations??[]).reduce((e,r)=>e+r,0)}createOutputData(t,e,r){if(this.failIf(t<0,"Amount was negative",{amount:t}),r.type!="custom"&&r.denominations&&r.denominations.length>0){const o=r.denominations.reduce((l,c)=>l+c,0);this.failIf(o!==t,"Denominations do not sum to the expected amount",{splitSum:o,expected:t})}let i;switch(r.type){case"random":i=Zt.createRandomData(t,e,r.denominations);break;case"deterministic":this.failIfNullish(this._seed,"Deterministic outputs require a seed configured in the wallet"),i=Zt.createDeterministicData(t,this._seed,r.counter,e,r.denominations);break;case"p2pk":i=Zt.createP2PKData(r.options,t,e,r.denominations);break;case"factory":{i=se(t,e.keys,r.denominations).map(o=>r.factory(o,e));break}case"custom":{i=r.data;const o=Zt.sumOutputAmounts(i);this.failIf(o!==t,`Custom output data total (${o}) does not match amount (${t})`);break}default:this.fail("Invalid OutputType")}return i}createSwapTransaction(t,e,r=[]){t=this._prepareInputsForMint(t);const i=[...e,...r],o=i.map((A,S)=>S).sort((A,S)=>i[A].blindedMessage.amount-i[S].blindedMessage.amount),l=[...Array.from({length:e.length},()=>!0),...Array.from({length:r.length},()=>!1)],c=o.map(A=>i[A]),y=o.map(A=>l[A]),M=c.map(A=>A.blindedMessage);return this._logger.debug("createSwapTransaction:",{indices:o,sortedKeepVector:y}),{payload:{inputs:t,outputs:M},outputData:c,keepVector:y,sortedIndices:o}}async receive(t,e,r){const{keysetId:i,privkey:o,requireDleq:l,proofsWeHave:c,onCountersReserved:y}=e||{};r=r??this.defaultOutputType();const M=typeof t=="string"?this.decodeToken(t):t,A=to(M.mint);this.failIf(A!==this.mint.mintUrl,"Token belongs to a different mint",{token:A,wallet:this.mint.mintUrl}),this.failIf(M.unit!==this._unit,"Token is not in wallet unit",{token:M.unit,wallet:this._unit});let S=[];({proofs:S}=M);const B=We(S);if(B===0)return[];o&&(S=this.signP2PKProofs(S,o));const _=this.getKeyset(i);if(l)for(const Q of S){const z=this.keyChain.getKeyset(Q.id);tu(Q,z)||this.fail("Token contains proofs with invalid or missing DLEQ")}const P=B-this.getFeesForProofs(S);let T=this.configureOutputs(P,_,r,!1,c);const C=await this.addCountersToOutputTypes(_.id,T);[T]=C.outputTypes,C.used&&this.safeCallback(y,C.used,{op:"receive"}),this._logger.debug("receive counter",{counter:C.used,receiveOT:T});const N=this.createOutputData(this.preparedTotal(T),_,T),K=this.createSwapTransaction(S,N,[]),{signatures:R}=await this.mint.swap(K.payload),D=K.outputData.map((Q,z)=>Q.toProof(R[z],_)),$=[];return K.sortedIndices.forEach((Q,z)=>{$[Q]=D[z]}),this._logger.debug("RECEIVE COMPLETED",{amounts:$.map(Q=>Q.amount)}),$}sendOffline(t,e,r){const{requireDleq:i=!1,includeFees:o=!1,exactMatch:l=!0}=r||{};i&&(e=e.filter(A=>A.dleq!=null)),this.failIf(We(e)<t,"Not enough funds available to send");const{keep:c,send:y}=this.selectProofsToSend(e,t,o,l),M=this._prepareInputsForMint(y,i);return{keep:c,send:M}}async send(t,e,r,i){const{keysetId:o,includeFees:l=!1,onCountersReserved:c}=r||{};i=i??{send:this.defaultOutputType(),keep:this.defaultOutputType()};try{const s=this.defaultOutputType().type==="deterministic",h=x=>!x||x.type==="random"&&(!x.denominations||x.denominations.length===0);if(o||s||!h(i.send)||i.keep&&!h(i.keep)){const x=[];throw o&&x.push("keysetId override"),s&&x.push("wallet default is deterministic"),h(i.send)||x.push("non-default send output type"),i.keep&&!h(i.keep)&&x.push("non-default keep output type"),new Error(`Options require a swap: ${x.join(", ")}`)}const{keep:d,send:p}=this.sendOffline(t,e,{includeFees:l,exactMatch:!0,requireDleq:!1}),g=l?this.getFeesForProofs(p):0;if(We(p)===t+g)return this._logger.info("Successful exactMatch offline selection!"),{keep:d,send:p}}catch(s){const h=s instanceof Error?s.message:"Unknown error";this._logger.debug("ExactMatch offline selection failed.",{e:h})}const y=this.getKeyset(o);let M=this.configureOutputs(t,y,i.send??this.defaultOutputType(),l);const A=this.preparedTotal(M),{keep:S,send:B}=this.selectProofsToSend(e,A,!0);if(B.length===0)throw new Error("Not enough funds available to send");const _=We(B),P=this.getFeesForProofs(B),T=_-P-A;this.failIf(T<0,"Not enough funds available for swap",{selectedSum:_,swapFee:P,sendAmount:A,changeAmount:T});let C=this.configureOutputs(T,y,i.keep??this.defaultOutputType(),!1,r?.proofsWeHave);const N=this.preparedTotal(C),K=await this.addCountersToOutputTypes(y.id,M,C);[M,C]=K.outputTypes,K.used&&this.safeCallback(c,K.used,{op:"send"}),this._logger.debug("send counters",{counter:K.used,sendOT:M,keepOT:C});const R=this.createOutputData(A,y,M),D=this.createOutputData(N,y,C),$=this.createSwapTransaction(B,D,R),{signatures:Q}=await this.mint.swap($.payload),z=$.outputData.map((s,h)=>s.toProof(Q[h],y)),L=Array(z.length),O=Array($.keepVector.length);$.sortedIndices.forEach((s,h)=>{O[s]=$.keepVector[h],L[s]=z[h]});const j=[],E=[];return L.forEach((s,h)=>{O[h]?j.push(s):E.push(s)}),this._logger.debug("SEND COMPLETED",{unselectedProofs:S.map(s=>s.amount),keepProofs:j.map(s=>s.amount),sendProofs:E.map(s=>s.amount)}),{keep:[...j,...S],send:E}}selectProofsToSend(t,e,r=!1,i=!1){const{keep:o,send:l}=this._selectProofs(t,e,this.keyChain,r,i);return{keep:o,send:l}}signP2PKProofs(t,e){return ka(t,e)}getFeesForProofs(t){const e=t.reduce((r,i)=>r+this.getProofFeePPK(i),0);return Math.ceil(e/1e3)}getProofFeePPK(t){try{return this.keyChain.getKeyset(t.id).fee}catch(e){this.fail(`Could not get fee. No keyset found for keyset id: ${t.id}`,{e,keychain:this.keyChain.getKeysets()})}}getFeesForKeyset(t,e){try{const r=this.keyChain.getKeyset(e).fee;return Math.floor(Math.max((t*r+999)/1e3,0))}catch(r){this.fail(`No keyset found with ID ${e}`,{e:r})}}_prepareInputsForMint(t,e=!1){return t.map(r=>{const i=r.witness&&typeof r.witness!="string"?JSON.stringify(r.witness):r.witness,{dleq:o,p2pk_e:l,...c}=r;return e&&o?{...c,dleq:o,witness:i}:{...c,witness:i}})}decodeToken(t){const e=this.keyChain.getKeysets();return Ji(t,e)}async batchRestore(t=300,e=100,r=0,i){const o=Math.ceil(t/e),l=[];let c,y=0;for(;y<o;){const M=await this.restore(r,e,{keysetId:i});M.proofs.length>0?(y=0,l.push(...M.proofs),c=M.lastCounterWithSignature):y++,r+=e}return{proofs:l,lastCounterWithSignature:c}}async restore(t,e,r){const{keysetId:i}=r||{},o=this.getKeyset(i);this.failIfNullish(this._seed,"Cashu Wallet must be initialized with a seed to use restore");const l=Array(e).fill(0),c=Zt.createDeterministicData(0,this._seed,t,o,l),{outputs:y,signatures:M}=await this.mint.restore({outputs:c.map(_=>_.blindedMessage)}),A={};y.forEach((_,P)=>A[_.B_]=M[P]);const S=[];let B;for(let _=0;_<c.length;_++){const P=A[c[_].blindedMessage.B_];P&&(B=t+_,c[_].blindedMessage.amount=P.amount,S.push(c[_].toProof(P,o)))}return{proofs:S,lastCounterWithSignature:B}}async createMintQuote(t,e){return this.createMintQuoteBolt11(t,e)}async createMintQuoteBolt11(t,e){e&&(this.getMintInfo().supportsNut04Description("bolt11",this._unit)||this.fail("Mint does not support description for bolt11"));const r={unit:this._unit,amount:t,description:e},i=await this.mint.createMintQuoteBolt11(r);return{...i,amount:i.amount||t,unit:i.unit||this._unit}}async createLockedMintQuote(t,e,r){const{supported:i}=this.getMintInfo().isSupported(20);this.failIf(!i,"Mint does not support NUT-20");const o={unit:this._unit,amount:t,description:r,pubkey:e},l=await this.mint.createMintQuoteBolt11(o);this.failIf(typeof l.pubkey!="string","Mint returned unlocked mint quote");const c=l.pubkey;return{...l,pubkey:c,amount:l.amount||t,unit:l.unit||this._unit}}async createMintQuoteBolt12(t,e){const r=this.getMintInfo();e?.description&&!r.supportsNut04Description("bolt12",this._unit)&&this.fail("Mint does not support description for bolt12");const i={pubkey:t,unit:this._unit,amount:e?.amount,description:e?.description};return this.mint.createMintQuoteBolt12(i)}async checkMintQuote(t){return this.checkMintQuoteBolt11(t)}async checkMintQuoteBolt11(t){const e=typeof t=="string"?t:t.quote,r=await this.mint.checkMintQuoteBolt11(e);return typeof t=="string"?r:{...r,amount:r.amount||t.amount,unit:r.unit||t.unit}}async checkMintQuoteBolt12(t){return this.mint.checkMintQuoteBolt12(t)}async mintProofs(t,e,r,i){return this._mintProofs("bolt11",t,e,r,i)}async mintProofsBolt11(t,e,r,i){return this._mintProofs("bolt11",t,e,r,i)}async mintProofsBolt12(t,e,r,i,o){return this._mintProofs("bolt12",t,e,{...i,privkey:r},o)}async _mintProofs(t,e,r,i,o){o=o??this.defaultOutputType();const{privkey:l,keysetId:c,proofsWeHave:y,onCountersReserved:M}=i??{};this.failIf(e<=0,"Invalid mint amount: must be positive",{amount:e});const A=this.getKeyset(c);let S=this.configureOutputs(e,A,o,!1,y);const B=this.preparedTotal(S),_=await this.addCountersToOutputTypes(A.id,S);[S]=_.outputTypes,_.used&&this.safeCallback(M,_.used,{op:"mintProofs"}),this._logger.debug("mint counter",{counter:_.used,mintOT:S});const P=this.createOutputData(B,A,S),T=P.map(K=>K.blindedMessage),C={outputs:T,quote:typeof r=="string"?r:r.quote};if(typeof r!="string"&&r.pubkey){this.failIf(!l,"Can not sign locked quote without private key");const K=Ha(l,r.quote,T);C.signature=K}let N;return t==="bolt12"?{signatures:N}=await this.mint.mintBolt12(C):{signatures:N}=await this.mint.mintBolt11(C),this.failIf(N.length!==P.length,`Mint returned ${N.length} signatures, expected ${P.length}`),this._logger.debug("MINT COMPLETED",{amounts:P.map(K=>K.blindedMessage.amount)}),P.map((K,R)=>K.toProof(N[R],A))}async createMeltQuote(t){return this.createMeltQuoteBolt11(t)}async createMeltQuoteBolt11(t){const e={unit:this._unit,request:t},r=await this.mint.createMeltQuoteBolt11(e);return{...r,unit:r.unit||this._unit,request:r.request||t}}async createMeltQuoteBolt12(t,e){return this.mint.createMeltQuoteBolt12({unit:this._unit,request:t,options:e?{amountless:{amount_msat:e}}:void 0})}async createMultiPathMeltQuote(t,e){const{supported:r,params:i}=this.getMintInfo().isSupported(15);this.failIf(!r,"Mint does not support NUT-15"),this.failIf(!i?.some(c=>c.method==="bolt11"&&c.unit===this._unit),`Mint does not support MPP for bolt11 and ${this._unit}`);const o={mpp:{amount:e}},l={unit:this._unit,request:t,options:o};return{...await this.mint.createMeltQuoteBolt11(l),request:t,unit:this._unit}}async checkMeltQuote(t){return this.checkMeltQuoteBolt11(t)}async checkMeltQuoteBolt11(t){const e=typeof t=="string"?t:t.quote,r=await this.mint.checkMeltQuoteBolt11(e);return typeof t=="string"?r:{...r,request:t.request,unit:t.unit}}async checkMeltQuoteBolt12(t){return this.mint.checkMeltQuoteBolt12(t)}async meltProofs(t,e,r,i){return this._meltProofs("bolt11",t,e,r,i)}async meltProofsBolt11(t,e,r,i){return this._meltProofs("bolt11",t,e,r,i)}async meltProofsBolt12(t,e,r,i){return this._meltProofs("bolt12",t,e,r,i)}async _meltProofs(t,e,r,i,o){o=o??this.defaultOutputType();const{keysetId:l,onChangeOutputsCreated:c,onCountersReserved:y}=i||{},M=this.getKeyset(l),A=We(r),S=A-e.amount;let B=[];if(this.failIf(S<0,"Not enough proofs to cover amount + fee reserve",{sendAmount:A,quoteAmount:e.amount}),S>0){let N=Math.ceil(Math.log2(S))||1;N<0&&(N=0);const K=N?new Array(N).fill(0):[];this._logger.debug("Creating NUT-08 blanks for fee reserve",{feeReserve:S,denominations:K}),o.type==="custom"&&this.fail("Custom OutputType not supported for melt change (must be 0-sat blanks)");let R={...o,denominations:K};const D=await this.addCountersToOutputTypes(M.id,R);[R]=D.outputTypes,D.used&&this.safeCallback(y,D.used,{op:"meltProofs"}),this._logger.debug("melt counter",{counter:D.used,meltOT:R}),B=this.createOutputData(0,M,R)}r=this._prepareInputsForMint(r);const _={quote:e.quote,inputs:r,outputs:B.map(N=>N.blindedMessage)};if(B.length>0){const N={method:t,payload:_,outputData:B,keyset:M,quote:e};this.safeCallback(c,N,{op:"meltProofs"}),this.on._emitMeltBlanksCreated(N)}let P;const T=typeof c=="function";t==="bolt12"?P=await this.mint.meltBolt12(_,{preferAsync:T}):P=await this.mint.meltBolt11(_,{preferAsync:T}),this.failIf((P.change?.length??0)>B.length,`Mint returned ${P.change?.length??0} signatures, but only ${B.length} blanks were provided`);const C=P.change?.map((N,K)=>B[K].toProof(N,M))??[];return this._logger.debug("MELT COMPLETED",{changeAmounts:C.map(N=>N.amount)}),{quote:{...P,unit:e.unit,request:e.request},change:C}}async completeMelt(t){const e=t.method==="bolt12"?await this.mint.meltBolt12(t.payload):await this.mint.meltBolt11(t.payload);this.failIf((e.change?.length??0)>t.outputData.length,`Mint returned ${e.change?.length??0} signatures, but only ${t.outputData.length} blanks were provided`);const r=e.change?.map((i,o)=>t.outputData[o].toProof(i,t.keyset))??[];return this._logger.debug("COMPLETE MELT",{changeAmounts:r.map(i=>i.amount)}),{quote:{...e,unit:t.quote.unit,request:t.quote.request},change:r}}async checkProofsStates(t){const e=new TextEncoder,r=t.map(l=>gr(e.encode(l.secret)).toHex(!0)),i=100,o=[];for(let l=0;l<r.length;l+=i){const c=r.slice(l,l+i),{states:y}=await this.mint.check({Ys:c}),M={};y.forEach(A=>{M[A.Y]=A});for(let A=0;A<c.length;A++){const S=M[c[A]];this.failIfNullish(S,"Could not find state for proof with Y: "+c[A]),o.push(S)}}return o}async groupProofsByState(t){const e=await this.checkProofsStates(t),r={unspent:[],pending:[],spent:[]};for(let i=0;i<e.length;i++){const o=t[i];switch(e[i].state){case fn.UNSPENT:r.unspent.push(o);break;case fn.PENDING:r.pending.push(o);break;case fn.SPENT:r.spent.push(o);break}}return r}}function wu(n){if(Object.prototype.hasOwnProperty.call(n,"__esModule"))return n;var t=n.default;if(typeof t=="function"){var e=function r(){var i=!1;try{i=this instanceof r}catch{}return i?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(n).forEach(function(r){var i=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return n[r]}})}),e}var pn,ho;function vu(){if(ho)return pn;ho=1;for(var n="qpzry9x8gf2tvdw0s3jn54khce6mua7l",t={},e=0;e<n.length;e++){var r=n.charAt(e);if(t[r]!==void 0)throw new TypeError(r+" is ambiguous");t[r]=e}function i(T){var C=T>>25;return(T&33554431)<<5^-(C>>0&1)&996825010^-(C>>1&1)&642813549^-(C>>2&1)&513874426^-(C>>3&1)&1027748829^-(C>>4&1)&705979059}function o(T){for(var C=1,N=0;N<T.length;++N){var K=T.charCodeAt(N);if(K<33||K>126)return"Invalid prefix ("+T+")";C=i(C)^K>>5}for(C=i(C),N=0;N<T.length;++N){var R=T.charCodeAt(N);C=i(C)^R&31}return C}function l(T,C,N){if(N=N||90,T.length+7+C.length>N)throw new TypeError("Exceeds length limit");T=T.toLowerCase();var K=o(T);if(typeof K=="string")throw new Error(K);for(var R=T+"1",D=0;D<C.length;++D){var $=C[D];if($>>5!==0)throw new Error("Non 5-bit word");K=i(K)^$,R+=n.charAt($)}for(D=0;D<6;++D)K=i(K);for(K^=1,D=0;D<6;++D){var Q=K>>(5-D)*5&31;R+=n.charAt(Q)}return R}function c(T,C){if(C=C||90,T.length<8)return T+" too short";if(T.length>C)return"Exceeds length limit";var N=T.toLowerCase(),K=T.toUpperCase();if(T!==N&&T!==K)return"Mixed-case string "+T;T=N;var R=T.lastIndexOf("1");if(R===-1)return"No separator character for "+T;if(R===0)return"Missing prefix for "+T;var D=T.slice(0,R),$=T.slice(R+1);if($.length<6)return"Data too short";var Q=o(D);if(typeof Q=="string")return Q;for(var z=[],L=0;L<$.length;++L){var O=$.charAt(L),j=t[O];if(j===void 0)return"Unknown character "+O;Q=i(Q)^j,!(L+6>=$.length)&&z.push(j)}return Q!==1?"Invalid checksum for "+T:{prefix:D,words:z}}function y(){var T=c.apply(null,arguments);if(typeof T=="object")return T}function M(T){var C=c.apply(null,arguments);if(typeof C=="object")return C;throw new Error(C)}function A(T,C,N,K){for(var R=0,D=0,$=(1<<N)-1,Q=[],z=0;z<T.length;++z)for(R=R<<C|T[z],D+=C;D>=N;)D-=N,Q.push(R>>D&$);if(K)D>0&&Q.push(R<<N-D&$);else{if(D>=C)return"Excess padding";if(R<<N-D&$)return"Non-zero padding"}return Q}function S(T){var C=A(T,8,5,!0);if(Array.isArray(C))return C}function B(T){var C=A(T,8,5,!0);if(Array.isArray(C))return C;throw new Error(C)}function _(T){var C=A(T,5,8,!1);if(Array.isArray(C))return C}function P(T){var C=A(T,5,8,!1);if(Array.isArray(C))return C;throw new Error(C)}return pn={decodeUnsafe:y,decode:M,encode:l,toWordsUnsafe:S,toWords:B,fromWordsUnsafe:_,fromWords:P},pn}var co=vu(),mn={},ze={},fo;function bu(){if(fo)return ze;fo=1,ze.byteLength=c,ze.toByteArray=M,ze.fromByteArray=B;for(var n=[],t=[],e=typeof Uint8Array<"u"?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,o=r.length;i<o;++i)n[i]=r[i],t[r.charCodeAt(i)]=i;t[45]=62,t[95]=63;function l(_){var P=_.length;if(P%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var T=_.indexOf("=");T===-1&&(T=P);var C=T===P?0:4-T%4;return[T,C]}function c(_){var P=l(_),T=P[0],C=P[1];return(T+C)*3/4-C}function y(_,P,T){return(P+T)*3/4-T}function M(_){var P,T=l(_),C=T[0],N=T[1],K=new e(y(_,C,N)),R=0,D=N>0?C-4:C,$;for($=0;$<D;$+=4)P=t[_.charCodeAt($)]<<18|t[_.charCodeAt($+1)]<<12|t[_.charCodeAt($+2)]<<6|t[_.charCodeAt($+3)],K[R++]=P>>16&255,K[R++]=P>>8&255,K[R++]=P&255;return N===2&&(P=t[_.charCodeAt($)]<<2|t[_.charCodeAt($+1)]>>4,K[R++]=P&255),N===1&&(P=t[_.charCodeAt($)]<<10|t[_.charCodeAt($+1)]<<4|t[_.charCodeAt($+2)]>>2,K[R++]=P>>8&255,K[R++]=P&255),K}function A(_){return n[_>>18&63]+n[_>>12&63]+n[_>>6&63]+n[_&63]}function S(_,P,T){for(var C,N=[],K=P;K<T;K+=3)C=(_[K]<<16&16711680)+(_[K+1]<<8&65280)+(_[K+2]&255),N.push(A(C));return N.join("")}function B(_){for(var P,T=_.length,C=T%3,N=[],K=16383,R=0,D=T-C;R<D;R+=K)N.push(S(_,R,R+K>D?D:R+K));return C===1?(P=_[T-1],N.push(n[P>>2]+n[P<<4&63]+"==")):C===2&&(P=(_[T-2]<<8)+_[T-1],N.push(n[P>>10]+n[P>>4&63]+n[P<<2&63]+"=")),N.join("")}return ze}var yr={};var lo;function xu(){return lo||(lo=1,yr.read=function(n,t,e,r,i){var o,l,c=i*8-r-1,y=(1<<c)-1,M=y>>1,A=-7,S=e?i-1:0,B=e?-1:1,_=n[t+S];for(S+=B,o=_&(1<<-A)-1,_>>=-A,A+=c;A>0;o=o*256+n[t+S],S+=B,A-=8);for(l=o&(1<<-A)-1,o>>=-A,A+=r;A>0;l=l*256+n[t+S],S+=B,A-=8);if(o===0)o=1-M;else{if(o===y)return l?NaN:(_?-1:1)*(1/0);l=l+Math.pow(2,r),o=o-M}return(_?-1:1)*l*Math.pow(2,o-r)},yr.write=function(n,t,e,r,i,o){var l,c,y,M=o*8-i-1,A=(1<<M)-1,S=A>>1,B=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,_=r?0:o-1,P=r?1:-1,T=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(c=isNaN(t)?1:0,l=A):(l=Math.floor(Math.log(t)/Math.LN2),t*(y=Math.pow(2,-l))<1&&(l--,y*=2),l+S>=1?t+=B/y:t+=B*Math.pow(2,1-S),t*y>=2&&(l++,y/=2),l+S>=A?(c=0,l=A):l+S>=1?(c=(t*y-1)*Math.pow(2,i),l=l+S):(c=t*Math.pow(2,S-1)*Math.pow(2,i),l=0));i>=8;n[e+_]=c&255,_+=P,c/=256,i-=8);for(l=l<<i|c,M+=i;M>0;n[e+_]=l&255,_+=P,l/=256,M-=8);n[e+_-P]|=T*128}),yr}var po;function Eu(){return po||(po=1,(function(n){const t=bu(),e=xu(),r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;n.Buffer=c,n.SlowBuffer=K,n.INSPECT_MAX_BYTES=50;const i=2147483647;n.kMaxLength=i,c.TYPED_ARRAY_SUPPORT=o(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function o(){try{const m=new Uint8Array(1),a={foo:function(){return 42}};return Object.setPrototypeOf(a,Uint8Array.prototype),Object.setPrototypeOf(m,a),m.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function l(m){if(m>i)throw new RangeError('The value "'+m+'" is invalid for option "size"');const a=new Uint8Array(m);return Object.setPrototypeOf(a,c.prototype),a}function c(m,a,f){if(typeof m=="number"){if(typeof a=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return S(m)}return y(m,a,f)}c.poolSize=8192;function y(m,a,f){if(typeof m=="string")return B(m,a);if(ArrayBuffer.isView(m))return P(m);if(m==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof m);if(nt(m,ArrayBuffer)||m&&nt(m.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(nt(m,SharedArrayBuffer)||m&&nt(m.buffer,SharedArrayBuffer)))return T(m,a,f);if(typeof m=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const b=m.valueOf&&m.valueOf();if(b!=null&&b!==m)return c.from(b,a,f);const I=C(m);if(I)return I;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof m[Symbol.toPrimitive]=="function")return c.from(m[Symbol.toPrimitive]("string"),a,f);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof m)}c.from=function(m,a,f){return y(m,a,f)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function M(m){if(typeof m!="number")throw new TypeError('"size" argument must be of type number');if(m<0)throw new RangeError('The value "'+m+'" is invalid for option "size"')}function A(m,a,f){return M(m),m<=0?l(m):a!==void 0?typeof f=="string"?l(m).fill(a,f):l(m).fill(a):l(m)}c.alloc=function(m,a,f){return A(m,a,f)};function S(m){return M(m),l(m<0?0:N(m)|0)}c.allocUnsafe=function(m){return S(m)},c.allocUnsafeSlow=function(m){return S(m)};function B(m,a){if((typeof a!="string"||a==="")&&(a="utf8"),!c.isEncoding(a))throw new TypeError("Unknown encoding: "+a);const f=R(m,a)|0;let b=l(f);const I=b.write(m,a);return I!==f&&(b=b.slice(0,I)),b}function _(m){const a=m.length<0?0:N(m.length)|0,f=l(a);for(let b=0;b<a;b+=1)f[b]=m[b]&255;return f}function P(m){if(nt(m,Uint8Array)){const a=new Uint8Array(m);return T(a.buffer,a.byteOffset,a.byteLength)}return _(m)}function T(m,a,f){if(a<0||m.byteLength<a)throw new RangeError('"offset" is outside of buffer bounds');if(m.byteLength<a+(f||0))throw new RangeError('"length" is outside of buffer bounds');let b;return a===void 0&&f===void 0?b=new Uint8Array(m):f===void 0?b=new Uint8Array(m,a):b=new Uint8Array(m,a,f),Object.setPrototypeOf(b,c.prototype),b}function C(m){if(c.isBuffer(m)){const a=N(m.length)|0,f=l(a);return f.length===0||m.copy(f,0,0,a),f}if(m.length!==void 0)return typeof m.length!="number"||Fe(m.length)?l(0):_(m);if(m.type==="Buffer"&&Array.isArray(m.data))return _(m.data)}function N(m){if(m>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return m|0}function K(m){return+m!=m&&(m=0),c.alloc(+m)}c.isBuffer=function(a){return a!=null&&a._isBuffer===!0&&a!==c.prototype},c.compare=function(a,f){if(nt(a,Uint8Array)&&(a=c.from(a,a.offset,a.byteLength)),nt(f,Uint8Array)&&(f=c.from(f,f.offset,f.byteLength)),!c.isBuffer(a)||!c.isBuffer(f))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(a===f)return 0;let b=a.length,I=f.length;for(let U=0,q=Math.min(b,I);U<q;++U)if(a[U]!==f[U]){b=a[U],I=f[U];break}return b<I?-1:I<b?1:0},c.isEncoding=function(a){switch(String(a).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(a,f){if(!Array.isArray(a))throw new TypeError('"list" argument must be an Array of Buffers');if(a.length===0)return c.alloc(0);let b;if(f===void 0)for(f=0,b=0;b<a.length;++b)f+=a[b].length;const I=c.allocUnsafe(f);let U=0;for(b=0;b<a.length;++b){let q=a[b];if(nt(q,Uint8Array))U+q.length>I.length?(c.isBuffer(q)||(q=c.from(q)),q.copy(I,U)):Uint8Array.prototype.set.call(I,q,U);else if(c.isBuffer(q))q.copy(I,U);else throw new TypeError('"list" argument must be an Array of Buffers');U+=q.length}return I};function R(m,a){if(c.isBuffer(m))return m.length;if(ArrayBuffer.isView(m)||nt(m,ArrayBuffer))return m.byteLength;if(typeof m!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof m);const f=m.length,b=arguments.length>2&&arguments[2]===!0;if(!b&&f===0)return 0;let I=!1;for(;;)switch(a){case"ascii":case"latin1":case"binary":return f;case"utf8":case"utf-8":return qe(m).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return f*2;case"hex":return f>>>1;case"base64":return Ge(m).length;default:if(I)return b?-1:qe(m).length;a=(""+a).toLowerCase(),I=!0}}c.byteLength=R;function D(m,a,f){let b=!1;if((a===void 0||a<0)&&(a=0),a>this.length||((f===void 0||f>this.length)&&(f=this.length),f<=0)||(f>>>=0,a>>>=0,f<=a))return"";for(m||(m="utf8");;)switch(m){case"hex":return w(this,a,f);case"utf8":case"utf-8":return d(this,a,f);case"ascii":return x(this,a,f);case"latin1":case"binary":return k(this,a,f);case"base64":return h(this,a,f);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return u(this,a,f);default:if(b)throw new TypeError("Unknown encoding: "+m);m=(m+"").toLowerCase(),b=!0}}c.prototype._isBuffer=!0;function $(m,a,f){const b=m[a];m[a]=m[f],m[f]=b}c.prototype.swap16=function(){const a=this.length;if(a%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let f=0;f<a;f+=2)$(this,f,f+1);return this},c.prototype.swap32=function(){const a=this.length;if(a%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let f=0;f<a;f+=4)$(this,f,f+3),$(this,f+1,f+2);return this},c.prototype.swap64=function(){const a=this.length;if(a%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let f=0;f<a;f+=8)$(this,f,f+7),$(this,f+1,f+6),$(this,f+2,f+5),$(this,f+3,f+4);return this},c.prototype.toString=function(){const a=this.length;return a===0?"":arguments.length===0?d(this,0,a):D.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(a){if(!c.isBuffer(a))throw new TypeError("Argument must be a Buffer");return this===a?!0:c.compare(this,a)===0},c.prototype.inspect=function(){let a="";const f=n.INSPECT_MAX_BYTES;return a=this.toString("hex",0,f).replace(/(.{2})/g,"$1 ").trim(),this.length>f&&(a+=" ... "),"<Buffer "+a+">"},r&&(c.prototype[r]=c.prototype.inspect),c.prototype.compare=function(a,f,b,I,U){if(nt(a,Uint8Array)&&(a=c.from(a,a.offset,a.byteLength)),!c.isBuffer(a))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof a);if(f===void 0&&(f=0),b===void 0&&(b=a?a.length:0),I===void 0&&(I=0),U===void 0&&(U=this.length),f<0||b>a.length||I<0||U>this.length)throw new RangeError("out of range index");if(I>=U&&f>=b)return 0;if(I>=U)return-1;if(f>=b)return 1;if(f>>>=0,b>>>=0,I>>>=0,U>>>=0,this===a)return 0;let q=U-I,V=b-f;const lt=Math.min(q,V),J=this.slice(I,U),et=a.slice(f,b);for(let st=0;st<lt;++st)if(J[st]!==et[st]){q=J[st],V=et[st];break}return q<V?-1:V<q?1:0};function Q(m,a,f,b,I){if(m.length===0)return-1;if(typeof f=="string"?(b=f,f=0):f>2147483647?f=2147483647:f<-2147483648&&(f=-2147483648),f=+f,Fe(f)&&(f=I?0:m.length-1),f<0&&(f=m.length+f),f>=m.length){if(I)return-1;f=m.length-1}else if(f<0)if(I)f=0;else return-1;if(typeof a=="string"&&(a=c.from(a,b)),c.isBuffer(a))return a.length===0?-1:z(m,a,f,b,I);if(typeof a=="number")return a=a&255,typeof Uint8Array.prototype.indexOf=="function"?I?Uint8Array.prototype.indexOf.call(m,a,f):Uint8Array.prototype.lastIndexOf.call(m,a,f):z(m,[a],f,b,I);throw new TypeError("val must be string, number or Buffer")}function z(m,a,f,b,I){let U=1,q=m.length,V=a.length;if(b!==void 0&&(b=String(b).toLowerCase(),b==="ucs2"||b==="ucs-2"||b==="utf16le"||b==="utf-16le")){if(m.length<2||a.length<2)return-1;U=2,q/=2,V/=2,f/=2}function lt(et,st){return U===1?et[st]:et.readUInt16BE(st*U)}let J;if(I){let et=-1;for(J=f;J<q;J++)if(lt(m,J)===lt(a,et===-1?0:J-et)){if(et===-1&&(et=J),J-et+1===V)return et*U}else et!==-1&&(J-=J-et),et=-1}else for(f+V>q&&(f=q-V),J=f;J>=0;J--){let et=!0;for(let st=0;st<V;st++)if(lt(m,J+st)!==lt(a,st)){et=!1;break}if(et)return J}return-1}c.prototype.includes=function(a,f,b){return this.indexOf(a,f,b)!==-1},c.prototype.indexOf=function(a,f,b){return Q(this,a,f,b,!0)},c.prototype.lastIndexOf=function(a,f,b){return Q(this,a,f,b,!1)};function L(m,a,f,b){f=Number(f)||0;const I=m.length-f;b?(b=Number(b),b>I&&(b=I)):b=I;const U=a.length;b>U/2&&(b=U/2);let q;for(q=0;q<b;++q){const V=parseInt(a.substr(q*2,2),16);if(Fe(V))return q;m[f+q]=V}return q}function O(m,a,f,b){return ft(qe(a,m.length-f),m,f,b)}function j(m,a,f,b){return ft(gt(a),m,f,b)}function E(m,a,f,b){return ft(Ge(a),m,f,b)}function s(m,a,f,b){return ft(yt(a,m.length-f),m,f,b)}c.prototype.write=function(a,f,b,I){if(f===void 0)I="utf8",b=this.length,f=0;else if(b===void 0&&typeof f=="string")I=f,b=this.length,f=0;else if(isFinite(f))f=f>>>0,isFinite(b)?(b=b>>>0,I===void 0&&(I="utf8")):(I=b,b=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const U=this.length-f;if((b===void 0||b>U)&&(b=U),a.length>0&&(b<0||f<0)||f>this.length)throw new RangeError("Attempt to write outside buffer bounds");I||(I="utf8");let q=!1;for(;;)switch(I){case"hex":return L(this,a,f,b);case"utf8":case"utf-8":return O(this,a,f,b);case"ascii":case"latin1":case"binary":return j(this,a,f,b);case"base64":return E(this,a,f,b);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return s(this,a,f,b);default:if(q)throw new TypeError("Unknown encoding: "+I);I=(""+I).toLowerCase(),q=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function h(m,a,f){return a===0&&f===m.length?t.fromByteArray(m):t.fromByteArray(m.slice(a,f))}function d(m,a,f){f=Math.min(m.length,f);const b=[];let I=a;for(;I<f;){const U=m[I];let q=null,V=U>239?4:U>223?3:U>191?2:1;if(I+V<=f){let lt,J,et,st;switch(V){case 1:U<128&&(q=U);break;case 2:lt=m[I+1],(lt&192)===128&&(st=(U&31)<<6|lt&63,st>127&&(q=st));break;case 3:lt=m[I+1],J=m[I+2],(lt&192)===128&&(J&192)===128&&(st=(U&15)<<12|(lt&63)<<6|J&63,st>2047&&(st<55296||st>57343)&&(q=st));break;case 4:lt=m[I+1],J=m[I+2],et=m[I+3],(lt&192)===128&&(J&192)===128&&(et&192)===128&&(st=(U&15)<<18|(lt&63)<<12|(J&63)<<6|et&63,st>65535&&st<1114112&&(q=st))}}q===null?(q=65533,V=1):q>65535&&(q-=65536,b.push(q>>>10&1023|55296),q=56320|q&1023),b.push(q),I+=V}return g(b)}const p=4096;function g(m){const a=m.length;if(a<=p)return String.fromCharCode.apply(String,m);let f="",b=0;for(;b<a;)f+=String.fromCharCode.apply(String,m.slice(b,b+=p));return f}function x(m,a,f){let b="";f=Math.min(m.length,f);for(let I=a;I<f;++I)b+=String.fromCharCode(m[I]&127);return b}function k(m,a,f){let b="";f=Math.min(m.length,f);for(let I=a;I<f;++I)b+=String.fromCharCode(m[I]);return b}function w(m,a,f){const b=m.length;(!a||a<0)&&(a=0),(!f||f<0||f>b)&&(f=b);let I="";for(let U=a;U<f;++U)I+=wt[m[U]];return I}function u(m,a,f){const b=m.slice(a,f);let I="";for(let U=0;U<b.length-1;U+=2)I+=String.fromCharCode(b[U]+b[U+1]*256);return I}c.prototype.slice=function(a,f){const b=this.length;a=~~a,f=f===void 0?b:~~f,a<0?(a+=b,a<0&&(a=0)):a>b&&(a=b),f<0?(f+=b,f<0&&(f=0)):f>b&&(f=b),f<a&&(f=a);const I=this.subarray(a,f);return Object.setPrototypeOf(I,c.prototype),I};function v(m,a,f){if(m%1!==0||m<0)throw new RangeError("offset is not uint");if(m+a>f)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(a,f,b){a=a>>>0,f=f>>>0,b||v(a,f,this.length);let I=this[a],U=1,q=0;for(;++q<f&&(U*=256);)I+=this[a+q]*U;return I},c.prototype.readUintBE=c.prototype.readUIntBE=function(a,f,b){a=a>>>0,f=f>>>0,b||v(a,f,this.length);let I=this[a+--f],U=1;for(;f>0&&(U*=256);)I+=this[a+--f]*U;return I},c.prototype.readUint8=c.prototype.readUInt8=function(a,f){return a=a>>>0,f||v(a,1,this.length),this[a]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(a,f){return a=a>>>0,f||v(a,2,this.length),this[a]|this[a+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(a,f){return a=a>>>0,f||v(a,2,this.length),this[a]<<8|this[a+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(a,f){return a=a>>>0,f||v(a,4,this.length),(this[a]|this[a+1]<<8|this[a+2]<<16)+this[a+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(a,f){return a=a>>>0,f||v(a,4,this.length),this[a]*16777216+(this[a+1]<<16|this[a+2]<<8|this[a+3])},c.prototype.readBigUInt64LE=at(function(a){a=a>>>0,ot(a,"offset");const f=this[a],b=this[a+7];(f===void 0||b===void 0)&&he(a,this.length-8);const I=f+this[++a]*2**8+this[++a]*2**16+this[++a]*2**24,U=this[++a]+this[++a]*2**8+this[++a]*2**16+b*2**24;return BigInt(I)+(BigInt(U)<<BigInt(32))}),c.prototype.readBigUInt64BE=at(function(a){a=a>>>0,ot(a,"offset");const f=this[a],b=this[a+7];(f===void 0||b===void 0)&&he(a,this.length-8);const I=f*2**24+this[++a]*2**16+this[++a]*2**8+this[++a],U=this[++a]*2**24+this[++a]*2**16+this[++a]*2**8+b;return(BigInt(I)<<BigInt(32))+BigInt(U)}),c.prototype.readIntLE=function(a,f,b){a=a>>>0,f=f>>>0,b||v(a,f,this.length);let I=this[a],U=1,q=0;for(;++q<f&&(U*=256);)I+=this[a+q]*U;return U*=128,I>=U&&(I-=Math.pow(2,8*f)),I},c.prototype.readIntBE=function(a,f,b){a=a>>>0,f=f>>>0,b||v(a,f,this.length);let I=f,U=1,q=this[a+--I];for(;I>0&&(U*=256);)q+=this[a+--I]*U;return U*=128,q>=U&&(q-=Math.pow(2,8*f)),q},c.prototype.readInt8=function(a,f){return a=a>>>0,f||v(a,1,this.length),this[a]&128?(255-this[a]+1)*-1:this[a]},c.prototype.readInt16LE=function(a,f){a=a>>>0,f||v(a,2,this.length);const b=this[a]|this[a+1]<<8;return b&32768?b|4294901760:b},c.prototype.readInt16BE=function(a,f){a=a>>>0,f||v(a,2,this.length);const b=this[a+1]|this[a]<<8;return b&32768?b|4294901760:b},c.prototype.readInt32LE=function(a,f){return a=a>>>0,f||v(a,4,this.length),this[a]|this[a+1]<<8|this[a+2]<<16|this[a+3]<<24},c.prototype.readInt32BE=function(a,f){return a=a>>>0,f||v(a,4,this.length),this[a]<<24|this[a+1]<<16|this[a+2]<<8|this[a+3]},c.prototype.readBigInt64LE=at(function(a){a=a>>>0,ot(a,"offset");const f=this[a],b=this[a+7];(f===void 0||b===void 0)&&he(a,this.length-8);const I=this[a+4]+this[a+5]*2**8+this[a+6]*2**16+(b<<24);return(BigInt(I)<<BigInt(32))+BigInt(f+this[++a]*2**8+this[++a]*2**16+this[++a]*2**24)}),c.prototype.readBigInt64BE=at(function(a){a=a>>>0,ot(a,"offset");const f=this[a],b=this[a+7];(f===void 0||b===void 0)&&he(a,this.length-8);const I=(f<<24)+this[++a]*2**16+this[++a]*2**8+this[++a];return(BigInt(I)<<BigInt(32))+BigInt(this[++a]*2**24+this[++a]*2**16+this[++a]*2**8+b)}),c.prototype.readFloatLE=function(a,f){return a=a>>>0,f||v(a,4,this.length),e.read(this,a,!0,23,4)},c.prototype.readFloatBE=function(a,f){return a=a>>>0,f||v(a,4,this.length),e.read(this,a,!1,23,4)},c.prototype.readDoubleLE=function(a,f){return a=a>>>0,f||v(a,8,this.length),e.read(this,a,!0,52,8)},c.prototype.readDoubleBE=function(a,f){return a=a>>>0,f||v(a,8,this.length),e.read(this,a,!1,52,8)};function F(m,a,f,b,I,U){if(!c.isBuffer(m))throw new TypeError('"buffer" argument must be a Buffer instance');if(a>I||a<U)throw new RangeError('"value" argument is out of bounds');if(f+b>m.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(a,f,b,I){if(a=+a,f=f>>>0,b=b>>>0,!I){const V=Math.pow(2,8*b)-1;F(this,a,f,b,V,0)}let U=1,q=0;for(this[f]=a&255;++q<b&&(U*=256);)this[f+q]=a/U&255;return f+b},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(a,f,b,I){if(a=+a,f=f>>>0,b=b>>>0,!I){const V=Math.pow(2,8*b)-1;F(this,a,f,b,V,0)}let U=b-1,q=1;for(this[f+U]=a&255;--U>=0&&(q*=256);)this[f+U]=a/q&255;return f+b},c.prototype.writeUint8=c.prototype.writeUInt8=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,1,255,0),this[f]=a&255,f+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,2,65535,0),this[f]=a&255,this[f+1]=a>>>8,f+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,2,65535,0),this[f]=a>>>8,this[f+1]=a&255,f+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,4,4294967295,0),this[f+3]=a>>>24,this[f+2]=a>>>16,this[f+1]=a>>>8,this[f]=a&255,f+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,4,4294967295,0),this[f]=a>>>24,this[f+1]=a>>>16,this[f+2]=a>>>8,this[f+3]=a&255,f+4};function H(m,a,f,b,I){ct(a,b,I,m,f,7);let U=Number(a&BigInt(4294967295));m[f++]=U,U=U>>8,m[f++]=U,U=U>>8,m[f++]=U,U=U>>8,m[f++]=U;let q=Number(a>>BigInt(32)&BigInt(4294967295));return m[f++]=q,q=q>>8,m[f++]=q,q=q>>8,m[f++]=q,q=q>>8,m[f++]=q,f}function W(m,a,f,b,I){ct(a,b,I,m,f,7);let U=Number(a&BigInt(4294967295));m[f+7]=U,U=U>>8,m[f+6]=U,U=U>>8,m[f+5]=U,U=U>>8,m[f+4]=U;let q=Number(a>>BigInt(32)&BigInt(4294967295));return m[f+3]=q,q=q>>8,m[f+2]=q,q=q>>8,m[f+1]=q,q=q>>8,m[f]=q,f+8}c.prototype.writeBigUInt64LE=at(function(a,f=0){return H(this,a,f,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=at(function(a,f=0){return W(this,a,f,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(a,f,b,I){if(a=+a,f=f>>>0,!I){const lt=Math.pow(2,8*b-1);F(this,a,f,b,lt-1,-lt)}let U=0,q=1,V=0;for(this[f]=a&255;++U<b&&(q*=256);)a<0&&V===0&&this[f+U-1]!==0&&(V=1),this[f+U]=(a/q>>0)-V&255;return f+b},c.prototype.writeIntBE=function(a,f,b,I){if(a=+a,f=f>>>0,!I){const lt=Math.pow(2,8*b-1);F(this,a,f,b,lt-1,-lt)}let U=b-1,q=1,V=0;for(this[f+U]=a&255;--U>=0&&(q*=256);)a<0&&V===0&&this[f+U+1]!==0&&(V=1),this[f+U]=(a/q>>0)-V&255;return f+b},c.prototype.writeInt8=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,1,127,-128),a<0&&(a=255+a+1),this[f]=a&255,f+1},c.prototype.writeInt16LE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,2,32767,-32768),this[f]=a&255,this[f+1]=a>>>8,f+2},c.prototype.writeInt16BE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,2,32767,-32768),this[f]=a>>>8,this[f+1]=a&255,f+2},c.prototype.writeInt32LE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,4,2147483647,-2147483648),this[f]=a&255,this[f+1]=a>>>8,this[f+2]=a>>>16,this[f+3]=a>>>24,f+4},c.prototype.writeInt32BE=function(a,f,b){return a=+a,f=f>>>0,b||F(this,a,f,4,2147483647,-2147483648),a<0&&(a=4294967295+a+1),this[f]=a>>>24,this[f+1]=a>>>16,this[f+2]=a>>>8,this[f+3]=a&255,f+4},c.prototype.writeBigInt64LE=at(function(a,f=0){return H(this,a,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=at(function(a,f=0){return W(this,a,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Z(m,a,f,b,I,U){if(f+b>m.length)throw new RangeError("Index out of range");if(f<0)throw new RangeError("Index out of range")}function G(m,a,f,b,I){return a=+a,f=f>>>0,I||Z(m,a,f,4),e.write(m,a,f,b,23,4),f+4}c.prototype.writeFloatLE=function(a,f,b){return G(this,a,f,!0,b)},c.prototype.writeFloatBE=function(a,f,b){return G(this,a,f,!1,b)};function X(m,a,f,b,I){return a=+a,f=f>>>0,I||Z(m,a,f,8),e.write(m,a,f,b,52,8),f+8}c.prototype.writeDoubleLE=function(a,f,b){return X(this,a,f,!0,b)},c.prototype.writeDoubleBE=function(a,f,b){return X(this,a,f,!1,b)},c.prototype.copy=function(a,f,b,I){if(!c.isBuffer(a))throw new TypeError("argument should be a Buffer");if(b||(b=0),!I&&I!==0&&(I=this.length),f>=a.length&&(f=a.length),f||(f=0),I>0&&I<b&&(I=b),I===b||a.length===0||this.length===0)return 0;if(f<0)throw new RangeError("targetStart out of bounds");if(b<0||b>=this.length)throw new RangeError("Index out of range");if(I<0)throw new RangeError("sourceEnd out of bounds");I>this.length&&(I=this.length),a.length-f<I-b&&(I=a.length-f+b);const U=I-b;return this===a&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(f,b,I):Uint8Array.prototype.set.call(a,this.subarray(b,I),f),U},c.prototype.fill=function(a,f,b,I){if(typeof a=="string"){if(typeof f=="string"?(I=f,f=0,b=this.length):typeof b=="string"&&(I=b,b=this.length),I!==void 0&&typeof I!="string")throw new TypeError("encoding must be a string");if(typeof I=="string"&&!c.isEncoding(I))throw new TypeError("Unknown encoding: "+I);if(a.length===1){const q=a.charCodeAt(0);(I==="utf8"&&q<128||I==="latin1")&&(a=q)}}else typeof a=="number"?a=a&255:typeof a=="boolean"&&(a=Number(a));if(f<0||this.length<f||this.length<b)throw new RangeError("Out of range index");if(b<=f)return this;f=f>>>0,b=b===void 0?this.length:b>>>0,a||(a=0);let U;if(typeof a=="number")for(U=f;U<b;++U)this[U]=a;else{const q=c.isBuffer(a)?a:c.from(a,I),V=q.length;if(V===0)throw new TypeError('The value "'+a+'" is invalid for argument "value"');for(U=0;U<b-f;++U)this[U+f]=q[U%V]}return this};const it={};function Y(m,a,f){it[m]=class extends f{constructor(){super(),Object.defineProperty(this,"message",{value:a.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${m}]`,this.stack,delete this.name}get code(){return m}set code(I){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:I,writable:!0})}toString(){return`${this.name} [${m}]: ${this.message}`}}}Y("ERR_BUFFER_OUT_OF_BOUNDS",function(m){return m?`${m} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Y("ERR_INVALID_ARG_TYPE",function(m,a){return`The "${m}" argument must be of type number. Received type ${typeof a}`},TypeError),Y("ERR_OUT_OF_RANGE",function(m,a,f){let b=`The value of "${m}" is out of range.`,I=f;return Number.isInteger(f)&&Math.abs(f)>2**32?I=tt(String(f)):typeof f=="bigint"&&(I=String(f),(f>BigInt(2)**BigInt(32)||f<-(BigInt(2)**BigInt(32)))&&(I=tt(I)),I+="n"),b+=` It must be ${a}. Received ${I}`,b},RangeError);function tt(m){let a="",f=m.length;const b=m[0]==="-"?1:0;for(;f>=b+4;f-=3)a=`_${m.slice(f-3,f)}${a}`;return`${m.slice(0,f)}${a}`}function Jt(m,a,f){ot(a,"offset"),(m[a]===void 0||m[a+f]===void 0)&&he(a,m.length-(f+1))}function ct(m,a,f,b,I,U){if(m>f||m<a){const q=typeof a=="bigint"?"n":"";let V;throw a===0||a===BigInt(0)?V=`>= 0${q} and < 2${q} ** ${(U+1)*8}${q}`:V=`>= -(2${q} ** ${(U+1)*8-1}${q}) and < 2 ** ${(U+1)*8-1}${q}`,new it.ERR_OUT_OF_RANGE("value",V,m)}Jt(b,I,U)}function ot(m,a){if(typeof m!="number")throw new it.ERR_INVALID_ARG_TYPE(a,"number",m)}function he(m,a,f){throw Math.floor(m)!==m?(ot(m,f),new it.ERR_OUT_OF_RANGE("offset","an integer",m)):a<0?new it.ERR_BUFFER_OUT_OF_BOUNDS:new it.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${a}`,m)}const pt=/[^+/0-9A-Za-z-_]/g;function mt(m){if(m=m.split("=")[0],m=m.trim().replace(pt,""),m.length<2)return"";for(;m.length%4!==0;)m=m+"=";return m}function qe(m,a){a=a||1/0;let f;const b=m.length;let I=null;const U=[];for(let q=0;q<b;++q){if(f=m.charCodeAt(q),f>55295&&f<57344){if(!I){if(f>56319){(a-=3)>-1&&U.push(239,191,189);continue}else if(q+1===b){(a-=3)>-1&&U.push(239,191,189);continue}I=f;continue}if(f<56320){(a-=3)>-1&&U.push(239,191,189),I=f;continue}f=(I-55296<<10|f-56320)+65536}else I&&(a-=3)>-1&&U.push(239,191,189);if(I=null,f<128){if((a-=1)<0)break;U.push(f)}else if(f<2048){if((a-=2)<0)break;U.push(f>>6|192,f&63|128)}else if(f<65536){if((a-=3)<0)break;U.push(f>>12|224,f>>6&63|128,f&63|128)}else if(f<1114112){if((a-=4)<0)break;U.push(f>>18|240,f>>12&63|128,f>>6&63|128,f&63|128)}else throw new Error("Invalid code point")}return U}function gt(m){const a=[];for(let f=0;f<m.length;++f)a.push(m.charCodeAt(f)&255);return a}function yt(m,a){let f,b,I;const U=[];for(let q=0;q<m.length&&!((a-=2)<0);++q)f=m.charCodeAt(q),b=f>>8,I=f%256,U.push(I),U.push(b);return U}function Ge(m){return t.toByteArray(mt(m))}function ft(m,a,f,b){let I;for(I=0;I<b&&!(I+f>=a.length||I>=m.length);++I)a[I+f]=m[I];return I}function nt(m,a){return m instanceof a||m!=null&&m.constructor!=null&&m.constructor.name!=null&&m.constructor.name===a.name}function Fe(m){return m!==m}const wt=(function(){const m="0123456789abcdef",a=new Array(256);for(let f=0;f<16;++f){const b=f*16;for(let I=0;I<16;++I)a[b+I]=m[f]+m[I]}return a})();function at(m){return typeof BigInt>"u"?xr:m}function xr(){throw new Error("BigInt not supported")}})(mn)),mn}var Mu=Eu(),wr={exports:{}};const _u=wu(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var Bu=wr.exports,mo;function ku(){return mo||(mo=1,(function(n){(function(t,e){function r(E,s){if(!E)throw new Error(s||"Assertion failed")}function i(E,s){E.super_=s;var h=function(){};h.prototype=s.prototype,E.prototype=new h,E.prototype.constructor=E}function o(E,s,h){if(o.isBN(E))return E;this.negative=0,this.words=null,this.length=0,this.red=null,E!==null&&((s==="le"||s==="be")&&(h=s,s=10),this._init(E||0,s||10,h||"be"))}typeof t=="object"?t.exports=o:e.BN=o,o.BN=o,o.wordSize=26;var l;try{typeof window<"u"&&typeof window.Buffer<"u"?l=window.Buffer:l=_u.Buffer}catch{}o.isBN=function(s){return s instanceof o?!0:s!==null&&typeof s=="object"&&s.constructor.wordSize===o.wordSize&&Array.isArray(s.words)},o.max=function(s,h){return s.cmp(h)>0?s:h},o.min=function(s,h){return s.cmp(h)<0?s:h},o.prototype._init=function(s,h,d){if(typeof s=="number")return this._initNumber(s,h,d);if(typeof s=="object")return this._initArray(s,h,d);h==="hex"&&(h=16),r(h===(h|0)&&h>=2&&h<=36),s=s.toString().replace(/\s+/g,"");var p=0;s[0]==="-"&&(p++,this.negative=1),p<s.length&&(h===16?this._parseHex(s,p,d):(this._parseBase(s,h,p),d==="le"&&this._initArray(this.toArray(),h,d)))},o.prototype._initNumber=function(s,h,d){s<0&&(this.negative=1,s=-s),s<67108864?(this.words=[s&67108863],this.length=1):s<4503599627370496?(this.words=[s&67108863,s/67108864&67108863],this.length=2):(r(s<9007199254740992),this.words=[s&67108863,s/67108864&67108863,1],this.length=3),d==="le"&&this._initArray(this.toArray(),h,d)},o.prototype._initArray=function(s,h,d){if(r(typeof s.length=="number"),s.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(s.length/3),this.words=new Array(this.length);for(var p=0;p<this.length;p++)this.words[p]=0;var g,x,k=0;if(d==="be")for(p=s.length-1,g=0;p>=0;p-=3)x=s[p]|s[p-1]<<8|s[p-2]<<16,this.words[g]|=x<<k&67108863,this.words[g+1]=x>>>26-k&67108863,k+=24,k>=26&&(k-=26,g++);else if(d==="le")for(p=0,g=0;p<s.length;p+=3)x=s[p]|s[p+1]<<8|s[p+2]<<16,this.words[g]|=x<<k&67108863,this.words[g+1]=x>>>26-k&67108863,k+=24,k>=26&&(k-=26,g++);return this.strip()};function c(E,s){var h=E.charCodeAt(s);return h>=65&&h<=70?h-55:h>=97&&h<=102?h-87:h-48&15}function y(E,s,h){var d=c(E,h);return h-1>=s&&(d|=c(E,h-1)<<4),d}o.prototype._parseHex=function(s,h,d){this.length=Math.ceil((s.length-h)/6),this.words=new Array(this.length);for(var p=0;p<this.length;p++)this.words[p]=0;var g=0,x=0,k;if(d==="be")for(p=s.length-1;p>=h;p-=2)k=y(s,h,p)<<g,this.words[x]|=k&67108863,g>=18?(g-=18,x+=1,this.words[x]|=k>>>26):g+=8;else{var w=s.length-h;for(p=w%2===0?h+1:h;p<s.length;p+=2)k=y(s,h,p)<<g,this.words[x]|=k&67108863,g>=18?(g-=18,x+=1,this.words[x]|=k>>>26):g+=8}this.strip()};function M(E,s,h,d){for(var p=0,g=Math.min(E.length,h),x=s;x<g;x++){var k=E.charCodeAt(x)-48;p*=d,k>=49?p+=k-49+10:k>=17?p+=k-17+10:p+=k}return p}o.prototype._parseBase=function(s,h,d){this.words=[0],this.length=1;for(var p=0,g=1;g<=67108863;g*=h)p++;p--,g=g/h|0;for(var x=s.length-d,k=x%p,w=Math.min(x,x-k)+d,u=0,v=d;v<w;v+=p)u=M(s,v,v+p,h),this.imuln(g),this.words[0]+u<67108864?this.words[0]+=u:this._iaddn(u);if(k!==0){var F=1;for(u=M(s,v,s.length,h),v=0;v<k;v++)F*=h;this.imuln(F),this.words[0]+u<67108864?this.words[0]+=u:this._iaddn(u)}this.strip()},o.prototype.copy=function(s){s.words=new Array(this.length);for(var h=0;h<this.length;h++)s.words[h]=this.words[h];s.length=this.length,s.negative=this.negative,s.red=this.red},o.prototype.clone=function(){var s=new o(null);return this.copy(s),s},o.prototype._expand=function(s){for(;this.length<s;)this.words[this.length++]=0;return this},o.prototype.strip=function(){for(;this.length>1&&this.words[this.length-1]===0;)this.length--;return this._normSign()},o.prototype._normSign=function(){return this.length===1&&this.words[0]===0&&(this.negative=0),this},o.prototype.inspect=function(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"};var A=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],S=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],B=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];o.prototype.toString=function(s,h){s=s||10,h=h|0||1;var d;if(s===16||s==="hex"){d="";for(var p=0,g=0,x=0;x<this.length;x++){var k=this.words[x],w=((k<<p|g)&16777215).toString(16);g=k>>>24-p&16777215,p+=2,p>=26&&(p-=26,x--),g!==0||x!==this.length-1?d=A[6-w.length]+w+d:d=w+d}for(g!==0&&(d=g.toString(16)+d);d.length%h!==0;)d="0"+d;return this.negative!==0&&(d="-"+d),d}if(s===(s|0)&&s>=2&&s<=36){var u=S[s],v=B[s];d="";var F=this.clone();for(F.negative=0;!F.isZero();){var H=F.modn(v).toString(s);F=F.idivn(v),F.isZero()?d=H+d:d=A[u-H.length]+H+d}for(this.isZero()&&(d="0"+d);d.length%h!==0;)d="0"+d;return this.negative!==0&&(d="-"+d),d}r(!1,"Base should be between 2 and 36")},o.prototype.toNumber=function(){var s=this.words[0];return this.length===2?s+=this.words[1]*67108864:this.length===3&&this.words[2]===1?s+=4503599627370496+this.words[1]*67108864:this.length>2&&r(!1,"Number can only safely store up to 53 bits"),this.negative!==0?-s:s},o.prototype.toJSON=function(){return this.toString(16)},o.prototype.toBuffer=function(s,h){return r(typeof l<"u"),this.toArrayLike(l,s,h)},o.prototype.toArray=function(s,h){return this.toArrayLike(Array,s,h)},o.prototype.toArrayLike=function(s,h,d){var p=this.byteLength(),g=d||Math.max(1,p);r(p<=g,"byte array longer than desired length"),r(g>0,"Requested array length <= 0"),this.strip();var x=h==="le",k=new s(g),w,u,v=this.clone();if(x){for(u=0;!v.isZero();u++)w=v.andln(255),v.iushrn(8),k[u]=w;for(;u<g;u++)k[u]=0}else{for(u=0;u<g-p;u++)k[u]=0;for(u=0;!v.isZero();u++)w=v.andln(255),v.iushrn(8),k[g-u-1]=w}return k},Math.clz32?o.prototype._countBits=function(s){return 32-Math.clz32(s)}:o.prototype._countBits=function(s){var h=s,d=0;return h>=4096&&(d+=13,h>>>=13),h>=64&&(d+=7,h>>>=7),h>=8&&(d+=4,h>>>=4),h>=2&&(d+=2,h>>>=2),d+h},o.prototype._zeroBits=function(s){if(s===0)return 26;var h=s,d=0;return(h&8191)===0&&(d+=13,h>>>=13),(h&127)===0&&(d+=7,h>>>=7),(h&15)===0&&(d+=4,h>>>=4),(h&3)===0&&(d+=2,h>>>=2),(h&1)===0&&d++,d},o.prototype.bitLength=function(){var s=this.words[this.length-1],h=this._countBits(s);return(this.length-1)*26+h};function _(E){for(var s=new Array(E.bitLength()),h=0;h<s.length;h++){var d=h/26|0,p=h%26;s[h]=(E.words[d]&1<<p)>>>p}return s}o.prototype.zeroBits=function(){if(this.isZero())return 0;for(var s=0,h=0;h<this.length;h++){var d=this._zeroBits(this.words[h]);if(s+=d,d!==26)break}return s},o.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},o.prototype.toTwos=function(s){return this.negative!==0?this.abs().inotn(s).iaddn(1):this.clone()},o.prototype.fromTwos=function(s){return this.testn(s-1)?this.notn(s).iaddn(1).ineg():this.clone()},o.prototype.isNeg=function(){return this.negative!==0},o.prototype.neg=function(){return this.clone().ineg()},o.prototype.ineg=function(){return this.isZero()||(this.negative^=1),this},o.prototype.iuor=function(s){for(;this.length<s.length;)this.words[this.length++]=0;for(var h=0;h<s.length;h++)this.words[h]=this.words[h]|s.words[h];return this.strip()},o.prototype.ior=function(s){return r((this.negative|s.negative)===0),this.iuor(s)},o.prototype.or=function(s){return this.length>s.length?this.clone().ior(s):s.clone().ior(this)},o.prototype.uor=function(s){return this.length>s.length?this.clone().iuor(s):s.clone().iuor(this)},o.prototype.iuand=function(s){var h;this.length>s.length?h=s:h=this;for(var d=0;d<h.length;d++)this.words[d]=this.words[d]&s.words[d];return this.length=h.length,this.strip()},o.prototype.iand=function(s){return r((this.negative|s.negative)===0),this.iuand(s)},o.prototype.and=function(s){return this.length>s.length?this.clone().iand(s):s.clone().iand(this)},o.prototype.uand=function(s){return this.length>s.length?this.clone().iuand(s):s.clone().iuand(this)},o.prototype.iuxor=function(s){var h,d;this.length>s.length?(h=this,d=s):(h=s,d=this);for(var p=0;p<d.length;p++)this.words[p]=h.words[p]^d.words[p];if(this!==h)for(;p<h.length;p++)this.words[p]=h.words[p];return this.length=h.length,this.strip()},o.prototype.ixor=function(s){return r((this.negative|s.negative)===0),this.iuxor(s)},o.prototype.xor=function(s){return this.length>s.length?this.clone().ixor(s):s.clone().ixor(this)},o.prototype.uxor=function(s){return this.length>s.length?this.clone().iuxor(s):s.clone().iuxor(this)},o.prototype.inotn=function(s){r(typeof s=="number"&&s>=0);var h=Math.ceil(s/26)|0,d=s%26;this._expand(h),d>0&&h--;for(var p=0;p<h;p++)this.words[p]=~this.words[p]&67108863;return d>0&&(this.words[p]=~this.words[p]&67108863>>26-d),this.strip()},o.prototype.notn=function(s){return this.clone().inotn(s)},o.prototype.setn=function(s,h){r(typeof s=="number"&&s>=0);var d=s/26|0,p=s%26;return this._expand(d+1),h?this.words[d]=this.words[d]|1<<p:this.words[d]=this.words[d]&~(1<<p),this.strip()},o.prototype.iadd=function(s){var h;if(this.negative!==0&&s.negative===0)return this.negative=0,h=this.isub(s),this.negative^=1,this._normSign();if(this.negative===0&&s.negative!==0)return s.negative=0,h=this.isub(s),s.negative=1,h._normSign();var d,p;this.length>s.length?(d=this,p=s):(d=s,p=this);for(var g=0,x=0;x<p.length;x++)h=(d.words[x]|0)+(p.words[x]|0)+g,this.words[x]=h&67108863,g=h>>>26;for(;g!==0&&x<d.length;x++)h=(d.words[x]|0)+g,this.words[x]=h&67108863,g=h>>>26;if(this.length=d.length,g!==0)this.words[this.length]=g,this.length++;else if(d!==this)for(;x<d.length;x++)this.words[x]=d.words[x];return this},o.prototype.add=function(s){var h;return s.negative!==0&&this.negative===0?(s.negative=0,h=this.sub(s),s.negative^=1,h):s.negative===0&&this.negative!==0?(this.negative=0,h=s.sub(this),this.negative=1,h):this.length>s.length?this.clone().iadd(s):s.clone().iadd(this)},o.prototype.isub=function(s){if(s.negative!==0){s.negative=0;var h=this.iadd(s);return s.negative=1,h._normSign()}else if(this.negative!==0)return this.negative=0,this.iadd(s),this.negative=1,this._normSign();var d=this.cmp(s);if(d===0)return this.negative=0,this.length=1,this.words[0]=0,this;var p,g;d>0?(p=this,g=s):(p=s,g=this);for(var x=0,k=0;k<g.length;k++)h=(p.words[k]|0)-(g.words[k]|0)+x,x=h>>26,this.words[k]=h&67108863;for(;x!==0&&k<p.length;k++)h=(p.words[k]|0)+x,x=h>>26,this.words[k]=h&67108863;if(x===0&&k<p.length&&p!==this)for(;k<p.length;k++)this.words[k]=p.words[k];return this.length=Math.max(this.length,k),p!==this&&(this.negative=1),this.strip()},o.prototype.sub=function(s){return this.clone().isub(s)};function P(E,s,h){h.negative=s.negative^E.negative;var d=E.length+s.length|0;h.length=d,d=d-1|0;var p=E.words[0]|0,g=s.words[0]|0,x=p*g,k=x&67108863,w=x/67108864|0;h.words[0]=k;for(var u=1;u<d;u++){for(var v=w>>>26,F=w&67108863,H=Math.min(u,s.length-1),W=Math.max(0,u-E.length+1);W<=H;W++){var Z=u-W|0;p=E.words[Z]|0,g=s.words[W]|0,x=p*g+F,v+=x/67108864|0,F=x&67108863}h.words[u]=F|0,w=v|0}return w!==0?h.words[u]=w|0:h.length--,h.strip()}var T=function(s,h,d){var p=s.words,g=h.words,x=d.words,k=0,w,u,v,F=p[0]|0,H=F&8191,W=F>>>13,Z=p[1]|0,G=Z&8191,X=Z>>>13,it=p[2]|0,Y=it&8191,tt=it>>>13,Jt=p[3]|0,ct=Jt&8191,ot=Jt>>>13,he=p[4]|0,pt=he&8191,mt=he>>>13,qe=p[5]|0,gt=qe&8191,yt=qe>>>13,Ge=p[6]|0,ft=Ge&8191,nt=Ge>>>13,Fe=p[7]|0,wt=Fe&8191,at=Fe>>>13,xr=p[8]|0,m=xr&8191,a=xr>>>13,f=p[9]|0,b=f&8191,I=f>>>13,U=g[0]|0,q=U&8191,V=U>>>13,lt=g[1]|0,J=lt&8191,et=lt>>>13,st=g[2]|0,vt=st&8191,bt=st>>>13,_o=g[3]|0,xt=_o&8191,Et=_o>>>13,Bo=g[4]|0,Mt=Bo&8191,_t=Bo>>>13,ko=g[5]|0,Bt=ko&8191,kt=ko>>>13,Ao=g[6]|0,At=Ao&8191,It=Ao>>>13,Io=g[7]|0,St=Io&8191,Tt=Io>>>13,So=g[8]|0,Pt=So&8191,Ut=So>>>13,To=g[9]|0,Ct=To&8191,qt=To>>>13;d.negative=s.negative^h.negative,d.length=19,w=Math.imul(H,q),u=Math.imul(H,V),u=u+Math.imul(W,q)|0,v=Math.imul(W,V);var vn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(vn>>>26)|0,vn&=67108863,w=Math.imul(G,q),u=Math.imul(G,V),u=u+Math.imul(X,q)|0,v=Math.imul(X,V),w=w+Math.imul(H,J)|0,u=u+Math.imul(H,et)|0,u=u+Math.imul(W,J)|0,v=v+Math.imul(W,et)|0;var bn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(bn>>>26)|0,bn&=67108863,w=Math.imul(Y,q),u=Math.imul(Y,V),u=u+Math.imul(tt,q)|0,v=Math.imul(tt,V),w=w+Math.imul(G,J)|0,u=u+Math.imul(G,et)|0,u=u+Math.imul(X,J)|0,v=v+Math.imul(X,et)|0,w=w+Math.imul(H,vt)|0,u=u+Math.imul(H,bt)|0,u=u+Math.imul(W,vt)|0,v=v+Math.imul(W,bt)|0;var xn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(xn>>>26)|0,xn&=67108863,w=Math.imul(ct,q),u=Math.imul(ct,V),u=u+Math.imul(ot,q)|0,v=Math.imul(ot,V),w=w+Math.imul(Y,J)|0,u=u+Math.imul(Y,et)|0,u=u+Math.imul(tt,J)|0,v=v+Math.imul(tt,et)|0,w=w+Math.imul(G,vt)|0,u=u+Math.imul(G,bt)|0,u=u+Math.imul(X,vt)|0,v=v+Math.imul(X,bt)|0,w=w+Math.imul(H,xt)|0,u=u+Math.imul(H,Et)|0,u=u+Math.imul(W,xt)|0,v=v+Math.imul(W,Et)|0;var En=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(En>>>26)|0,En&=67108863,w=Math.imul(pt,q),u=Math.imul(pt,V),u=u+Math.imul(mt,q)|0,v=Math.imul(mt,V),w=w+Math.imul(ct,J)|0,u=u+Math.imul(ct,et)|0,u=u+Math.imul(ot,J)|0,v=v+Math.imul(ot,et)|0,w=w+Math.imul(Y,vt)|0,u=u+Math.imul(Y,bt)|0,u=u+Math.imul(tt,vt)|0,v=v+Math.imul(tt,bt)|0,w=w+Math.imul(G,xt)|0,u=u+Math.imul(G,Et)|0,u=u+Math.imul(X,xt)|0,v=v+Math.imul(X,Et)|0,w=w+Math.imul(H,Mt)|0,u=u+Math.imul(H,_t)|0,u=u+Math.imul(W,Mt)|0,v=v+Math.imul(W,_t)|0;var Mn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Mn>>>26)|0,Mn&=67108863,w=Math.imul(gt,q),u=Math.imul(gt,V),u=u+Math.imul(yt,q)|0,v=Math.imul(yt,V),w=w+Math.imul(pt,J)|0,u=u+Math.imul(pt,et)|0,u=u+Math.imul(mt,J)|0,v=v+Math.imul(mt,et)|0,w=w+Math.imul(ct,vt)|0,u=u+Math.imul(ct,bt)|0,u=u+Math.imul(ot,vt)|0,v=v+Math.imul(ot,bt)|0,w=w+Math.imul(Y,xt)|0,u=u+Math.imul(Y,Et)|0,u=u+Math.imul(tt,xt)|0,v=v+Math.imul(tt,Et)|0,w=w+Math.imul(G,Mt)|0,u=u+Math.imul(G,_t)|0,u=u+Math.imul(X,Mt)|0,v=v+Math.imul(X,_t)|0,w=w+Math.imul(H,Bt)|0,u=u+Math.imul(H,kt)|0,u=u+Math.imul(W,Bt)|0,v=v+Math.imul(W,kt)|0;var _n=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(_n>>>26)|0,_n&=67108863,w=Math.imul(ft,q),u=Math.imul(ft,V),u=u+Math.imul(nt,q)|0,v=Math.imul(nt,V),w=w+Math.imul(gt,J)|0,u=u+Math.imul(gt,et)|0,u=u+Math.imul(yt,J)|0,v=v+Math.imul(yt,et)|0,w=w+Math.imul(pt,vt)|0,u=u+Math.imul(pt,bt)|0,u=u+Math.imul(mt,vt)|0,v=v+Math.imul(mt,bt)|0,w=w+Math.imul(ct,xt)|0,u=u+Math.imul(ct,Et)|0,u=u+Math.imul(ot,xt)|0,v=v+Math.imul(ot,Et)|0,w=w+Math.imul(Y,Mt)|0,u=u+Math.imul(Y,_t)|0,u=u+Math.imul(tt,Mt)|0,v=v+Math.imul(tt,_t)|0,w=w+Math.imul(G,Bt)|0,u=u+Math.imul(G,kt)|0,u=u+Math.imul(X,Bt)|0,v=v+Math.imul(X,kt)|0,w=w+Math.imul(H,At)|0,u=u+Math.imul(H,It)|0,u=u+Math.imul(W,At)|0,v=v+Math.imul(W,It)|0;var Bn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Bn>>>26)|0,Bn&=67108863,w=Math.imul(wt,q),u=Math.imul(wt,V),u=u+Math.imul(at,q)|0,v=Math.imul(at,V),w=w+Math.imul(ft,J)|0,u=u+Math.imul(ft,et)|0,u=u+Math.imul(nt,J)|0,v=v+Math.imul(nt,et)|0,w=w+Math.imul(gt,vt)|0,u=u+Math.imul(gt,bt)|0,u=u+Math.imul(yt,vt)|0,v=v+Math.imul(yt,bt)|0,w=w+Math.imul(pt,xt)|0,u=u+Math.imul(pt,Et)|0,u=u+Math.imul(mt,xt)|0,v=v+Math.imul(mt,Et)|0,w=w+Math.imul(ct,Mt)|0,u=u+Math.imul(ct,_t)|0,u=u+Math.imul(ot,Mt)|0,v=v+Math.imul(ot,_t)|0,w=w+Math.imul(Y,Bt)|0,u=u+Math.imul(Y,kt)|0,u=u+Math.imul(tt,Bt)|0,v=v+Math.imul(tt,kt)|0,w=w+Math.imul(G,At)|0,u=u+Math.imul(G,It)|0,u=u+Math.imul(X,At)|0,v=v+Math.imul(X,It)|0,w=w+Math.imul(H,St)|0,u=u+Math.imul(H,Tt)|0,u=u+Math.imul(W,St)|0,v=v+Math.imul(W,Tt)|0;var kn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(kn>>>26)|0,kn&=67108863,w=Math.imul(m,q),u=Math.imul(m,V),u=u+Math.imul(a,q)|0,v=Math.imul(a,V),w=w+Math.imul(wt,J)|0,u=u+Math.imul(wt,et)|0,u=u+Math.imul(at,J)|0,v=v+Math.imul(at,et)|0,w=w+Math.imul(ft,vt)|0,u=u+Math.imul(ft,bt)|0,u=u+Math.imul(nt,vt)|0,v=v+Math.imul(nt,bt)|0,w=w+Math.imul(gt,xt)|0,u=u+Math.imul(gt,Et)|0,u=u+Math.imul(yt,xt)|0,v=v+Math.imul(yt,Et)|0,w=w+Math.imul(pt,Mt)|0,u=u+Math.imul(pt,_t)|0,u=u+Math.imul(mt,Mt)|0,v=v+Math.imul(mt,_t)|0,w=w+Math.imul(ct,Bt)|0,u=u+Math.imul(ct,kt)|0,u=u+Math.imul(ot,Bt)|0,v=v+Math.imul(ot,kt)|0,w=w+Math.imul(Y,At)|0,u=u+Math.imul(Y,It)|0,u=u+Math.imul(tt,At)|0,v=v+Math.imul(tt,It)|0,w=w+Math.imul(G,St)|0,u=u+Math.imul(G,Tt)|0,u=u+Math.imul(X,St)|0,v=v+Math.imul(X,Tt)|0,w=w+Math.imul(H,Pt)|0,u=u+Math.imul(H,Ut)|0,u=u+Math.imul(W,Pt)|0,v=v+Math.imul(W,Ut)|0;var An=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(An>>>26)|0,An&=67108863,w=Math.imul(b,q),u=Math.imul(b,V),u=u+Math.imul(I,q)|0,v=Math.imul(I,V),w=w+Math.imul(m,J)|0,u=u+Math.imul(m,et)|0,u=u+Math.imul(a,J)|0,v=v+Math.imul(a,et)|0,w=w+Math.imul(wt,vt)|0,u=u+Math.imul(wt,bt)|0,u=u+Math.imul(at,vt)|0,v=v+Math.imul(at,bt)|0,w=w+Math.imul(ft,xt)|0,u=u+Math.imul(ft,Et)|0,u=u+Math.imul(nt,xt)|0,v=v+Math.imul(nt,Et)|0,w=w+Math.imul(gt,Mt)|0,u=u+Math.imul(gt,_t)|0,u=u+Math.imul(yt,Mt)|0,v=v+Math.imul(yt,_t)|0,w=w+Math.imul(pt,Bt)|0,u=u+Math.imul(pt,kt)|0,u=u+Math.imul(mt,Bt)|0,v=v+Math.imul(mt,kt)|0,w=w+Math.imul(ct,At)|0,u=u+Math.imul(ct,It)|0,u=u+Math.imul(ot,At)|0,v=v+Math.imul(ot,It)|0,w=w+Math.imul(Y,St)|0,u=u+Math.imul(Y,Tt)|0,u=u+Math.imul(tt,St)|0,v=v+Math.imul(tt,Tt)|0,w=w+Math.imul(G,Pt)|0,u=u+Math.imul(G,Ut)|0,u=u+Math.imul(X,Pt)|0,v=v+Math.imul(X,Ut)|0,w=w+Math.imul(H,Ct)|0,u=u+Math.imul(H,qt)|0,u=u+Math.imul(W,Ct)|0,v=v+Math.imul(W,qt)|0;var In=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(In>>>26)|0,In&=67108863,w=Math.imul(b,J),u=Math.imul(b,et),u=u+Math.imul(I,J)|0,v=Math.imul(I,et),w=w+Math.imul(m,vt)|0,u=u+Math.imul(m,bt)|0,u=u+Math.imul(a,vt)|0,v=v+Math.imul(a,bt)|0,w=w+Math.imul(wt,xt)|0,u=u+Math.imul(wt,Et)|0,u=u+Math.imul(at,xt)|0,v=v+Math.imul(at,Et)|0,w=w+Math.imul(ft,Mt)|0,u=u+Math.imul(ft,_t)|0,u=u+Math.imul(nt,Mt)|0,v=v+Math.imul(nt,_t)|0,w=w+Math.imul(gt,Bt)|0,u=u+Math.imul(gt,kt)|0,u=u+Math.imul(yt,Bt)|0,v=v+Math.imul(yt,kt)|0,w=w+Math.imul(pt,At)|0,u=u+Math.imul(pt,It)|0,u=u+Math.imul(mt,At)|0,v=v+Math.imul(mt,It)|0,w=w+Math.imul(ct,St)|0,u=u+Math.imul(ct,Tt)|0,u=u+Math.imul(ot,St)|0,v=v+Math.imul(ot,Tt)|0,w=w+Math.imul(Y,Pt)|0,u=u+Math.imul(Y,Ut)|0,u=u+Math.imul(tt,Pt)|0,v=v+Math.imul(tt,Ut)|0,w=w+Math.imul(G,Ct)|0,u=u+Math.imul(G,qt)|0,u=u+Math.imul(X,Ct)|0,v=v+Math.imul(X,qt)|0;var Sn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Sn>>>26)|0,Sn&=67108863,w=Math.imul(b,vt),u=Math.imul(b,bt),u=u+Math.imul(I,vt)|0,v=Math.imul(I,bt),w=w+Math.imul(m,xt)|0,u=u+Math.imul(m,Et)|0,u=u+Math.imul(a,xt)|0,v=v+Math.imul(a,Et)|0,w=w+Math.imul(wt,Mt)|0,u=u+Math.imul(wt,_t)|0,u=u+Math.imul(at,Mt)|0,v=v+Math.imul(at,_t)|0,w=w+Math.imul(ft,Bt)|0,u=u+Math.imul(ft,kt)|0,u=u+Math.imul(nt,Bt)|0,v=v+Math.imul(nt,kt)|0,w=w+Math.imul(gt,At)|0,u=u+Math.imul(gt,It)|0,u=u+Math.imul(yt,At)|0,v=v+Math.imul(yt,It)|0,w=w+Math.imul(pt,St)|0,u=u+Math.imul(pt,Tt)|0,u=u+Math.imul(mt,St)|0,v=v+Math.imul(mt,Tt)|0,w=w+Math.imul(ct,Pt)|0,u=u+Math.imul(ct,Ut)|0,u=u+Math.imul(ot,Pt)|0,v=v+Math.imul(ot,Ut)|0,w=w+Math.imul(Y,Ct)|0,u=u+Math.imul(Y,qt)|0,u=u+Math.imul(tt,Ct)|0,v=v+Math.imul(tt,qt)|0;var Tn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Tn>>>26)|0,Tn&=67108863,w=Math.imul(b,xt),u=Math.imul(b,Et),u=u+Math.imul(I,xt)|0,v=Math.imul(I,Et),w=w+Math.imul(m,Mt)|0,u=u+Math.imul(m,_t)|0,u=u+Math.imul(a,Mt)|0,v=v+Math.imul(a,_t)|0,w=w+Math.imul(wt,Bt)|0,u=u+Math.imul(wt,kt)|0,u=u+Math.imul(at,Bt)|0,v=v+Math.imul(at,kt)|0,w=w+Math.imul(ft,At)|0,u=u+Math.imul(ft,It)|0,u=u+Math.imul(nt,At)|0,v=v+Math.imul(nt,It)|0,w=w+Math.imul(gt,St)|0,u=u+Math.imul(gt,Tt)|0,u=u+Math.imul(yt,St)|0,v=v+Math.imul(yt,Tt)|0,w=w+Math.imul(pt,Pt)|0,u=u+Math.imul(pt,Ut)|0,u=u+Math.imul(mt,Pt)|0,v=v+Math.imul(mt,Ut)|0,w=w+Math.imul(ct,Ct)|0,u=u+Math.imul(ct,qt)|0,u=u+Math.imul(ot,Ct)|0,v=v+Math.imul(ot,qt)|0;var Pn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Pn>>>26)|0,Pn&=67108863,w=Math.imul(b,Mt),u=Math.imul(b,_t),u=u+Math.imul(I,Mt)|0,v=Math.imul(I,_t),w=w+Math.imul(m,Bt)|0,u=u+Math.imul(m,kt)|0,u=u+Math.imul(a,Bt)|0,v=v+Math.imul(a,kt)|0,w=w+Math.imul(wt,At)|0,u=u+Math.imul(wt,It)|0,u=u+Math.imul(at,At)|0,v=v+Math.imul(at,It)|0,w=w+Math.imul(ft,St)|0,u=u+Math.imul(ft,Tt)|0,u=u+Math.imul(nt,St)|0,v=v+Math.imul(nt,Tt)|0,w=w+Math.imul(gt,Pt)|0,u=u+Math.imul(gt,Ut)|0,u=u+Math.imul(yt,Pt)|0,v=v+Math.imul(yt,Ut)|0,w=w+Math.imul(pt,Ct)|0,u=u+Math.imul(pt,qt)|0,u=u+Math.imul(mt,Ct)|0,v=v+Math.imul(mt,qt)|0;var Un=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Un>>>26)|0,Un&=67108863,w=Math.imul(b,Bt),u=Math.imul(b,kt),u=u+Math.imul(I,Bt)|0,v=Math.imul(I,kt),w=w+Math.imul(m,At)|0,u=u+Math.imul(m,It)|0,u=u+Math.imul(a,At)|0,v=v+Math.imul(a,It)|0,w=w+Math.imul(wt,St)|0,u=u+Math.imul(wt,Tt)|0,u=u+Math.imul(at,St)|0,v=v+Math.imul(at,Tt)|0,w=w+Math.imul(ft,Pt)|0,u=u+Math.imul(ft,Ut)|0,u=u+Math.imul(nt,Pt)|0,v=v+Math.imul(nt,Ut)|0,w=w+Math.imul(gt,Ct)|0,u=u+Math.imul(gt,qt)|0,u=u+Math.imul(yt,Ct)|0,v=v+Math.imul(yt,qt)|0;var Cn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Cn>>>26)|0,Cn&=67108863,w=Math.imul(b,At),u=Math.imul(b,It),u=u+Math.imul(I,At)|0,v=Math.imul(I,It),w=w+Math.imul(m,St)|0,u=u+Math.imul(m,Tt)|0,u=u+Math.imul(a,St)|0,v=v+Math.imul(a,Tt)|0,w=w+Math.imul(wt,Pt)|0,u=u+Math.imul(wt,Ut)|0,u=u+Math.imul(at,Pt)|0,v=v+Math.imul(at,Ut)|0,w=w+Math.imul(ft,Ct)|0,u=u+Math.imul(ft,qt)|0,u=u+Math.imul(nt,Ct)|0,v=v+Math.imul(nt,qt)|0;var qn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(qn>>>26)|0,qn&=67108863,w=Math.imul(b,St),u=Math.imul(b,Tt),u=u+Math.imul(I,St)|0,v=Math.imul(I,Tt),w=w+Math.imul(m,Pt)|0,u=u+Math.imul(m,Ut)|0,u=u+Math.imul(a,Pt)|0,v=v+Math.imul(a,Ut)|0,w=w+Math.imul(wt,Ct)|0,u=u+Math.imul(wt,qt)|0,u=u+Math.imul(at,Ct)|0,v=v+Math.imul(at,qt)|0;var Fn=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(Fn>>>26)|0,Fn&=67108863,w=Math.imul(b,Pt),u=Math.imul(b,Ut),u=u+Math.imul(I,Pt)|0,v=Math.imul(I,Ut),w=w+Math.imul(m,Ct)|0,u=u+Math.imul(m,qt)|0,u=u+Math.imul(a,Ct)|0,v=v+Math.imul(a,qt)|0;var On=(k+w|0)+((u&8191)<<13)|0;k=(v+(u>>>13)|0)+(On>>>26)|0,On&=67108863,w=Math.imul(b,Ct),u=Math.imul(b,qt),u=u+Math.imul(I,Ct)|0,v=Math.imul(I,qt);var Nn=(k+w|0)+((u&8191)<<13)|0;return k=(v+(u>>>13)|0)+(Nn>>>26)|0,Nn&=67108863,x[0]=vn,x[1]=bn,x[2]=xn,x[3]=En,x[4]=Mn,x[5]=_n,x[6]=Bn,x[7]=kn,x[8]=An,x[9]=In,x[10]=Sn,x[11]=Tn,x[12]=Pn,x[13]=Un,x[14]=Cn,x[15]=qn,x[16]=Fn,x[17]=On,x[18]=Nn,k!==0&&(x[19]=k,d.length++),d};Math.imul||(T=P);function C(E,s,h){h.negative=s.negative^E.negative,h.length=E.length+s.length;for(var d=0,p=0,g=0;g<h.length-1;g++){var x=p;p=0;for(var k=d&67108863,w=Math.min(g,s.length-1),u=Math.max(0,g-E.length+1);u<=w;u++){var v=g-u,F=E.words[v]|0,H=s.words[u]|0,W=F*H,Z=W&67108863;x=x+(W/67108864|0)|0,Z=Z+k|0,k=Z&67108863,x=x+(Z>>>26)|0,p+=x>>>26,x&=67108863}h.words[g]=k,d=x,x=p}return d!==0?h.words[g]=d:h.length--,h.strip()}function N(E,s,h){var d=new K;return d.mulp(E,s,h)}o.prototype.mulTo=function(s,h){var d,p=this.length+s.length;return this.length===10&&s.length===10?d=T(this,s,h):p<63?d=P(this,s,h):p<1024?d=C(this,s,h):d=N(this,s,h),d};function K(E,s){this.x=E,this.y=s}K.prototype.makeRBT=function(s){for(var h=new Array(s),d=o.prototype._countBits(s)-1,p=0;p<s;p++)h[p]=this.revBin(p,d,s);return h},K.prototype.revBin=function(s,h,d){if(s===0||s===d-1)return s;for(var p=0,g=0;g<h;g++)p|=(s&1)<<h-g-1,s>>=1;return p},K.prototype.permute=function(s,h,d,p,g,x){for(var k=0;k<x;k++)p[k]=h[s[k]],g[k]=d[s[k]]},K.prototype.transform=function(s,h,d,p,g,x){this.permute(x,s,h,d,p,g);for(var k=1;k<g;k<<=1)for(var w=k<<1,u=Math.cos(2*Math.PI/w),v=Math.sin(2*Math.PI/w),F=0;F<g;F+=w)for(var H=u,W=v,Z=0;Z<k;Z++){var G=d[F+Z],X=p[F+Z],it=d[F+Z+k],Y=p[F+Z+k],tt=H*it-W*Y;Y=H*Y+W*it,it=tt,d[F+Z]=G+it,p[F+Z]=X+Y,d[F+Z+k]=G-it,p[F+Z+k]=X-Y,Z!==w&&(tt=u*H-v*W,W=u*W+v*H,H=tt)}},K.prototype.guessLen13b=function(s,h){var d=Math.max(h,s)|1,p=d&1,g=0;for(d=d/2|0;d;d=d>>>1)g++;return 1<<g+1+p},K.prototype.conjugate=function(s,h,d){if(!(d<=1))for(var p=0;p<d/2;p++){var g=s[p];s[p]=s[d-p-1],s[d-p-1]=g,g=h[p],h[p]=-h[d-p-1],h[d-p-1]=-g}},K.prototype.normalize13b=function(s,h){for(var d=0,p=0;p<h/2;p++){var g=Math.round(s[2*p+1]/h)*8192+Math.round(s[2*p]/h)+d;s[p]=g&67108863,g<67108864?d=0:d=g/67108864|0}return s},K.prototype.convert13b=function(s,h,d,p){for(var g=0,x=0;x<h;x++)g=g+(s[x]|0),d[2*x]=g&8191,g=g>>>13,d[2*x+1]=g&8191,g=g>>>13;for(x=2*h;x<p;++x)d[x]=0;r(g===0),r((g&-8192)===0)},K.prototype.stub=function(s){for(var h=new Array(s),d=0;d<s;d++)h[d]=0;return h},K.prototype.mulp=function(s,h,d){var p=2*this.guessLen13b(s.length,h.length),g=this.makeRBT(p),x=this.stub(p),k=new Array(p),w=new Array(p),u=new Array(p),v=new Array(p),F=new Array(p),H=new Array(p),W=d.words;W.length=p,this.convert13b(s.words,s.length,k,p),this.convert13b(h.words,h.length,v,p),this.transform(k,x,w,u,p,g),this.transform(v,x,F,H,p,g);for(var Z=0;Z<p;Z++){var G=w[Z]*F[Z]-u[Z]*H[Z];u[Z]=w[Z]*H[Z]+u[Z]*F[Z],w[Z]=G}return this.conjugate(w,u,p),this.transform(w,u,W,x,p,g),this.conjugate(W,x,p),this.normalize13b(W,p),d.negative=s.negative^h.negative,d.length=s.length+h.length,d.strip()},o.prototype.mul=function(s){var h=new o(null);return h.words=new Array(this.length+s.length),this.mulTo(s,h)},o.prototype.mulf=function(s){var h=new o(null);return h.words=new Array(this.length+s.length),N(this,s,h)},o.prototype.imul=function(s){return this.clone().mulTo(s,this)},o.prototype.imuln=function(s){r(typeof s=="number"),r(s<67108864);for(var h=0,d=0;d<this.length;d++){var p=(this.words[d]|0)*s,g=(p&67108863)+(h&67108863);h>>=26,h+=p/67108864|0,h+=g>>>26,this.words[d]=g&67108863}return h!==0&&(this.words[d]=h,this.length++),this.length=s===0?1:this.length,this},o.prototype.muln=function(s){return this.clone().imuln(s)},o.prototype.sqr=function(){return this.mul(this)},o.prototype.isqr=function(){return this.imul(this.clone())},o.prototype.pow=function(s){var h=_(s);if(h.length===0)return new o(1);for(var d=this,p=0;p<h.length&&h[p]===0;p++,d=d.sqr());if(++p<h.length)for(var g=d.sqr();p<h.length;p++,g=g.sqr())h[p]!==0&&(d=d.mul(g));return d},o.prototype.iushln=function(s){r(typeof s=="number"&&s>=0);var h=s%26,d=(s-h)/26,p=67108863>>>26-h<<26-h,g;if(h!==0){var x=0;for(g=0;g<this.length;g++){var k=this.words[g]&p,w=(this.words[g]|0)-k<<h;this.words[g]=w|x,x=k>>>26-h}x&&(this.words[g]=x,this.length++)}if(d!==0){for(g=this.length-1;g>=0;g--)this.words[g+d]=this.words[g];for(g=0;g<d;g++)this.words[g]=0;this.length+=d}return this.strip()},o.prototype.ishln=function(s){return r(this.negative===0),this.iushln(s)},o.prototype.iushrn=function(s,h,d){r(typeof s=="number"&&s>=0);var p;h?p=(h-h%26)/26:p=0;var g=s%26,x=Math.min((s-g)/26,this.length),k=67108863^67108863>>>g<<g,w=d;if(p-=x,p=Math.max(0,p),w){for(var u=0;u<x;u++)w.words[u]=this.words[u];w.length=x}if(x!==0)if(this.length>x)for(this.length-=x,u=0;u<this.length;u++)this.words[u]=this.words[u+x];else this.words[0]=0,this.length=1;var v=0;for(u=this.length-1;u>=0&&(v!==0||u>=p);u--){var F=this.words[u]|0;this.words[u]=v<<26-g|F>>>g,v=F&k}return w&&v!==0&&(w.words[w.length++]=v),this.length===0&&(this.words[0]=0,this.length=1),this.strip()},o.prototype.ishrn=function(s,h,d){return r(this.negative===0),this.iushrn(s,h,d)},o.prototype.shln=function(s){return this.clone().ishln(s)},o.prototype.ushln=function(s){return this.clone().iushln(s)},o.prototype.shrn=function(s){return this.clone().ishrn(s)},o.prototype.ushrn=function(s){return this.clone().iushrn(s)},o.prototype.testn=function(s){r(typeof s=="number"&&s>=0);var h=s%26,d=(s-h)/26,p=1<<h;if(this.length<=d)return!1;var g=this.words[d];return!!(g&p)},o.prototype.imaskn=function(s){r(typeof s=="number"&&s>=0);var h=s%26,d=(s-h)/26;if(r(this.negative===0,"imaskn works only with positive numbers"),this.length<=d)return this;if(h!==0&&d++,this.length=Math.min(d,this.length),h!==0){var p=67108863^67108863>>>h<<h;this.words[this.length-1]&=p}return this.strip()},o.prototype.maskn=function(s){return this.clone().imaskn(s)},o.prototype.iaddn=function(s){return r(typeof s=="number"),r(s<67108864),s<0?this.isubn(-s):this.negative!==0?this.length===1&&(this.words[0]|0)<s?(this.words[0]=s-(this.words[0]|0),this.negative=0,this):(this.negative=0,this.isubn(s),this.negative=1,this):this._iaddn(s)},o.prototype._iaddn=function(s){this.words[0]+=s;for(var h=0;h<this.length&&this.words[h]>=67108864;h++)this.words[h]-=67108864,h===this.length-1?this.words[h+1]=1:this.words[h+1]++;return this.length=Math.max(this.length,h+1),this},o.prototype.isubn=function(s){if(r(typeof s=="number"),r(s<67108864),s<0)return this.iaddn(-s);if(this.negative!==0)return this.negative=0,this.iaddn(s),this.negative=1,this;if(this.words[0]-=s,this.length===1&&this.words[0]<0)this.words[0]=-this.words[0],this.negative=1;else for(var h=0;h<this.length&&this.words[h]<0;h++)this.words[h]+=67108864,this.words[h+1]-=1;return this.strip()},o.prototype.addn=function(s){return this.clone().iaddn(s)},o.prototype.subn=function(s){return this.clone().isubn(s)},o.prototype.iabs=function(){return this.negative=0,this},o.prototype.abs=function(){return this.clone().iabs()},o.prototype._ishlnsubmul=function(s,h,d){var p=s.length+d,g;this._expand(p);var x,k=0;for(g=0;g<s.length;g++){x=(this.words[g+d]|0)+k;var w=(s.words[g]|0)*h;x-=w&67108863,k=(x>>26)-(w/67108864|0),this.words[g+d]=x&67108863}for(;g<this.length-d;g++)x=(this.words[g+d]|0)+k,k=x>>26,this.words[g+d]=x&67108863;if(k===0)return this.strip();for(r(k===-1),k=0,g=0;g<this.length;g++)x=-(this.words[g]|0)+k,k=x>>26,this.words[g]=x&67108863;return this.negative=1,this.strip()},o.prototype._wordDiv=function(s,h){var d=this.length-s.length,p=this.clone(),g=s,x=g.words[g.length-1]|0,k=this._countBits(x);d=26-k,d!==0&&(g=g.ushln(d),p.iushln(d),x=g.words[g.length-1]|0);var w=p.length-g.length,u;if(h!=="mod"){u=new o(null),u.length=w+1,u.words=new Array(u.length);for(var v=0;v<u.length;v++)u.words[v]=0}var F=p.clone()._ishlnsubmul(g,1,w);F.negative===0&&(p=F,u&&(u.words[w]=1));for(var H=w-1;H>=0;H--){var W=(p.words[g.length+H]|0)*67108864+(p.words[g.length+H-1]|0);for(W=Math.min(W/x|0,67108863),p._ishlnsubmul(g,W,H);p.negative!==0;)W--,p.negative=0,p._ishlnsubmul(g,1,H),p.isZero()||(p.negative^=1);u&&(u.words[H]=W)}return u&&u.strip(),p.strip(),h!=="div"&&d!==0&&p.iushrn(d),{div:u||null,mod:p}},o.prototype.divmod=function(s,h,d){if(r(!s.isZero()),this.isZero())return{div:new o(0),mod:new o(0)};var p,g,x;return this.negative!==0&&s.negative===0?(x=this.neg().divmod(s,h),h!=="mod"&&(p=x.div.neg()),h!=="div"&&(g=x.mod.neg(),d&&g.negative!==0&&g.iadd(s)),{div:p,mod:g}):this.negative===0&&s.negative!==0?(x=this.divmod(s.neg(),h),h!=="mod"&&(p=x.div.neg()),{div:p,mod:x.mod}):(this.negative&s.negative)!==0?(x=this.neg().divmod(s.neg(),h),h!=="div"&&(g=x.mod.neg(),d&&g.negative!==0&&g.isub(s)),{div:x.div,mod:g}):s.length>this.length||this.cmp(s)<0?{div:new o(0),mod:this}:s.length===1?h==="div"?{div:this.divn(s.words[0]),mod:null}:h==="mod"?{div:null,mod:new o(this.modn(s.words[0]))}:{div:this.divn(s.words[0]),mod:new o(this.modn(s.words[0]))}:this._wordDiv(s,h)},o.prototype.div=function(s){return this.divmod(s,"div",!1).div},o.prototype.mod=function(s){return this.divmod(s,"mod",!1).mod},o.prototype.umod=function(s){return this.divmod(s,"mod",!0).mod},o.prototype.divRound=function(s){var h=this.divmod(s);if(h.mod.isZero())return h.div;var d=h.div.negative!==0?h.mod.isub(s):h.mod,p=s.ushrn(1),g=s.andln(1),x=d.cmp(p);return x<0||g===1&&x===0?h.div:h.div.negative!==0?h.div.isubn(1):h.div.iaddn(1)},o.prototype.modn=function(s){r(s<=67108863);for(var h=(1<<26)%s,d=0,p=this.length-1;p>=0;p--)d=(h*d+(this.words[p]|0))%s;return d},o.prototype.idivn=function(s){r(s<=67108863);for(var h=0,d=this.length-1;d>=0;d--){var p=(this.words[d]|0)+h*67108864;this.words[d]=p/s|0,h=p%s}return this.strip()},o.prototype.divn=function(s){return this.clone().idivn(s)},o.prototype.egcd=function(s){r(s.negative===0),r(!s.isZero());var h=this,d=s.clone();h.negative!==0?h=h.umod(s):h=h.clone();for(var p=new o(1),g=new o(0),x=new o(0),k=new o(1),w=0;h.isEven()&&d.isEven();)h.iushrn(1),d.iushrn(1),++w;for(var u=d.clone(),v=h.clone();!h.isZero();){for(var F=0,H=1;(h.words[0]&H)===0&&F<26;++F,H<<=1);if(F>0)for(h.iushrn(F);F-- >0;)(p.isOdd()||g.isOdd())&&(p.iadd(u),g.isub(v)),p.iushrn(1),g.iushrn(1);for(var W=0,Z=1;(d.words[0]&Z)===0&&W<26;++W,Z<<=1);if(W>0)for(d.iushrn(W);W-- >0;)(x.isOdd()||k.isOdd())&&(x.iadd(u),k.isub(v)),x.iushrn(1),k.iushrn(1);h.cmp(d)>=0?(h.isub(d),p.isub(x),g.isub(k)):(d.isub(h),x.isub(p),k.isub(g))}return{a:x,b:k,gcd:d.iushln(w)}},o.prototype._invmp=function(s){r(s.negative===0),r(!s.isZero());var h=this,d=s.clone();h.negative!==0?h=h.umod(s):h=h.clone();for(var p=new o(1),g=new o(0),x=d.clone();h.cmpn(1)>0&&d.cmpn(1)>0;){for(var k=0,w=1;(h.words[0]&w)===0&&k<26;++k,w<<=1);if(k>0)for(h.iushrn(k);k-- >0;)p.isOdd()&&p.iadd(x),p.iushrn(1);for(var u=0,v=1;(d.words[0]&v)===0&&u<26;++u,v<<=1);if(u>0)for(d.iushrn(u);u-- >0;)g.isOdd()&&g.iadd(x),g.iushrn(1);h.cmp(d)>=0?(h.isub(d),p.isub(g)):(d.isub(h),g.isub(p))}var F;return h.cmpn(1)===0?F=p:F=g,F.cmpn(0)<0&&F.iadd(s),F},o.prototype.gcd=function(s){if(this.isZero())return s.abs();if(s.isZero())return this.abs();var h=this.clone(),d=s.clone();h.negative=0,d.negative=0;for(var p=0;h.isEven()&&d.isEven();p++)h.iushrn(1),d.iushrn(1);do{for(;h.isEven();)h.iushrn(1);for(;d.isEven();)d.iushrn(1);var g=h.cmp(d);if(g<0){var x=h;h=d,d=x}else if(g===0||d.cmpn(1)===0)break;h.isub(d)}while(!0);return d.iushln(p)},o.prototype.invm=function(s){return this.egcd(s).a.umod(s)},o.prototype.isEven=function(){return(this.words[0]&1)===0},o.prototype.isOdd=function(){return(this.words[0]&1)===1},o.prototype.andln=function(s){return this.words[0]&s},o.prototype.bincn=function(s){r(typeof s=="number");var h=s%26,d=(s-h)/26,p=1<<h;if(this.length<=d)return this._expand(d+1),this.words[d]|=p,this;for(var g=p,x=d;g!==0&&x<this.length;x++){var k=this.words[x]|0;k+=g,g=k>>>26,k&=67108863,this.words[x]=k}return g!==0&&(this.words[x]=g,this.length++),this},o.prototype.isZero=function(){return this.length===1&&this.words[0]===0},o.prototype.cmpn=function(s){var h=s<0;if(this.negative!==0&&!h)return-1;if(this.negative===0&&h)return 1;this.strip();var d;if(this.length>1)d=1;else{h&&(s=-s),r(s<=67108863,"Number is too big");var p=this.words[0]|0;d=p===s?0:p<s?-1:1}return this.negative!==0?-d|0:d},o.prototype.cmp=function(s){if(this.negative!==0&&s.negative===0)return-1;if(this.negative===0&&s.negative!==0)return 1;var h=this.ucmp(s);return this.negative!==0?-h|0:h},o.prototype.ucmp=function(s){if(this.length>s.length)return 1;if(this.length<s.length)return-1;for(var h=0,d=this.length-1;d>=0;d--){var p=this.words[d]|0,g=s.words[d]|0;if(p!==g){p<g?h=-1:p>g&&(h=1);break}}return h},o.prototype.gtn=function(s){return this.cmpn(s)===1},o.prototype.gt=function(s){return this.cmp(s)===1},o.prototype.gten=function(s){return this.cmpn(s)>=0},o.prototype.gte=function(s){return this.cmp(s)>=0},o.prototype.ltn=function(s){return this.cmpn(s)===-1},o.prototype.lt=function(s){return this.cmp(s)===-1},o.prototype.lten=function(s){return this.cmpn(s)<=0},o.prototype.lte=function(s){return this.cmp(s)<=0},o.prototype.eqn=function(s){return this.cmpn(s)===0},o.prototype.eq=function(s){return this.cmp(s)===0},o.red=function(s){return new O(s)},o.prototype.toRed=function(s){return r(!this.red,"Already a number in reduction context"),r(this.negative===0,"red works only with positives"),s.convertTo(this)._forceRed(s)},o.prototype.fromRed=function(){return r(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},o.prototype._forceRed=function(s){return this.red=s,this},o.prototype.forceRed=function(s){return r(!this.red,"Already a number in reduction context"),this._forceRed(s)},o.prototype.redAdd=function(s){return r(this.red,"redAdd works only with red numbers"),this.red.add(this,s)},o.prototype.redIAdd=function(s){return r(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,s)},o.prototype.redSub=function(s){return r(this.red,"redSub works only with red numbers"),this.red.sub(this,s)},o.prototype.redISub=function(s){return r(this.red,"redISub works only with red numbers"),this.red.isub(this,s)},o.prototype.redShl=function(s){return r(this.red,"redShl works only with red numbers"),this.red.shl(this,s)},o.prototype.redMul=function(s){return r(this.red,"redMul works only with red numbers"),this.red._verify2(this,s),this.red.mul(this,s)},o.prototype.redIMul=function(s){return r(this.red,"redMul works only with red numbers"),this.red._verify2(this,s),this.red.imul(this,s)},o.prototype.redSqr=function(){return r(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},o.prototype.redISqr=function(){return r(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},o.prototype.redSqrt=function(){return r(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},o.prototype.redInvm=function(){return r(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},o.prototype.redNeg=function(){return r(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},o.prototype.redPow=function(s){return r(this.red&&!s.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,s)};var R={k256:null,p224:null,p192:null,p25519:null};function D(E,s){this.name=E,this.p=new o(s,16),this.n=this.p.bitLength(),this.k=new o(1).iushln(this.n).isub(this.p),this.tmp=this._tmp()}D.prototype._tmp=function(){var s=new o(null);return s.words=new Array(Math.ceil(this.n/13)),s},D.prototype.ireduce=function(s){var h=s,d;do this.split(h,this.tmp),h=this.imulK(h),h=h.iadd(this.tmp),d=h.bitLength();while(d>this.n);var p=d<this.n?-1:h.ucmp(this.p);return p===0?(h.words[0]=0,h.length=1):p>0?h.isub(this.p):h.strip!==void 0?h.strip():h._strip(),h},D.prototype.split=function(s,h){s.iushrn(this.n,0,h)},D.prototype.imulK=function(s){return s.imul(this.k)};function $(){D.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}i($,D),$.prototype.split=function(s,h){for(var d=4194303,p=Math.min(s.length,9),g=0;g<p;g++)h.words[g]=s.words[g];if(h.length=p,s.length<=9){s.words[0]=0,s.length=1;return}var x=s.words[9];for(h.words[h.length++]=x&d,g=10;g<s.length;g++){var k=s.words[g]|0;s.words[g-10]=(k&d)<<4|x>>>22,x=k}x>>>=22,s.words[g-10]=x,x===0&&s.length>10?s.length-=10:s.length-=9},$.prototype.imulK=function(s){s.words[s.length]=0,s.words[s.length+1]=0,s.length+=2;for(var h=0,d=0;d<s.length;d++){var p=s.words[d]|0;h+=p*977,s.words[d]=h&67108863,h=p*64+(h/67108864|0)}return s.words[s.length-1]===0&&(s.length--,s.words[s.length-1]===0&&s.length--),s};function Q(){D.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}i(Q,D);function z(){D.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}i(z,D);function L(){D.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}i(L,D),L.prototype.imulK=function(s){for(var h=0,d=0;d<s.length;d++){var p=(s.words[d]|0)*19+h,g=p&67108863;p>>>=26,s.words[d]=g,h=p}return h!==0&&(s.words[s.length++]=h),s},o._prime=function(s){if(R[s])return R[s];var h;if(s==="k256")h=new $;else if(s==="p224")h=new Q;else if(s==="p192")h=new z;else if(s==="p25519")h=new L;else throw new Error("Unknown prime "+s);return R[s]=h,h};function O(E){if(typeof E=="string"){var s=o._prime(E);this.m=s.p,this.prime=s}else r(E.gtn(1),"modulus must be greater than 1"),this.m=E,this.prime=null}O.prototype._verify1=function(s){r(s.negative===0,"red works only with positives"),r(s.red,"red works only with red numbers")},O.prototype._verify2=function(s,h){r((s.negative|h.negative)===0,"red works only with positives"),r(s.red&&s.red===h.red,"red works only with red numbers")},O.prototype.imod=function(s){return this.prime?this.prime.ireduce(s)._forceRed(this):s.umod(this.m)._forceRed(this)},O.prototype.neg=function(s){return s.isZero()?s.clone():this.m.sub(s)._forceRed(this)},O.prototype.add=function(s,h){this._verify2(s,h);var d=s.add(h);return d.cmp(this.m)>=0&&d.isub(this.m),d._forceRed(this)},O.prototype.iadd=function(s,h){this._verify2(s,h);var d=s.iadd(h);return d.cmp(this.m)>=0&&d.isub(this.m),d},O.prototype.sub=function(s,h){this._verify2(s,h);var d=s.sub(h);return d.cmpn(0)<0&&d.iadd(this.m),d._forceRed(this)},O.prototype.isub=function(s,h){this._verify2(s,h);var d=s.isub(h);return d.cmpn(0)<0&&d.iadd(this.m),d},O.prototype.shl=function(s,h){return this._verify1(s),this.imod(s.ushln(h))},O.prototype.imul=function(s,h){return this._verify2(s,h),this.imod(s.imul(h))},O.prototype.mul=function(s,h){return this._verify2(s,h),this.imod(s.mul(h))},O.prototype.isqr=function(s){return this.imul(s,s.clone())},O.prototype.sqr=function(s){return this.mul(s,s)},O.prototype.sqrt=function(s){if(s.isZero())return s.clone();var h=this.m.andln(3);if(r(h%2===1),h===3){var d=this.m.add(new o(1)).iushrn(2);return this.pow(s,d)}for(var p=this.m.subn(1),g=0;!p.isZero()&&p.andln(1)===0;)g++,p.iushrn(1);r(!p.isZero());var x=new o(1).toRed(this),k=x.redNeg(),w=this.m.subn(1).iushrn(1),u=this.m.bitLength();for(u=new o(2*u*u).toRed(this);this.pow(u,w).cmp(k)!==0;)u.redIAdd(k);for(var v=this.pow(u,p),F=this.pow(s,p.addn(1).iushrn(1)),H=this.pow(s,p),W=g;H.cmp(x)!==0;){for(var Z=H,G=0;Z.cmp(x)!==0;G++)Z=Z.redSqr();r(G<W);var X=this.pow(v,new o(1).iushln(W-G-1));F=F.redMul(X),v=X.redSqr(),H=H.redMul(v),W=G}return F},O.prototype.invm=function(s){var h=s._invmp(this.m);return h.negative!==0?(h.negative=0,this.imod(h).redNeg()):this.imod(h)},O.prototype.pow=function(s,h){if(h.isZero())return new o(1).toRed(this);if(h.cmpn(1)===0)return s.clone();var d=4,p=new Array(1<<d);p[0]=new o(1).toRed(this),p[1]=s;for(var g=2;g<p.length;g++)p[g]=this.mul(p[g-1],s);var x=p[0],k=0,w=0,u=h.bitLength()%26;for(u===0&&(u=26),g=h.length-1;g>=0;g--){for(var v=h.words[g],F=u-1;F>=0;F--){var H=v>>F&1;if(x!==p[0]&&(x=this.sqr(x)),H===0&&k===0){w=0;continue}k<<=1,k|=H,w++,!(w!==d&&(g!==0||F!==0))&&(x=this.mul(x,p[k]),w=0,k=0)}u=26}return x},O.prototype.convertTo=function(s){var h=s.umod(this.m);return h===s?h.clone():h},O.prototype.convertFrom=function(s){var h=s.clone();return h.red=null,h},o.mont=function(s){return new j(s)};function j(E){O.call(this,E),this.shift=this.m.bitLength(),this.shift%26!==0&&(this.shift+=26-this.shift%26),this.r=new o(1).iushln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv=this.minv.umod(this.r),this.minv=this.r.sub(this.minv)}i(j,O),j.prototype.convertTo=function(s){return this.imod(s.ushln(this.shift))},j.prototype.convertFrom=function(s){var h=this.imod(s.mul(this.rinv));return h.red=null,h},j.prototype.imul=function(s,h){if(s.isZero()||h.isZero())return s.words[0]=0,s.length=1,s;var d=s.imul(h),p=d.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),g=d.isub(p).iushrn(this.shift),x=g;return g.cmp(this.m)>=0?x=g.isub(this.m):g.cmpn(0)<0&&(x=g.iadd(this.m)),x._forceRed(this)},j.prototype.mul=function(s,h){if(s.isZero()||h.isZero())return new o(0)._forceRed(this);var d=s.mul(h),p=d.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),g=d.isub(p).iushrn(this.shift),x=g;return g.cmp(this.m)>=0?x=g.isub(this.m):g.cmpn(0)<0&&(x=g.iadd(this.m)),x._forceRed(this)},j.prototype.invm=function(s){var h=this.imod(s._invmp(this.m).mul(this.r2));return h._forceRed(this)}})(n,Bu)})(wr)),wr.exports}for(var Xt=ku(),go={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},yo={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},wo={bech32:"tbs",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},vo={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},bo={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},Ze=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],Au={m:new Xt.BN(1e3,10),u:new Xt.BN(1e6,10),n:new Xt.BN(1e9,10),p:new Xt.BN(1e12,10)},Iu=new Xt.BN("2100000000000000000",10),xo=new Xt.BN(1e11,10),gn={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},Eo={},vr=0,yn=Object.keys(gn);vr<yn.length;vr++){var Su=yn[vr],Tu=gn[yn[vr]].toString();Eo[Tu]=Su}var Pu={1:function(n){return ue(n)},16:function(n){return ue(n)},13:function(n){return ue(n).toString("utf8")},19:function(n){return ue(n)},23:function(n){return ue(n)},27:function(n){return ue(n)},6:br,24:br,3:qu,5:Fu};function Uu(n){return function(t){return{tagCode:parseInt(n),words:co.encode("unknown",t,Number.MAX_SAFE_INTEGER)}}}function br(n){return n.reverse().reduce(function(t,e,r){return t+e*Math.pow(32,r)},0)}function Cu(n,t,e){for(var r=0,i=0,o=(1<<e)-1,l=[],c=0;c<n.length;++c)for(r=r<<t|n[c],i+=t;i>=e;)i-=e,l.push(r>>i&o);return i>0&&l.push(r<<e-i&o),l}function ue(n,t){var e=Mu.Buffer.from(Cu(n,5,8));return n.length*5%8!==0&&(e=e.slice(0,-1)),e}function qu(n){for(var t=[],e,r,i,o,l,c=ue(n);c.length>0;)e=c.slice(0,33).toString("hex"),r=c.slice(33,41).toString("hex"),i=parseInt(c.slice(41,45).toString("hex"),16),o=parseInt(c.slice(45,49).toString("hex"),16),l=parseInt(c.slice(49,51).toString("hex"),16),c=c.slice(51),t.push({pubkey:e,short_channel_id:r,fee_base_msat:i,fee_proportional_millionths:o,cltv_expiry_delta:l});return t}function Fu(n){for(var t=n.slice().reverse().map(function(i){return[!!(i&1),!!(i&2),!!(i&4),!!(i&8),!!(i&16)]}).reduce(function(i,o){return i.concat(o)},[]);t.length<Ze.length*2;)t.push(!1);var e={extra_bits:{}};if(Ze.forEach(function(i,o){var l;t[o*2]?l="required":t[o*2+1]&&(l="supported"),e[i]=l}),t.length>Ze.length*2){var r=t.slice(Ze.length*2);e.extra_bits={start_bit:Ze.length*2,bits:r,required:r.reduce(function(i,o,l){return l%2!==0?i||!1:i||o},!1)}}return e}function Ou(n,t){var e,r;if(n.slice(-1).match(/^[munp]$/))e=n.slice(-1),r=n.slice(0,-1);else{if(n.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");r=n}if(!r.match(/^\d+$/))throw new Error("Not a valid human readable amount");var i=new Xt.BN(r,10),o=e?i.mul(xo).div(Au[e]):i.mul(xo);if(e==="p"&&!i.mod(new Xt.BN(10,10)).eq(new Xt.BN(0,10))||o.gt(Iu))throw new Error("Amount is outside of valid range");return t?o.toString():o}function Nu(n,t){if(typeof n!="string")throw new Error("Lightning Payment Request must be string");if(n.slice(0,2).toLowerCase()!=="ln")throw new Error("Not a proper lightning payment request");var e=[],r=co.decode(n,Number.MAX_SAFE_INTEGER);n=n.toLowerCase();var i=r.prefix,o=r.words,l=n.slice(i.length+1),c=o.slice(-104);o=o.slice(0,-104);var y=i.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(y&&!y[2]&&(y=i.match(/^ln(\S+)$/)),!y)throw new Error("Not a proper lightning payment request");e.push({name:"lightning_network",letters:"ln"});var M=y[1],A;switch(M){case go.bech32:A=go;break;case yo.bech32:A=yo;break;case wo.bech32:A=wo;break;case vo.bech32:A=vo;break;case bo.bech32:A=bo;break}if(!A||A.bech32!==M)throw new Error("Unknown coin bech32 prefix");e.push({name:"coin_network",letters:M,value:A});var S=y[2],B;if(S){var _=y[3];B=Ou(S+_,!0),e.push({name:"amount",letters:y[2]+y[3],value:B})}else B=null;e.push({name:"separator",letters:"1"});var P=br(o.slice(0,7));o=o.slice(7),e.push({name:"timestamp",letters:l.slice(0,7),value:P}),l=l.slice(7);for(var T,C,N,K;o.length>0;){var R=o[0].toString();T=Eo[R]||"unknown_tag",C=Pu[R]||Uu(R),o=o.slice(1),N=br(o.slice(0,2)),o=o.slice(2),K=o.slice(0,N),o=o.slice(N),e.push({name:T,tag:l[0],letters:l.slice(0,3+N),value:C(K)}),l=l.slice(3+N)}e.push({name:"signature",letters:l.slice(0,104),value:ue(c)}),l=l.slice(104),e.push({name:"checksum",letters:l});var D={paymentRequest:n,sections:e,get expiry(){var L=e.find(function(O){return O.name==="expiry"});if(L)return z("timestamp")+L.value},get route_hints(){return e.filter(function(L){return L.name==="route_hint"}).map(function(L){return L.value})}},$=function(L){if(L==="route_hint")return"continue";Object.defineProperty(D,L,{get:function(){return z(L)}})};for(var Q in gn)$(Q);return D;function z(L){var O=e.find(function(j){return j.name===L});return O?O.value:void 0}}let Ce=null,je=[],ge=0,Ve="sat",wn="";const ye=document.getElementById("cashu-token-input"),Mo=document.getElementById("cashu-status");if(ye&&Mo&&window.cashu_wc){const n=l=>{Mo.textContent=l},t=l=>{const y=Nu(l).sections.find(A=>A.name==="amount");if(!y||!y.value)throw new Error("Amount not found in lightning invoice");const M=parseInt(y.value,10);return Math.floor(M/1e3)},e=()=>{if(typeof window?.cashu_wc?.order_id=="number"&&window.cashu_wc.order_id>0)return window.cashu_wc.order_id;const l=new URLSearchParams(window.location.search);return Number(l.get("order-pay")||0)||0},r=async l=>{const c=e();if(!c)throw new Error("No order ID found");const M=await(await fetch(window.cashu_wc.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"cashu_generate_invoice",amount:l.toString(),order_id:c.toString(),nonce:window.cashu_wc.nonce_invoice})})).json();if(!M.success)throw new Error(M.data||"Invoice failed");return M.data.invoice},i=async()=>{const l=e();if(!l)throw new Error("No order ID for confirmation");(await(await fetch(window.cashu_wc.ajax_url,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"cashu_confirm_payment",order_id:l.toString(),nonce:window.cashu_wc.nonce_confirm})})).json()).success?(n("Payment confirmed, order complete."),setTimeout(()=>window.location.reload(),3e3)):n("Payment failed to confirm.")},o=async l=>{try{n("Decoding tokenâ€¦");const c=Ji(l);if(je=c.proofs||[],ge=je.reduce((_,P)=>_+(P.amount||0),0),Ve=c.unit||"sat",wn=c.mint,!je.length||ge<=0)throw new Error("Token contains no spendable proofs");n(`Token value, ${ge} ${Ve}, initialising walletâ€¦`),Ce=new dn(wn),await Ce.loadMint(),n("Requesting lightning invoiceâ€¦");const y=await r(ge);n("Creating melt quoteâ€¦");const M=await Ce.createMeltQuoteBolt11(y);let A=Math.ceil(Math.max(2,ge*.02)),S=ge-A;if(Ve!=="sat"){const _=await Ce.createMintQuoteBolt11(ge),P=t(_.request);A=Math.ceil(Math.max(2,P*.02)),S=P-A}if(S-=Ce.getFeesForProofs(je),S<=0)throw new Error("Token too low once fees are included");n(`Sending ${M.amount} ${Ve} plus fee reserveâ€¦`);const B=await Ce.meltProofsBolt11(M,je);if(!B.quote)throw new Error("Melt failed");if(n("Payment successful."),B.change&&B.change.length>0){n("Preparing change tokenâ€¦");const _=Za({mint:wn,unit:Ve,proofs:B.change});await navigator.clipboard.writeText(_),setTimeout(()=>n("Change token copied to clipboard."),2e3)}await i()}catch(c){const y=c instanceof Error?c.message:String(c);console.error(y),n("Error, "+y)}};ye.addEventListener("paste",l=>{const c=l.clipboardData?.getData("text")||"";if(c.startsWith("cashuB")){l.preventDefault();const y=c.trim();ye.value=y,setTimeout(()=>{o(y)},300)}}),ye.addEventListener("input",()=>{const l=ye.value.trim();l.startsWith("cashuB")&&l.length>100&&n("Token looks valid, press Enter to pay or paste it again.")}),ye.addEventListener("keydown",l=>{if(l.key==="Enter"){l.preventDefault();const c=ye.value.trim();c.startsWith("cashuB")&&o(c)}})}})();
